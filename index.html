<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Club Bornoporichoy — Durga Puja Dashboard</title>

<!-- Firebase compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
  :root{
    --red: #b71c1c;
    --deep-red: #a31313;
    --gold: #fdd835;
    --bg: #fff5f0;
    --text: #4b2e2e;
    --nav-bg-start: #fffaf0;
    --nav-bg-end: #fff2d6;
  }
  *{box-sizing:border-box}
  body {
    font-family: "Segoe UI", Roboto, Arial;
    background: var(--bg);
    color: var(--text);
    margin: 0;
    padding: 0;
    -webkit-font-smoothing:antialiased;
  }

  /* Header / navigation */
  header {
    background: linear-gradient(90deg, var(--nav-bg-start), var(--nav-bg-end));
    color: var(--deep-red);
    padding: 14px 18px;
    text-align: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    position: sticky;
    top: 0;
    z-index: 50;
  }
  header .title {
    font-size: 18px;
    font-weight: 700;
    color: var(--deep-red);
    margin: 0;
  }
  nav.topbar {
    margin-top: 8px;
    display:flex;
    justify-content:center;
    gap:18px;
    padding:8px 12px;
    align-items:center;
  }
  nav.topbar a {
    color: var(--deep-red);
    font-weight:600;
    text-decoration:none;
    padding:6px 10px;
    border-radius:8px;
  }
  nav.topbar a:hover {
    color: #7f0f0f;
    text-decoration:none;
    box-shadow: inset 0 -2px 0 var(--gold);
  }
  nav.topbar a.active {
    color: var(--deep-red);
    background: rgba(183,28,28,0.06);
    box-shadow: 0 2px 6px rgba(183,28,28,0.08);
  }

  .container{max-width:1150px; margin:20px auto; padding:18px;}
  .card{background:#fff; padding:14px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.06); margin-bottom:18px;}
  .flex{display:flex; gap:10px; align-items:center;}
  input[type="text"], input[type="email"], input[type="password"], input[type="number"], select{
    padding:8px; border:1px solid var(--red); border-radius:4px; width:100%;
  }
  button{background:var(--red); color:#fff; border:none; padding:8px 10px; border-radius:6px; cursor:pointer;}
  button:disabled{background:#ccc; cursor:not-allowed;}
  h2{color:var(--red); margin:0 0 8px 0;}
  table{width:100%; border-collapse:collapse; margin-top:10px;}
  th, td{padding:8px; border:1px solid rgba(0,0,0,0.08); text-align:left; vertical-align:middle;}
  th{background:var(--gold); color:var(--text);}
  .summary{font-weight:700; margin-bottom:8px;}
  .muted{color:#666; font-size:0.95em;}
  .editable{background:#fff8e1; cursor:text;}
  .badge-sent{background:green;color:#fff;padding:3px 6px;border-radius:4px;font-size:0.85em}
  .badge-pending{background:orange;color:#fff;padding:3px 6px;border-radius:4px;font-size:0.85em}
  .month-checkbox{margin-right:6px;}
  .small{font-size:0.9em}
  .right{margin-left:auto}
  .center{text-align:center}
  label.small{font-size:0.9em; display:block; margin-bottom:4px;}
  .year-select { display:flex; gap:10px; align-items:center; }
  @media (max-width:900px){
    .flex{flex-direction:column; align-items:stretch;}
    table, thead, tbody, th, td, tr{font-size:13px;}
  }
</style>
</head>
<body>
<header>
  <div class="title">Club Bornoporichoy — Durga Puja Dashboard</div>

  <nav class="topbar" role="navigation" aria-label="Main navigation">
    <a href="#invitations" id="nav-invitations" class="active">Manage Invitations</a>
    <a href="#members" id="nav-members">Members</a>
    <a href="#collectors" id="nav-collectors">Donation Collectors</a>
    <a href="#fees" id="nav-fees">Membership Fees</a>
  </nav>
</header>

<div class="container">

  <!-- Auth Card + Fees-year selector -->
  <div class="card" id="auth-card">
    <div class="flex" style="align-items:flex-end;">
      <div style="min-width:260px; flex:1;">
        <label class="small">Email</label>
        <input id="email" type="email" placeholder="admin@club.com" />
      </div>
      <div style="min-width:220px; flex:1;">
        <label class="small">Password</label>
        <input id="password" type="password" placeholder="password" />
      </div>

      <!-- Fees-year selector (for membership fees only) -->
      <div style="min-width:200px;">
        <label class="small">Fees Year</label>
        <select id="feeYearSelectSmall"></select>
      </div>

      <div style="min-width:180px;">
        <div style="display:flex;gap:8px;align-items:center;">
          <button id="login-btn">Login</button>
          <button id="logout-btn" class="hidden">Logout</button>
        </div>
        <div id="user-info" class="muted small" style="margin-top:8px;"></div>
      </div>
    </div>
  </div>

  <!-- Page content (hidden until login) -->
  <div id="main-content" class="hidden">

    <!-- Top summaries -->
    <div class="card">
      <div class="flex">
        <div>
          <div class="summary" id="summary-invitees">Invitees: —</div>
          <div class="muted">Invitation list summary</div>
        </div>
        <div>
          <div class="summary" id="summary-members">Members: —</div>
          <div class="muted">Members & membership collection</div>
        </div>
        <div class="right">
          <div id="summary-collection" class="summary">Total Collected: ₹0</div>
          <div class="muted">Membership collection overall</div>
        </div>
      </div>
    </div>

    <!-- Invitations -->
    <div class="card" id="invitations">
      <h2>Invitation List</h2>
      <div class="flex">
        <input id="search-invite" type="text" placeholder="Search invitations (name / village / mobile)..." style="flex:1" />
        <div class="right muted small">Admin can add/edit/delete</div>
      </div>

      <table id="invitation-table">
        <thead>
          <tr>
            <th>Name</th><th>Village</th><th>Mobile</th><th>Remarks</th><th>Sent</th><th>Date Added</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div style="margin-top:10px" id="invitation-form">
        <div class="flex">
          <input id="inv-name" type="text" placeholder="Name" />
          <input id="inv-village" type="text" placeholder="Village" />
          <input id="inv-mobile" type="text" placeholder="Mobile No" />
          <input id="inv-remarks" type="text" placeholder="Remarks" />
          <button id="add-inv-btn">Add Invitation</button>
        </div>
      </div>
    </div>

    <!-- Members -->
    <div class="card" id="members">
      <h2>Members List</h2>
      <div style="margin-top:12px" class="flex">
        <input id="search-members" type="text" placeholder="Search members (name/mobile)..." style="flex:1" />
        <div class="right muted small">Admin can add/edit/delete</div>
      </div>

      <table id="members-table">
        <thead>
          <tr>
            <th>Name</th><th>Village</th><th>Mobile</th><th>Remarks</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div style="margin-top:10px" id="member-form">
        <div class="flex">
          <input id="mem-name" type="text" placeholder="Name" />
          <input id="mem-village" type="text" placeholder="Village" />
          <input id="mem-mobile" type="text" placeholder="Mobile No" />
          <input id="mem-remarks" type="text" placeholder="Remarks" />
          <button id="add-mem-btn">Add Member</button>
        </div>
      </div>
    </div>

    <!-- Membership Fees (NEW) -->
    <div class="card" id="fees">
      <h2>Membership Fees Tracker (per Year)</h2>

      <div class="flex" style="align-items:center; gap:12px;">
        <div style="min-width:180px;">
          <label class="small">Fees Year</label><br>
          <select id="feeYearSelectSmall2"></select>
        </div>

        <div style="min-width:260px;">
          <label class="small">Select Member</label><br>
          <select id="feeMemberSelect" style="min-width:220px;">
            <option value="">-- Select member --</option>
          </select>
        </div>

        <div style="min-width:140px;">
          <label class="small">Monthly Fee (₹)</label><br>
          <input id="feeAmountInput" type="number" min="1" value="100" />
        </div>

        <div class="right">
          <button id="loadMemberFeeBtn">Load Member Fee</button>
        </div>
      </div>

      <div style="margin-top:12px;">
        <table id="fee-months-table">
          <thead>
            <tr><th>Month</th><th>Status</th><th>Paid On</th><th>Toggle (Admin)</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div style="margin-top:8px;" class="flex">
        <div id="fee-member-summary" class="muted"></div>
        <div class="right">
          <button id="saveFeeConfigBtn">Save Fee Config</button>
          <button id="clearFeeRecordBtn">Clear Member Fees</button>
        </div>
      </div>

      <div style="margin-top:12px;">
        <h3 class="small">Yearly Fees Summary (selected year)</h3>
        <table id="fees-yearly-summary">
          <thead><tr><th>Month</th><th>Paid Members</th><th>Total Collected (₹)</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Collectors -->
    <div class="card" id="collectors">
      <h2>Donation Collectors</h2>
      <div class="flex">
        <input id="search-collectors" type="text" placeholder="Search collectors..." style="flex:1" />
        <div class="right muted small">Area assignment for collectors</div>
      </div>

      <table id="collector-table">
        <thead><tr><th>Name</th><th>Assigned Area</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>

      <div style="margin-top:10px" id="collector-form">
        <div class="flex">
          <input id="col-name" type="text" placeholder="Name" />
          <input id="col-area" type="text" placeholder="Assigned Area (comma separated areas)" />
          <button id="add-col-btn">Add Collector</button>
        </div>
      </div>
    </div>

  </div> <!-- main-content -->
</div> <!-- container -->

<script>
/* ---------------- Firebase config (hardcoded) ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyCuVs6jx7HiNIx25lzLgoq1B6nQqaHLHm0",
  authDomain: "guestandcollection.firebaseapp.com",
  projectId: "guestandcollection",
  storageBucket: "guestandcollection.firebasestorage.app",
  messagingSenderId: "272278233160",
  appId: "1:272278233160:web:d6d1e6a7d58be260d9b87d",
  measurementId: "G-B5783XTFSP"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ---------------- Roles & constants ---------------- */
const ROLES = {
  "fRpLuiBgU0ZE1AtVmkGaA1RhBJk2": "admin",
  "898Fi5sPKHY01GUgI4iu1xS4TBR2": "viewer"
};
let currentRole = "viewer";
const MONTHS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

/* ---------------- collections (static) ---------------- */
const invitationCol = db.collection("invitations");
const membersCol = db.collection("members");
const collectorsCol = db.collection("collectors");
/* membership_fees collections are flat per year: membership_fees_2025, membership_fees_2026, ... */
function membershipFeesCollectionFor(year){
  return db.collection(`membership_fees_${year}`);
}

/* ---------------- fee-year dropdowns (2025-2050) ---------------- */
const feeYearSelectSmall = document.getElementById('feeYearSelectSmall2');
const currentYear = new Date().getFullYear();
for(let y=2025;y<=2050;y++){
  const o=document.createElement('option'); o.value=y; o.textContent=y;
  if(y===currentYear) o.selected=true;
  feeYearSelectSmall.appendChild(o);
}
let selectedFeeYear = parseInt(feeYearSelectSmall.value);
feeYearSelectSmall.addEventListener('change', ()=> {
  selectedFeeYear = parseInt(feeYearSelectSmall.value);
  loadFeeMembersDropdown();
  loadFeeMonthsTable();
  loadFeeYearlySummary();
});

/* ---------------- UI elements ---------------- */
const loginBtn = document.getElementById("login-btn");
const logoutBtn = document.getElementById("logout-btn");
const userInfo = document.getElementById("user-info");
const mainContent = document.getElementById("main-content");

/* ---------------- Auth handlers ---------------- */
loginBtn.addEventListener("click", () => {
  const email = document.getElementById("email").value.trim();
  const pw = document.getElementById("password").value;
  if(!email || !pw) return alert("Enter email and password");
  loginBtn.disabled = true;
  auth.signInWithEmailAndPassword(email,pw)
    .catch(e => alert("Login error: "+e.message))
    .finally(()=> loginBtn.disabled=false);
});
logoutBtn.addEventListener("click", () => {
  logoutBtn.disabled = true;
  auth.signOut().catch(e => alert("Logout error: "+e.message)).finally(()=> logoutBtn.disabled=false);
});

/* auth state listener */
auth.onAuthStateChanged(user => {
  if(user){
    currentRole = ROLES[user.uid] || "viewer";
    document.getElementById("email").style.display="none";
    document.getElementById("password").style.display="none";
    loginBtn.style.display="none";
    logoutBtn.classList.remove("hidden");
    mainContent.classList.remove("hidden");
    userInfo.textContent = `${user.email} (${currentRole})`;
    applyRoleToUI();
    setTimeout(()=>{ loadAllData(); loadFeeMembersDropdown(); loadFeeYearlySummary(); }, 80);
  } else {
    document.getElementById("email").style.display="";
    document.getElementById("password").style.display="";
    loginBtn.style.display="";
    logoutBtn.classList.add("hidden");
    mainContent.classList.add("hidden");
    userInfo.textContent = "";
    clearAllTables();
  }
});

/* ui role enforcement */
function applyRoleToUI(){
  ["add-inv-btn","add-mem-btn","add-col-btn","loadMemberFeeBtn","saveFeeConfigBtn","clearFeeRecordBtn"].forEach(id=>{
    const el=document.getElementById(id); if(el) el.disabled = (currentRole !== "admin");
  });
}

/* helpers */
function escapeHtml(s){ return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
function filterTable(tableId, term){
  const rows=document.getElementById(tableId).querySelectorAll("tbody tr");
  const q=(term||"").toLowerCase();
  rows.forEach(r=> r.style.display = r.innerText.toLowerCase().includes(q) ? "" : "none");
}
function clearAllTables(){
  ["invitation-table","members-table","collector-table","monthly-summary-table","fee-months-table","fees-yearly-summary"].forEach(id=>{
    const tb=document.getElementById(id)?.querySelector("tbody");
    if(tb) tb.innerHTML="";
  });
  document.getElementById("summary-invitees").textContent="Invitees: —";
  document.getElementById("summary-members").textContent="Members: —";
  document.getElementById("summary-collection").textContent="Total Collected: ₹0";
}

/* ---------------- Load all static data ---------------- */
function loadAllData(){
  loadInvitations();
  loadMembers();
  loadCollectors();
  updateMonthlySummary();
}

/* ---------------- Invitations ---------------- */
document.getElementById("add-inv-btn").addEventListener("click", async ()=>{
  if(currentRole!=="admin") return alert("Only admin can add");
  const name=document.getElementById("inv-name").value.trim();
  const village=document.getElementById("inv-village").value.trim();
  const mobile=document.getElementById("inv-mobile").value.trim();
  const remarks=document.getElementById("inv-remarks").value.trim();
  if(!name||!village) return alert("Name & Village required");
  try{
    let q=invitationCol.where("name","==",name);
    if(mobile) q=q.where("mobile","==",mobile);
    const dup=await q.get();
    if(!dup.empty && !confirm("Possible duplicate. Add anyway?")) return;
    await invitationCol.add({name,village,mobile,remarks,sent:false,dateAdded:firebase.firestore.FieldValue.serverTimestamp()});
    ["inv-name","inv-village","inv-mobile","inv-remarks"].forEach(id=>document.getElementById(id).value="");
    loadInvitations();
  }catch(e){ console.error(e); alert("Add invitation failed: "+(e.message||e)); }
});

async function loadInvitations(){
  const tbody=document.querySelector("#invitation-table tbody"); tbody.innerHTML="";
  try{
    const snap=await invitationCol.orderBy("dateAdded","desc").get();
    let total=0, sent=0;
    snap.forEach(doc=>{
      total++; const d=doc.data(); if(d.sent) sent++;
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td contenteditable="${currentRole==='admin'}" class="${currentRole==='admin'?'editable':''}">${escapeHtml(d.name||"")}</td>
        <td contenteditable="${currentRole==='admin'}" class="${currentRole==='admin'?'editable':''}">${escapeHtml(d.village||"")}</td>
        <td contenteditable="${currentRole==='admin'}" class="${currentRole==='admin'?'editable':''}">${escapeHtml(d.mobile||"")}</td>
        <td contenteditable="${currentRole==='admin'}" class="${currentRole==='admin'?'editable':''}">${escapeHtml(d.remarks||"")}</td>
        <td class="center">${d.sent?'<span class="badge-sent">Sent</span>':'<span class="badge-pending">Pending</span>'}</td>
        <td>${d.dateAdded && d.dateAdded.toDate ? d.dateAdded.toDate().toLocaleString() : ""}</td>
        <td></td>
      `;
      tbody.appendChild(tr);

      const actionsTd=tr.querySelector("td:last-child");
      if(currentRole==="admin"){
        const toggle=document.createElement("button"); toggle.textContent=d.sent?"Mark Pending":"Mark Sent";
        toggle.onclick=()=>doc.ref.update({sent:!d.sent}).then(loadInvitations).catch(err=>alert(err.message));
        actionsTd.appendChild(toggle);

        const del=document.createElement("button"); del.style.marginLeft="8px"; del.textContent="Delete";
        del.onclick=()=>{ if(confirm("Delete invitation?")) doc.ref.delete().then(loadInvitations); };
        actionsTd.appendChild(del);

        const editable=tr.querySelectorAll("td[contenteditable='true']");
        editable.forEach((cell,idx)=>{
          const map=["name","village","mobile","remarks"];
          cell.onblur=async ()=>{
            try{ const val=cell.textContent.trim(); const upd={}; upd[map[idx]]=val; await doc.ref.update(upd); }catch(e){console.error(e); alert("Save failed: "+(e.message||e));}
          };
        });
      }
    });
    document.getElementById("summary-invitees").textContent=`Invitees: ${total} | Sent: ${sent} | Pending: ${total-sent}`;
  }catch(e){ console.error(e); alert("Load invitations failed: "+(e.message||e)); }
}
document.getElementById("search-invite").addEventListener("input",(e)=> filterTable("invitation-table", e.target.value));

/* ---------------- Members ---------------- */
document.getElementById("add-mem-btn").addEventListener("click", async ()=>{
  if(currentRole!=="admin") return alert("Only admin can add members");
  const name=document.getElementById("mem-name").value.trim();
  const village=document.getElementById("mem-village").value.trim();
  const mobile=document.getElementById("mem-mobile").value.trim();
  const remarks=document.getElementById("mem-remarks").value.trim();
  if(!name||!mobile) return alert("Name & Mobile required");
  try{
    const dup=await membersCol.where("name","==",name).where("mobile","==",mobile).get();
    if(!dup.empty && !confirm("Possible duplicate member. Add anyway?")) return;
    await membersCol.add({name,village,mobile,remarks,dateAdded:firebase.firestore.FieldValue.serverTimestamp()});
    ["mem-name","mem-village","mem-mobile","mem-remarks"].forEach(id=>document.getElementById(id).value="");
    loadMembers(); loadFeeMembersDropdown();
  }catch(e){ console.error(e); alert("Add member failed: "+(e.message||e)); }
});

async function loadMembers(){
  const tbody=document.querySelector("#members-table tbody"); tbody.innerHTML="";
  try{
    const snap=await membersCol.orderBy("name").get();
    let total=0;
    snap.forEach(docSnap=>{
      total++; const d=docSnap.data();
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td contenteditable="${currentRole==='admin'}" class="${currentRole==='admin'?'editable':''}">${escapeHtml(d.name||"")}</td>
        <td contenteditable="${currentRole==='admin'}" class="${currentRole==='admin'?'editable':''}">${escapeHtml(d.village||"")}</td>
        <td contenteditable="${currentRole==='admin'}" class="${currentRole==='admin'?'editable':''}">${escapeHtml(d.mobile||"")}</td>
        <td contenteditable="${currentRole==='admin'}" class="${currentRole==='admin'?'editable':''}">${escapeHtml(d.remarks||"")}</td>
        <td></td>
      `;
      tbody.appendChild(tr);

      const actionsTd=tr.querySelector("td:last-child");
      if(currentRole==="admin"){
        const del=document.createElement("button"); del.textContent="Delete";
        del.onclick=()=>{ if(confirm("Delete member?")) docSnap.ref.delete().then(()=>{ loadMembers(); loadFeeMembersDropdown(); }); };
        actionsTd.appendChild(del);

        const editable=tr.querySelectorAll("td[contenteditable='true']");
        editable.forEach((cell,idx)=>{
          const map=["name","village","mobile","remarks"];
          cell.onblur = async ()=> {
            try{ const val=cell.textContent.trim(); const upd={}; upd[map[idx]]=val; await membersCol.doc(docSnap.id).update(upd); loadFeeMembersDropdown(); }catch(e){console.error(e); alert("Save failed: "+(e.message||e)); }
          };
        });
      }
    });
    document.getElementById("summary-members").textContent=`Members: ${total}`;
  }catch(e){ console.error(e); alert("Load members failed: "+(e.message||e)); }
}
document.getElementById("search-members").addEventListener("input",(e)=> filterTable("members-table", e.target.value));

/* ---------------- Collectors ---------------- */
document.getElementById("add-col-btn").addEventListener("click", async ()=>{
  if(currentRole!=="admin") return alert("Only admin can add");
  const name=document.getElementById("col-name").value.trim();
  const area=document.getElementById("col-area").value.trim();
  if(!name||!area) return alert("Name & area required");
  try{
    const dup=await collectorsCol.where("name","==",name).where("area","==",area).get();
    if(!dup.empty && !confirm("Possible duplicate. Add anyway?")) return;
    await collectorsCol.add({name,area,dateAdded:firebase.firestore.FieldValue.serverTimestamp()});
    ["col-name","col-area"].forEach(id=>document.getElementById(id).value="");
    loadCollectors();
  }catch(e){ console.error(e); alert("Add collector failed: "+(e.message||e)); }
});
async function loadCollectors(){
  const tbody=document.querySelector("#collector-table tbody"); tbody.innerHTML="";
  try{
    const snap=await collectorsCol.orderBy("name").get();
    snap.forEach(docSnap=>{
      const d=docSnap.data();
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${escapeHtml(d.name||"")}</td><td>${escapeHtml(d.area||"")}</td><td></td>`;
      tbody.appendChild(tr);
      if(currentRole==="admin"){
        const del=document.createElement("button"); del.textContent="Delete";
        del.onclick=()=>{ if(confirm("Delete collector?")) docSnap.ref.delete().then(loadCollectors); };
        tr.querySelector("td:last-child").appendChild(del);
      }
    });
  }catch(e){ console.error(e); alert("Load collectors failed: "+(e.message||e)); }
}
document.getElementById("search-collectors").addEventListener("input",(e)=> filterTable("collector-table", e.target.value));

/* ---------------- Monthly summary (members fees recorded inside members.fees if used) ---------------- */
async function updateMonthlySummary(){
  const tbody = document.querySelector("#monthly-summary-table tbody"); if(!tbody) return;
  tbody.innerHTML = "";
  try{
    const monthData = {}; MONTHS.forEach(m=> monthData[m] = { paid:0, total:0 });
    const snapshot = await membersCol.get();
    snapshot.forEach(docSnap=>{
      const d = docSnap.data();
      MONTHS.forEach(m => {
        if(d.fees && d.fees[m]){ monthData[m].paid++; monthData[m].total += (d.monthlyFee||100); }
      });
    });
    MONTHS.forEach(m=> {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${m}</td><td class="center">${monthData[m].paid}</td><td class="center">₹${monthData[m].total}</td>`;
      tbody.appendChild(tr);
    });
  }catch(e){ console.error(e); }
}

/* ---------------- Membership Fees (flat per-year collections) ---------------- */

/* fee members dropdown */
const feeMemberSelect = document.getElementById('feeMemberSelect');
async function loadFeeMembersDropdown(){
  feeMemberSelect.innerHTML = '<option value="">-- Select member --</option>';
  try{
    const snap = await membersCol.orderBy("name").get();
    snap.forEach(docSnap=>{
      const d = docSnap.data();
      const opt = document.createElement('option');
      opt.value = docSnap.id;
      opt.textContent = `${d.name} — ${d.mobile||''}`;
      feeMemberSelect.appendChild(opt);
    });
  }catch(e){ console.error("Load fee members failed:", e); }
}

/* load member fee months */
document.getElementById("loadMemberFeeBtn").addEventListener("click", loadFeeMonthsTable);
async function loadFeeMonthsTable(){
  const memberId = feeMemberSelect.value;
  const feeAmount = Number(document.getElementById("feeAmountInput").value) || 100;
  const tbody = document.querySelector("#fee-months-table tbody");
  tbody.innerHTML = "";
  if(!memberId){ document.getElementById("fee-member-summary").textContent = "Select a member"; return; }

  try{
    const feesCol = membershipFeesCollectionFor(selectedFeeYear);
    const docRef = feesCol.doc(memberId);
    const docSnap = await docRef.get();
    let record = docSnap.exists ? docSnap.data() : null;
    if(!record){
      const monthsInit = {}; MONTHS.forEach(m=> monthsInit[m] = { paid:false, paidAt:null });
      record = { memberId, months: monthsInit, feeAmount };
    }

    let paidCount = 0;
    MONTHS.forEach(m=>{
      const info = record.months && record.months[m] ? record.months[m] : { paid:false, paidAt:null };
      if(info.paid) paidCount++;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${m}</td>
        <td class="center">${info.paid ? '✅ Paid' : '—'}</td>
        <td class="center">${info.paid && info.paidAt ? new Date(info.paidAt.seconds ? info.paidAt.seconds*1000 : info.paidAt).toLocaleString() : ''}</td>
        <td class="center"></td>
      `;
      tbody.appendChild(tr);

      const actionTd = tr.querySelector("td:last-child");
      const cb = document.createElement("input"); cb.type="checkbox"; cb.checked = !!info.paid; cb.disabled = (currentRole!=="admin");
      cb.addEventListener("change", async ()=>{
        if(currentRole!=="admin"){ cb.checked = !cb.checked; return alert("Only admin can change payments"); }
        try{
          if(!docSnap.exists){
            const monthsInit = {}; MONTHS.forEach(mm=> monthsInit[mm] = { paid:false, paidAt:null });
            await docRef.set({ memberId, year: selectedFeeYear, months: monthsInit, feeAmount });
          }
          const updatePaid = {}; updatePaid[`months.${m}.paid`] = cb.checked;
          const updatePaidAt = {}; updatePaidAt[`months.${m}.paidAt`] = cb.checked ? firebase.firestore.FieldValue.serverTimestamp() : null;
          await docRef.update(updatePaid);
          await docRef.update(updatePaidAt);
          loadFeeMonthsTable();
          loadFeeYearlySummary();
        }catch(err){ console.error("Toggle paid error:", err); alert("Failed to update: "+(err.message||err)); cb.checked = !cb.checked; }
      });
      actionTd.appendChild(cb);
    });

    const totalPaid = paidCount * feeAmount;
    document.getElementById("fee-member-summary").textContent = `Paid months: ${paidCount}/12 — Total: ₹${totalPaid}`;
  }catch(e){ console.error("Load fee months error:", e); alert("Failed to load fees: "+(e.message||e)); }
}

/* Save fee config (create or update feeAmount) */
document.getElementById("saveFeeConfigBtn").addEventListener("click", async ()=>{
  const memberId = feeMemberSelect.value; const feeAmount = Number(document.getElementById("feeAmountInput").value) || 100;
  if(!memberId) return alert("Select a member");
  try{
    const feesCol = membershipFeesCollectionFor(selectedFeeYear);
    const docRef = feesCol.doc(memberId);
    const docSnap = await docRef.get();
    if(!docSnap.exists){
      const monthsInit = {}; MONTHS.forEach(m=> monthsInit[m] = { paid:false, paidAt:null });
      await docRef.set({ memberId, year: selectedFeeYear, months: monthsInit, feeAmount });
    } else {
      await docRef.update({ feeAmount });
    }
    alert("Fee configuration saved");
    loadFeeMonthsTable(); loadFeeYearlySummary();
  }catch(e){ console.error("Save fee config error:", e); alert("Failed to save fee config: "+(e.message||e)); }
});

/* Clear member fee record */
document.getElementById("clearFeeRecordBtn").addEventListener("click", async ()=>{
  if(currentRole!=="admin") return alert("Only admin can clear fees");
  const memberId = feeMemberSelect.value; if(!memberId) return alert("Select a member");
  if(!confirm("Clear all fee records for this member and year?")) return;
  try{
    const docRef = membershipFeesCollectionFor(selectedFeeYear).doc(memberId);
    const snap = await docRef.get();
    if(snap.exists) await docRef.delete();
    alert("Cleared");
    loadFeeMonthsTable(); loadFeeYearlySummary();
  }catch(e){ console.error("Clear fee error:", e); alert("Failed to clear: "+(e.message||e)); }
});

/* Yearly aggregated summary for fees (selected year) */
async function loadFeeYearlySummary(){
  const tbody = document.querySelector("#fees-yearly-summary tbody"); if(!tbody) return; tbody.innerHTML="";
  try{
    const feesCol = membershipFeesCollectionFor(selectedFeeYear);
    const snap = await feesCol.get();
    const monthCounts = {}; MONTHS.forEach(m=> monthCounts[m] = { paid:0, total:0 });
    snap.forEach(docSnap=>{
      const d = docSnap.data(); const feeAmt = d.feeAmount || Number(document.getElementById("feeAmountInput").value) || 100;
      const monthsObj = d.months || {};
      MONTHS.forEach(m=>{
        if(monthsObj[m] && monthsObj[m].paid){ monthCounts[m].paid++; monthCounts[m].total += feeAmt; }
      });
    });
    MONTHS.forEach(m=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `<td>${m}</td><td class="center">${monthCounts[m].paid}</td><td class="center">₹${monthCounts[m].total}</td>`;
      tbody.appendChild(tr);
    });
  }catch(e){ console.error("Fee yearly summary error:", e); }
}

/* Utility: initial dropdown populate */
loadFeeMembersDropdown();

/* initial loads if already logged in */
setTimeout(()=>{ if(auth.currentUser){ loadAllData(); loadFeeMembersDropdown(); loadFeeYearlySummary(); } }, 200);

/* small feature: navigation links scroll to sections */
document.getElementById("nav-invitations").addEventListener("click", (e)=>{ e.preventDefault(); document.getElementById("invitations").scrollIntoView({behavior:"smooth"}); });
document.getElementById("nav-members").addEventListener("click", (e)=>{ e.preventDefault(); document.getElementById("members").scrollIntoView({behavior:"smooth"}); });
document.getElementById("nav-collectors").addEventListener("click", (e)=>{ e.preventDefault(); document.getElementById("collectors").scrollIntoView({behavior:"smooth"}); });
document.getElementById("nav-fees").addEventListener("click", (e)=>{ e.preventDefault(); document.getElementById("fees").scrollIntoView({behavior:"smooth"}); });

/* Expose for debugging */
window.loadAllData = loadAllData;
window.loadFeeMonthsTable = loadFeeMonthsTable;
window.loadFeeYearlySummary = loadFeeYearlySummary;

</script>
</body>
</html>
