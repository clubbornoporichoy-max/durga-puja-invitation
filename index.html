<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Club Bornoporichoy ‚Äî Durga Puja Dashboard</title>

<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<!-- Firebase compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --primary-red: #B71C1C;
    --deep-red: #a31313;
    --accent-gold: #D4AF37;
    --bg-start: #ffffff;
    --bg-end: #f7f0e8; /* soft beige */
    --card: #ffffff;
    --muted: #6b6b6b;
    --text: #2f2f2f;
    --radius: 12px;
    --shadow: 0 10px 30px rgba(17,17,17,0.06);
    --glass: rgba(255,255,255,0.6);
    --toast-bg: rgba(0,0,0,0.85);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body {
    margin: 0;
    background: linear-gradient(180deg, var(--bg-start), var(--bg-end));
    color: var(--text);
    font-family: 'Poppins', system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    line-height:1.45;
  }

  /* Header / nav (fixed) */
  header {
    position: fixed; top:0; left:0; right:0; z-index:100;
    background: linear-gradient(90deg, rgba(255,255,255,0.96), rgba(255,250,240,0.96));
    border-bottom: 1px solid rgba(0,0,0,0.04);
    padding: 12px 18px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.05);
    backdrop-filter: blur(6px);
  }
  .header-inner { max-width:1200px; margin:0 auto; display:flex; gap:12px; align-items:center; }
  .brand { display:flex; align-items:center; gap:12px; }
  .logo {
    width:44px; height:44px; border-radius:10px;
    background: linear-gradient(135deg, var(--primary-red), #e34b4b);
    display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; box-shadow:0 4px 14px rgba(183,28,28,0.12);
  }
  .brand h1 { margin:0; font-size:16px; color:var(--deep-red); font-weight:700; letter-spacing:0.2px; }
  .brand .sub { font-size:12px; color:var(--muted); margin-top:2px; }

  nav.topbar { margin-left:20px; display:flex; gap:10px; align-items:center; flex:1; }
  nav.topbar a {
    padding:8px 12px; border-radius:10px; text-decoration:none; color:var(--deep-red);
    font-weight:600; font-size:14px; transition: all 160ms ease;
  }
  nav.topbar a:hover { transform: translateY(-2px); color: #7f0f0f; box-shadow: inset 0 -2px 0 var(--accent-gold); }
  nav.topbar a.active { background: rgba(183,28,28,0.06); }

  .auth-area { margin-left:auto; display:flex; gap:8px; align-items:center; }

  /* Global Year Selector */
  .global-year-selector {
    background: var(--accent-gold);
    padding: 8px 15px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: 20px;
  }
  .global-year-selector label {
    font-size: 13px;
    font-weight: 600;
    color: var(--text);
    white-space: nowrap;
  }
  .global-year-selector select {
    background: white;
    border: none;
    border-radius: 6px;
    padding: 6px 10px;
    font-weight: 600;
    color: var(--primary-red);
    min-width: 100px;
  }

  /* Container + cards */
  .spacer { height:80px } /* to offset fixed header */
  .container { max-width:1200px; margin:22px auto; padding:0 18px 80px; }
  .card { background:var(--card); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow); margin-bottom:18px; border:1px solid rgba(0,0,0,0.03); transition: transform 160ms ease, box-shadow 160ms ease; }
  .card:hover { transform: translateY(-4px); box-shadow: 0 18px 40px rgba(17,17,17,0.08); }
  .card h2 { margin:0 0 8px 0; color:var(--primary-red); font-size:18px; display:flex; align-items:center; gap:8px; }
  .subtitle { color:var(--muted); font-size:13px; margin-bottom:10px; }

  .flex { display:flex; gap:12px; align-items:center; }
  .flex.space { justify-content:space-between; }

  input[type="text"], input[type="email"], input[type="password"], input[type="number"], select, textarea {
    padding:10px 12px; border-radius:10px; border:1px solid rgba(0,0,0,0.06); background:#fff;
    font-size:14px; color:var(--text); outline:none;
  }
  input:focus, select:focus, textarea:focus { box-shadow: 0 8px 24px rgba(183,28,28,0.06); border-color: rgba(183,28,28,0.18); }

  /* Buttons */
  .btn { background:var(--primary-red); color:#fff; border:none; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:600; box-shadow: 0 8px 20px rgba(183,28,28,0.08); transition: transform 120ms ease, box-shadow 120ms ease; }
  .btn:hover{ transform: translateY(-2px); box-shadow: 0 14px 28px rgba(183,28,28,0.12); }
  .btn.small { padding:7px 10px; font-size:13px; border-radius:8px; }
  .btn.secondary { background:var(--accent-gold); color:#222; box-shadow:none; }
  .btn.ghost { background:transparent; color:var(--deep-red); border:1px solid rgba(0,0,0,0.06); box-shadow:none; }

  .muted { color:var(--muted); font-size:13px; }
  .note { font-size:13px; color:var(--muted); margin-top:8px; }

  /* Tables */
  table { width:100%; border-collapse:collapse; font-size:14px; margin-top:12px; }
  thead th {
    text-align:left; padding:12px 14px; background:linear-gradient(0deg,var(--accent-gold), #f6e9a8); color:var(--text); border-bottom:2px solid rgba(0,0,0,0.04);
  }
  tbody td { padding:12px 14px; border-bottom:1px solid rgba(0,0,0,0.04); vertical-align:middle; }
  tbody tr:hover { background: rgba(183,28,28,0.02); }
  .editable { background: linear-gradient(180deg,#fff8e6,#fffdf7); border-radius:6px; padding:8px; }
  .badge { display:inline-block; padding:6px 8px; border-radius:8px; font-weight:700; font-size:13px; transition: all 240ms ease; }
  .badge.ok { background:#28a745; color:#fff; animation: pulse 1200ms infinite ease-in-out; }
  .badge.warn { background:#ff8c00; color:#fff; }
  @keyframes pulse { 0% { transform: scale(1); opacity:1 } 50% { transform: scale(1.03); opacity:0.92 } 100% { transform: scale(1); opacity:1 } }

  .center { text-align:center; }
  .right { margin-left:auto; }

  /* Paid tracker icons */
  .paid-box { display:inline-block; width:20px; height:20px; line-height:20px; text-align:center; border-radius:4px; font-weight:700; }
  .paid-yes { background:#28a745; color:white; box-shadow: 0 4px 10px rgba(40,167,69,0.12); }
  .paid-no { background:#fff; color:#888; border:1px solid #eee; }

  /* Summary Cards */
  .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
  .summary-card-item { text-align: center; background: var(--card); border-radius: var(--radius); padding: 15px; box-shadow: var(--shadow); }

  /* Village Breakdown */
  .village-breakdown { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 10px; }
  .breakdown-item { background: rgba(255,255,255,0.8); padding: 8px 12px; border-radius: 8px; border: 1px solid rgba(0,0,0,0.05); }
  .breakdown-label { font-size: 11px; color: var(--muted); margin-bottom: 4px; }
  .breakdown-value { font-weight: 700; color: var(--primary-red); font-size: 14px; }

  /* Quick Actions */
  .quick-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }

  /* Recent Activity */
  .activity-item { padding: 8px 12px; border-radius: 8px; margin-bottom: 8px; background: rgba(183,28,28,0.03); border-left: 3px solid var(--primary-red); }
  .activity-item.info { border-left-color: #17a2b8; }
  .activity-item.success { border-left-color: #28a745; }
  .activity-item.error { border-left-color: #dc3545; }

  /* Notifications */
  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    z-index: 10000;
    animation: slideIn 0.3s ease;
  }
  .notification-success { background: #28a745; }
  .notification-error { background: #dc3545; }
  .notification-info { background: #17a2b8; }
  @keyframes slideIn {
    from { transform: translateX(100%); }
    to { transform: translateX(0); }
  }

  /* Advanced Filters */
  .advanced-filters { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }

  /* Year Info Badge */
  .year-info {
    background: var(--primary-red);
    color: white;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    margin-left: 8px;
  }

  /* Bulk Upload Styles */
  .bulk-upload-section {
    background: rgba(183,28,28,0.03);
    border-radius: var(--radius);
    padding: 15px;
    margin-top: 15px;
    border: 1px dashed var(--primary-red);
  }
  
  .upload-options {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 15px;
  }
  
  .upload-textarea {
    width: 100%;
    min-height: 200px;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid rgba(0,0,0,0.1);
    font-family: monospace;
    font-size: 13px;
    resize: vertical;
  }
  
  .upload-preview {
    max-height: 300px;
    overflow-y: auto;
    margin: 15px 0;
    border: 1px solid rgba(0,0,0,0.1);
    border-radius: 8px;
    padding: 10px;
  }
  
  .preview-table {
    font-size: 12px;
  }
  
  .preview-table table {
    width: 100%;
    margin: 0;
  }
  
  .preview-table th {
    background: rgba(183,28,28,0.1);
    padding: 8px;
    font-size: 11px;
  }
  
  .preview-table td {
    padding: 6px 8px;
    border-bottom: 1px solid rgba(0,0,0,0.05);
  }
  
  .entry-status {
    font-size: 10px;
    font-weight: bold;
  }
  
  .progress-bar {
    width: 100%;
    height: 8px;
    background: #f0f0f0;
    border-radius: 4px;
    margin: 10px 0;
    overflow: hidden;
  }
  
  .progress-fill {
    height: 100%;
    background: var(--primary-red);
    transition: width 0.3s ease;
  }
  
  .progress-text {
    font-size: 12px;
    color: var(--muted);
    text-align: center;
  }

  /* Modal Styles */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
  }
  
  .modal-content {
    background: white;
    border-radius: var(--radius);
    padding: 20px;
    max-width: 500px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow);
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(0,0,0,0.1);
  }
  
  .modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--muted);
  }

  /* Financial Cards */
  .financial-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 15px;
  }
  
  .financial-card.income {
    background: linear-gradient(135deg, #28a745, #20c997);
  }
  
  .financial-card.expense {
    background: linear-gradient(135deg, #dc3545, #e83e8c);
  }
  
  .financial-card.net {
    background: linear-gradient(135deg, var(--primary-red), var(--accent-gold));
  }
  
  .budget-card {
    background: white;
    padding: 15px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    border-left: 4px solid var(--primary-red);
  }
  
  .budget-card.over-budget {
    border-left-color: #dc3545;
    background: rgba(220, 53, 69, 0.05);
  }
  
  .budget-card.warning {
    border-left-color: #ffc107;
    background: rgba(255, 193, 7, 0.05);
  }
  
  .budget-card.good {
    border-left-color: #28a745;
    background: rgba(40, 167, 69, 0.05);
  }

  /* Transaction Styles */
  .transaction-income {
    border-left: 4px solid #28a745;
    background: rgba(40, 167, 69, 0.05);
  }
  
  .transaction-expense {
    border-left: 4px solid #dc3545;
    background: rgba(220, 53, 69, 0.05);
  }

  /* Enhanced Styles */
  .loading {
    opacity: 0.6;
    pointer-events: none;
  }

  .loading-spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid var(--primary-red);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .skeleton-loading {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
  }

  @keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  /* Focus styles for keyboard navigation */
  button:focus, input:focus, select:focus, textarea:focus {
    outline: 2px solid var(--accent-gold);
    outline-offset: 2px;
  }

  /* High contrast support */
  @media (prefers-contrast: high) {
    :root {
      --primary-red: #8B0000;
      --accent-gold: #B8860B;
      --text: #000000;
    }
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    * {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }

  /* Screen reader only text */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  /* Enhanced Action Buttons */
  .action-buttons {
    display: flex;
    gap: 5px;
    flex-wrap: nowrap;
  }

  .action-buttons .btn {
    font-size: 12px;
    padding: 4px 8px;
  }

  /* Table action column */
  td:last-child {
    min-width: 200px;
  }

  /* responsive */
  @media (max-width: 768px) {
    .summary-cards {
      grid-template-columns: repeat(2, 1fr) !important;
    }
    
    .flex-row-mobile {
      flex-direction: column !important;
    }
    
    input, select, button {
      font-size: 16px !important; /* Prevents zoom on iOS */
    }
    
    table {
      font-size: 12px;
    }
    
    .card {
      padding: 12px;
    }

    .advanced-filters {
      flex-direction: column;
    }

    .quick-actions {
      flex-direction: column;
    }

    .header-inner{flex-direction:column; gap:10px; align-items:flex-start}
    nav.topbar{flex-wrap:wrap}
    .flex{flex-direction:column; align-items:stretch}
    .spacer{height:140px}
    
    .global-year-selector {
      margin-left: 0;
      margin-top: 10px;
    }
    
    .upload-options {
      flex-direction: column;
    }
    
    .modal-content {
      margin: 10px;
      padding: 15px;
      max-width: 95%;
    }
    
    .financial-overview-cards {
      grid-template-columns: 1fr !important;
    }
    
    .budget-grid {
      grid-template-columns: 1fr !important;
    }

    td:last-child {
      min-width: 150px;
    }
  }

  .total-collection {
    background: linear-gradient(135deg, var(--accent-gold), #f8e8a8);
    padding: 12px 16px;
    border-radius: 10px;
    margin-top: 12px;
    text-align: center;
    font-weight: 700;
    color: var(--text);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  .breakdown-container {
    display: flex;
    gap: 12px;
    margin-top: 8px;
    flex-wrap: wrap;
  }

  /* Financial Overview Grid */
  .financial-overview-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
  }
  
  .budget-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 15px;
    margin-top: 15px;
  }

  /* Utility classes */
  .hidden { display: none !important; }
  .visible { display: block !important; }
  .flex-row { display: flex; flex-direction: row; }
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="brand">
      <div class="logo">CB</div>
      <div>
        <h1>Club Bornoporichoy</h1>
        <div class="sub">Durga Puja Dashboard</div>
      </div>
    </div>

    <nav class="topbar" role="navigation" aria-label="Main navigation">
      <a href="#invitations" id="nav-invitations" class="active">Manage Invitations</a>
      <a href="#members" id="nav-members">Members</a>
      <a href="#fees" id="nav-fees">Membership Fees</a>
      <a href="#financial-tracker" id="nav-financial">Financial Tracker</a>
      <a href="#village-collection" id="nav-village-collection">Village Collection</a>
    </nav>

    <!-- Global Year Selector -->
    <div class="global-year-selector hidden" id="global-year-selector">
      <label>üìÖ Year:</label>
      <select id="globalYearSelect">
        <!-- Options will be populated dynamically -->
      </select>
    </div>

    <div class="auth-area">
      <div id="user-info" class="muted" style="font-size:13px"></div>
      <button id="logout-btn" class="btn small hidden">Logout</button>
    </div>
  </div>
</header>

<div class="spacer"></div>

<div class="container">

  <!-- Auth / Login Card -->
  <div class="card" id="auth-card">
    <div style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap">
      <div style="min-width:240px;flex:1">
        <label class="muted">Email</label>
        <input id="email" type="email" placeholder="admin@example.com" style="width:100%" />
      </div>
      <div style="min-width:220px;flex:1">
        <label class="muted">Password</label>
        <input id="password" type="password" placeholder="password" style="width:100%" />
      </div>

      <div style="min-width:160px">
        <label class="muted">Select Year</label>
        <select id="loginYearSelect" style="width:100%;">
          <!-- Options will be populated dynamically -->
        </select>
      </div>

      <div style="display:flex;gap:8px;align-items:center;margin-top:20px">
        <button id="login-btn" class="btn">Login</button>
      </div>
    </div>
    <div class="muted note" style="margin-top:10px">
      Use email/password login. Admin UID for edits: <code>fRpLuiBgU0ZE1AtVmkGaA1RhBJk2</code>
    </div>
  </div>

  <!-- Main content (hidden until login) -->
  <div id="main-content" class="hidden">

    <!-- 1. Real-time Dashboard Summary Cards (SEPARATE PANEL) -->
    <div class="card">
      <h3>üìä Dashboard Overview</h3>
      <div class="summary-cards">
        <div class="summary-card-item">
          <div style="font-size: 24px; font-weight: bold; color: var(--primary-red);" id="total-invitations">0</div>
          <div style="font-size: 14px; color: var(--muted);">Total Invitations</div>
        </div>
        <div class="summary-card-item">
          <div style="font-size: 24px; font-weight: bold; color: var(--primary-red);" id="total-members">0</div>
          <div style="font-size: 14px; color: var(--muted);">Total Members</div>
        </div>
        <div class="summary-card-item">
          <div style="font-size: 24px; font-weight: bold; color: var(--primary-red);" id="pending-invitations">0</div>
          <div style="font-size: 14px; color: var(--muted);">Pending Invitations</div>
        </div>
        <div class="summary-card-item">
          <div style="font-size: 24px; font-weight: bold; color: var(--primary-red);" id="active-collectors">0</div>
          <div style="font-size: 14px; color: var(--muted);">Active Collectors</div>
        </div>
      </div>
    </div>

    <!-- Financial Overview Cards -->
    <div class="card">
      <h3>üí∞ Financial Overview (<span id="financial-year-display">2025</span>)</h3>
      <div class="financial-overview-cards">
        <div class="financial-card income">
          <div style="font-size: 24px; font-weight: bold;" id="total-income">‚Çπ0</div>
          <div style="font-size: 14px; opacity: 0.9;">Total Income</div>
        </div>
        <div class="financial-card expense">
          <div style="font-size: 24px; font-weight: bold;" id="total-expenses">‚Çπ0</div>
          <div style="font-size: 14px; opacity: 0.9;">Total Expenses</div>
        </div>
        <div class="financial-card net">
          <div style="font-size: 24px; font-weight: bold;" id="net-balance">‚Çπ0</div>
          <div style="font-size: 14px; opacity: 0.9;">Net Balance</div>
        </div>
        <div class="summary-card-item">
          <div style="font-size: 24px; font-weight: bold; color: var(--accent-gold);" id="budget-utilization">0%</div>
          <div style="font-size: 14px; color: var(--muted);">Budget Used</div>
        </div>
      </div>
    </div>

    <!-- 4. Quick Actions Panel -->
    <div class="card">
      <h3>‚ö° Quick Actions</h3>
      <div class="quick-actions">
        <button class="btn small" onclick="exportAllData()">üìä Export All Data</button>
        <button class="btn small secondary" onclick="exportInvitationsBulk()">üìã Export Invitations</button>
        <button class="btn small ghost" onclick="generateFinancialReport()">üìä Financial Report</button>
        <button class="btn small" onclick="backupData()">üíæ Backup Data</button>
        <button class="btn small secondary" onclick="showAllYearsData()">üìÖ View All Years</button>
        <button class="btn small" onclick="showBulkUploadModal()">üì§ Bulk Upload</button>
        <button class="btn small secondary" onclick="showTransactionModal('income')">üí∞ Add Income</button>
        <button class="btn small" onclick="showTransactionModal('expense')">üí∏ Add Expense</button>
      </div>
    </div>

    <!-- 5. Recent Activity Feed -->
    <div class="card">
      <h3>üïí Recent Activity</h3>
      <div id="recent-activity" style="max-height: 200px; overflow-y: auto;">
        <!-- Activity items will be added here -->
      </div>
    </div>

    <!-- Year Information Card -->
    <div class="card" id="year-info-card">
      <h3>üìÖ Currently Viewing: <span id="current-year-display">2025</span> <span class="year-info" id="year-data-status">Loading...</span></h3>
      <div class="subtitle" id="year-data-description">Viewing membership fees and financial data for selected year. Other data (invitations, members) shows all years.</div>
      <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button class="btn small secondary" onclick="loadAllYearsFees()">üîÑ Load Fees from All Years</button>
        <button class="btn small ghost" onclick="showYearComparison()">üìä Compare Years</button>
      </div>
    </div>

    <!-- Budget Overview Card -->
    <div class="card" id="budget-tracker">
      <h2>üéØ Budget Overview (<span id="budget-year-display">2025</span>)</h2>
      <div class="subtitle">Track budget vs actual spending for Durga Puja</div>

      <div class="budget-grid" id="budget-cards-container">
        <!-- Budget cards will be populated here -->
      </div>

      <!-- Budget Progress Chart -->
      <div style="margin-top: 20px;">
        <canvas id="budgetChart" height="100"></canvas>
      </div>
    </div>

    <!-- Income & Expense Tracker -->
    <div class="card" id="financial-tracker">
      <h2>üí∞ Income & Expense Tracker (<span id="financial-tracker-year-display">2025</span>)</h2>
      <div class="subtitle">Track all Durga Puja financial transactions</div>

      <!-- Quick Transaction Buttons -->
      <div class="quick-actions" style="margin-bottom: 15px;">
        <button class="btn small secondary" onclick="showTransactionModal('income')">‚ûï Add Income</button>
        <button class="btn small" onclick="showTransactionModal('expense')">‚ûñ Add Expense</button>
        <button class="btn small ghost" onclick="loadFinancialData()">üîÑ Refresh</button>
      </div>

      <!-- Transaction Filters -->
      <div class="advanced-filters">
        <select id="filter-transaction-type" onchange="filterTransactions()">
          <option value="all">All Transactions</option>
          <option value="income">Income Only</option>
          <option value="expense">Expense Only</option>
        </select>
        <select id="filter-transaction-category" onchange="filterTransactions()">
          <option value="all">All Categories</option>
        </select>
        <input type="date" id="filter-transaction-from" onchange="filterTransactions()" placeholder="From Date">
        <input type="date" id="filter-transaction-to" onchange="filterTransactions()" placeholder="To Date">
      </div>

      <!-- Transactions Table -->
      <table id="transactions-table" style="margin-top: 12px;">
        <thead>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Category</th>
            <th>Description</th>
            <th>Amount</th>
            <th>Payment Mode</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <!-- Transaction Summary -->
      <div style="margin-top: 15px; padding: 15px; background: var(--glass); border-radius: var(--radius);">
        <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
          <div>
            <strong>Total Income:</strong> <span id="table-total-income" style="color: #28a745;">‚Çπ0</span>
          </div>
          <div>
            <strong>Total Expenses:</strong> <span id="table-total-expenses" style="color: #dc3545;">‚Çπ0</span>
          </div>
          <div>
            <strong>Net Balance:</strong> <span id="table-net-balance" style="color: var(--primary-red);">‚Çπ0</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced Invitations Table with Edit Buttons -->
    <div class="card" id="invitations">
      <h2>ü™î Invitation List <span class="year-info">All Years</span></h2>
      <div class="subtitle">Add, search and track invitation card distribution (shows data from all years)</div>

      <!-- Bulk Upload Section -->
      <div class="bulk-upload-section">
        <h4>üì§ Bulk Upload Invitations</h4>
        <div class="upload-options">
          <button onclick="showBulkUploadModal()" class="btn small">üìù Paste Data</button>
          <button onclick="downloadUploadTemplate()" class="btn small secondary">üìã Download Template</button>
          <input type="file" id="fileUpload" accept=".txt,.csv" style="display: none" onchange="handleFileUpload(this.files[0])">
          <button onclick="document.getElementById('fileUpload').click()" class="btn small">üìÅ Upload File</button>
        </div>
        <div class="muted note">
          Supported formats: Plain text with "|" separator, CSV files, or table data
        </div>
      </div>

      <!-- Enhanced Search & Filters -->
      <div class="advanced-filters">
        <select id="filter-village" style="min-width: 150px;">
          <option value="">All Villages</option>
          <option value="Madhabpur">Madhabpur</option>
          <option value="Paldhui">Paldhui</option>
          <option value="Sabitrapur">Sabitrapur</option>
          <option value="Lalupool">Lalupool</option>
          <option value="Mahakal">Mahakal</option>
          <option value="Others">Others</option>
        </select>
        <select id="filter-status" style="min-width: 150px;">
          <option value="">All Status</option>
          <option value="paid">Paid</option>
          <option value="pending">Pending</option>
        </select>
        <input type="date" id="filter-date-from" placeholder="From Date">
        <input type="date" id="filter-date-to" placeholder="To Date">
      </div>

      <div style="display:flex;gap:12px;margin-top:12px;align-items:center">
        <input id="search-invite" type="text" placeholder="Search invitations (name / village / mobile)..." style="flex:1" />
        <div class="muted">Admin can add/edit/delete</div>
      </div>

      <table id="invitation-table" style="margin-top:12px">
        <thead>
          <tr>
            <th>Name</th>
            <th>Village</th>
            <th>Mobile</th>
            <th>Remarks</th>
            <th>Sent</th>
            <th>Date Added</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div style="margin-top:12px">
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <input id="inv-name" type="text" placeholder="Name" style="min-width:180px" />
          <input id="inv-village" type="text" placeholder="Village" style="min-width:160px" />
          <input id="inv-mobile" type="text" placeholder="Mobile No" style="min-width:140px" />
          <input id="inv-remarks" type="text" placeholder="Remarks" style="min-width:200px" />
          <button id="add-inv-btn" class="btn small">Add Invitation</button>
        </div>
      </div>
    </div>

    <!-- Enhanced Members Table with Edit Buttons -->
    <div class="card" id="members">
      <h2>üå∏ Members List <span class="year-info">All Years</span></h2>
      <div class="subtitle">Manage members ‚Äî linked to membership fee tracker (shows data from all years)</div>

      <div style="display:flex;gap:12px;margin-top:12px;align-items:center">
        <input id="search-members" type="text" placeholder="Search members (name/mobile)..." style="flex:1" />
        <div class="muted">Admin can add/edit/delete</div>
      </div>

      <table id="members-table" style="margin-top:12px">
        <thead>
          <tr>
            <th>Name</th>
            <th>Village</th>
            <th>Mobile</th>
            <th>Remarks</th>
            <th>Date Added</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div style="margin-top:12px">
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <input id="mem-name" type="text" placeholder="Name" style="min-width:180px" />
          <input id="mem-village" type="text" placeholder="Village" style="min-width:160px" />
          <input id="mem-mobile" type="text" placeholder="Mobile No" style="min-width:140px" />
          <input id="mem-remarks" type="text" placeholder="Remarks" style="min-width:200px" />
          <button id="add-mem-btn" class="btn small">Add Member</button>
        </div>
      </div>
    </div>

    <!-- Membership Fees -->
    <div class="card" id="fees">
      <h2>üí∞ Membership Fees Tracker (<span id="fees-year-display">2025</span>)</h2>
      <div class="subtitle">Track monthly payments (‚Çπ per month configurable) - Year-specific data</div>

      <div style="display:flex;gap:12px;align-items:center;margin-top:12px">
        <div style="min-width:260px">
          <label class="muted">Member</label>
          <select id="feeMemberSelect" style="width:100%"><option value="">-- Select member --</option></select>
        </div>

        <div style="min-width:140px">
          <label class="muted">Monthly Fee (‚Çπ)</label>
          <input id="feeAmountInput" type="number" min="1" value="100" style="width:100%" />
        </div>

        <div style="display:flex;gap:8px;align-items:center;margin-left:auto">
          <button id="loadMemberFeeBtn" class="btn small">Load</button>
          <button id="exportCsvBtn" class="btn small secondary">Export CSV</button>
        </div>
      </div>

      <table id="fee-months-table" style="margin-top:12px">
        <thead><tr><th>Month</th><th>Status</th><th>Paid On</th><th>Toggle (Admin)</th></tr></thead>
        <tbody></tbody>
      </table>

      <div style="display:flex;align-items:center;gap:12px;margin-top:12px">
        <div id="fee-member-summary" class="muted">Select member to load fees</div>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button id="saveFeeConfigBtn" class="btn small">Save Config</button>
          <button id="clearFeeRecordBtn" class="btn small ghost">Clear</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <h3 style="margin:0 0 8px 0;color:var(--primary-red);font-size:15px">Yearly Summary</h3>
        <table id="fees-yearly-summary">
          <thead><tr><th>Month</th><th>Paid Members</th><th>Total Collected (‚Çπ)</th></tr></thead>
        <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Paid Members Visual Tracker -->
    <div class="card" id="paid-tracker">
      <h2>üí† Paid Members Visual Tracker (<span id="paid-tracker-year-display">2025</span>)</h2>
      <div class="subtitle">Click to load paid status for selected year. Click column header "Member" to sort A‚ÜíZ.</div>

      <div style="display:flex;gap:12px;align-items:center;margin-top:12px">
        <div style="min-width:220px">
          <button id="show-paid-btn" class="btn small">Show Paid Members</button>
          <button id="clear-paid-view" class="btn small ghost" style="margin-left:8px">Clear</button>
        </div>

        <div style="margin-left:auto">
          <div id="paid-tracker-count" class="muted">Loaded: 0</div>
        </div>
      </div>

      <div id="paid-members-list" style="margin-top:14px;overflow:auto;"></div>
    </div>

    <!-- Enhanced Village Collection Tracker with Edit Buttons -->
    <div class="card" id="village-collection">
      <h2>üèòÔ∏è Village Collection Tracker (<span id="village-collection-year-display">2025</span>)</h2>
      <div class="subtitle">Track donations per village and collector (year-specific data) - Data is copy-pasteable</div>

      <!-- Bulk Upload Section for Village Collections -->
      <div class="bulk-upload-section">
        <h4>üì§ Bulk Upload Village Collections</h4>
        <div class="upload-options">
          <button onclick="showVillageBulkUploadModal()" class="btn small">üìù Paste Data</button>
          <button onclick="downloadVillageUploadTemplate()" class="btn small secondary">üìã Download Template</button>
          <input type="file" id="villageFileUpload" accept=".txt,.csv" style="display: none" onchange="handleVillageFileUpload(this.files[0])">
          <button onclick="document.getElementById('villageFileUpload').click()" class="btn small">üìÅ Upload File</button>
          <button class="btn small secondary" onclick="exportVillageCollectionBulk()">üìã Copy Data</button>
        </div>
        <div class="muted note">
          Supported formats: Plain text with "|" separator, CSV files, or table data
        </div>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px">
        <input id="vc-bill" type="text" placeholder="Bill No" style="min-width:120px" />
        
        <select id="vc-collector" style="min-width:160px">
          <option value="">-- Select Collector --</option>
        </select>

        <input id="vc-donor" type="text" placeholder="Donor Name" style="min-width:160px" />

        <input id="vc-amount" type="number" placeholder="Amount (‚Çπ)" style="min-width:120px" />
        <input id="vc-remarks" type="text" placeholder="Remarks" style="min-width:200px" />

        <select id="vc-village" style="min-width:160px">
          <option value="">-- Select Village --</option>
          <option value="Madhabpur">Madhabpur</option>
          <option value="Paldhui">Paldhui</option>
          <option value="Sabitrapur">Sabitrapur</option>
          <option value="Lalupool">Lalupool</option>
          <option value="Mahakal">Mahakal</option>
          <option value="Others">Others</option>
        </select>

        <button id="add-vc-btn" class="btn small">Add Collection</button>
      </div>

      <!-- Total Collection Display -->
      <div id="vc-total-collection" class="total-collection" style="display:none;">
        Total Village Collection: ‚Çπ<span id="vc-total-amount">0</span>
      </div>

      <!-- Village-wise Collection Breakdown -->
      <div class="card" style="margin-top: 15px;">
        <h3>üèòÔ∏è Village-wise Collection</h3>
        <div id="village-breakdown" class="village-breakdown">
          <!-- Will be populated dynamically -->
        </div>
      </div>

      <!-- Monthly Collection Trends Chart -->
      <div class="card" style="margin-top: 15px;">
        <h3>üìà Monthly Collection Trend</h3>
        <canvas id="collectionChart" height="100"></canvas>
      </div>

      <table id="vc-table" style="margin-top:12px">
        <thead>
          <tr>
            <th>Bill No</th>
            <th>Collector</th>
            <th>Donor Name</th>
            <th>Amount (‚Çπ)</th>
            <th>Remarks</th>
            <th>Village</th>
            <th>Date Added</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <input id="search-vc" type="text" placeholder="Search collections..." style="margin-top:12px;width:100%;padding:8px;border-radius:8px;border:1px solid #ccc;" />
    </div>

  </div> <!-- main-content -->
</div> <!-- container -->

<!-- Toast container -->
<div class="toast-container" id="toast-container"></div>

<!-- Bulk Upload Modal for Invitations -->
<div id="bulkUploadModal" class="modal-overlay hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h3>üì§ Bulk Upload Invitations</h3>
      <button class="modal-close" onclick="closeBulkUploadModal()">&times;</button>
    </div>
    
    <div class="bulk-upload-section">
      <div class="upload-options">
        <button onclick="downloadUploadTemplate()" class="btn small secondary">üìã Download Template</button>
        <input type="file" id="modalFileUpload" accept=".txt,.csv" style="display: none" onchange="handleFileUpload(this.files[0])">
        <button onclick="document.getElementById('modalFileUpload').click()" class="btn small">üìÅ Upload File</button>
      </div>
      
      <div style="margin: 15px 0;">
        <label class="muted">Paste your data here (use template format):</label>
        <textarea id="bulkUploadTextarea" class="upload-textarea" placeholder="Paste data in format: Name | Village | Amount | Mobile | Remarks&#10;Sanjay Manna | Madhabpur | 1000 | 9876543210 | Regular donor&#10;Santosh Payra | Paldhui | 1000 | 9876543211 | "></textarea>
      </div>
      
      <div id="uploadPreview" class="upload-preview hidden">
        <!-- Preview will be shown here -->
      </div>
      
      <div id="uploadProgress" class="hidden">
        <div class="progress-bar">
          <div id="progressFill" class="progress-fill" style="width: 0%"></div>
        </div>
        <div id="progressText" class="progress-text">Processing...</div>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button id="processUploadBtn" class="btn" onclick="processBulkUpload()" disabled>‚úÖ Process Upload</button>
        <button class="btn ghost" onclick="closeBulkUploadModal()">‚ùå Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Bulk Upload Modal for Village Collections -->
<div id="villageBulkUploadModal" class="modal-overlay hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h3>üì§ Bulk Upload Village Collections</h3>
      <button class="modal-close" onclick="closeVillageBulkUploadModal()">&times;</button>
    </div>
    
    <div class="bulk-upload-section">
      <div class="upload-options">
        <button onclick="downloadVillageUploadTemplate()" class="btn small secondary">üìã Download Template</button>
        <input type="file" id="villageModalFileUpload" accept=".txt,.csv" style="display: none" onchange="handleVillageFileUpload(this.files[0])">
        <button onclick="document.getElementById('villageModalFileUpload').click()" class="btn small">üìÅ Upload File</button>
      </div>
      
      <div style="margin: 15px 0;">
        <label class="muted">Paste your data here (use template format):</label>
        <textarea id="villageBulkUploadTextarea" class="upload-textarea" placeholder="Paste data in format: Bill No | Collector Name | Donor Name | Amount | Village | Remarks&#10;001 | Sanjay Manna | Ramesh Das | 1000 | Madhabpur | Regular donor&#10;002 | Santosh Payra | Amit Roy | 500 | Paldhui | "></textarea>
      </div>
      
      <div id="villageUploadPreview" class="upload-preview hidden">
        <!-- Preview will be shown here -->
      </div>
      
      <div id="villageUploadProgress" class="hidden">
        <div class="progress-bar">
          <div id="villageProgressFill" class="progress-fill" style="width: 0%"></div>
        </div>
        <div id="villageProgressText" class="progress-text">Processing...</div>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button id="processVillageUploadBtn" class="btn" onclick="processVillageBulkUpload()" disabled>‚úÖ Process Upload</button>
        <button class="btn ghost" onclick="closeVillageBulkUploadModal()">‚ùå Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Transaction Modal -->
<div id="transactionModal" class="modal-overlay hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="transactionModalTitle">üí∞ Add Transaction</h3>
      <button class="modal-close" onclick="closeTransactionModal()">&times;</button>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
      <div>
        <label class="muted">Amount (‚Çπ)</label>
        <input type="number" id="transaction-amount" placeholder="Enter amount" style="width: 100%;">
      </div>
      <div>
        <label class="muted">Date</label>
        <input type="date" id="transaction-date" style="width: 100%;">
      </div>
      <div>
        <label class="muted">Category</label>
        <select id="transaction-category" style="width: 100%;">
          <!-- Categories will be populated dynamically -->
        </select>
      </div>
      <div>
        <label class="muted">Payment Mode</label>
        <select id="transaction-payment-mode" style="width: 100%;">
          <option value="Cash">Cash</option>
          <option value="Bank Transfer">Bank Transfer</option>
          <option value="UPI">UPI</option>
          <option value="Cheque">Cheque</option>
        </select>
      </div>
      <div style="grid-column: 1 / -1;">
        <label class="muted">Description</label>
        <textarea id="transaction-description" placeholder="Enter description..." style="width: 100%; min-height: 80px;"></textarea>
      </div>
    </div>
    
    <div style="display: flex; gap: 10px; margin-top: 20px;">
      <button class="btn" onclick="saveTransaction()">üíæ Save Transaction</button>
      <button class="btn ghost" onclick="closeTransactionModal()">‚ùå Cancel</button>
    </div>
  </div>
</div>

<!-- Edit Member Modal -->
<div id="editMemberModal" class="modal-overlay hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h3>‚úèÔ∏è Edit Member</h3>
      <button class="modal-close" onclick="closeEditMemberModal()">&times;</button>
    </div>
    <div style="display: grid; gap: 15px; margin-top: 15px;">
      <div>
        <label class="muted">Name *</label>
        <input type="text" id="edit-mem-name" placeholder="Member Name" style="width: 100%;">
      </div>
      <div>
        <label class="muted">Village *</label>
        <input type="text" id="edit-mem-village" placeholder="Village" style="width: 100%;">
      </div>
      <div>
        <label class="muted">Mobile</label>
        <input type="text" id="edit-mem-mobile" placeholder="Mobile Number" style="width: 100%;">
      </div>
      <div>
        <label class="muted">Remarks</label>
        <textarea id="edit-mem-remarks" placeholder="Remarks" style="width: 100%; min-height: 80px;"></textarea>
      </div>
    </div>
    <div style="display: flex; gap: 10px; margin-top: 20px;">
      <button class="btn" onclick="saveMemberEdit()">üíæ Save Changes</button>
      <button class="btn ghost" onclick="closeEditMemberModal()">‚ùå Cancel</button>
    </div>
  </div>
</div>

<!-- Edit Invitation Modal -->
<div id="editInvitationModal" class="modal-overlay hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h3>‚úèÔ∏è Edit Invitation</h3>
      <button class="modal-close" onclick="closeEditInvitationModal()">&times;</button>
    </div>
    <div style="display: grid; gap: 15px; margin-top: 15px;">
      <div>
        <label class="muted">Name *</label>
        <input type="text" id="edit-inv-name" placeholder="Name" style="width: 100%;">
      </div>
      <div>
        <label class="muted">Village *</label>
        <input type="text" id="edit-inv-village" placeholder="Village" style="width: 100%;">
      </div>
      <div>
        <label class="muted">Mobile</label>
        <input type="text" id="edit-inv-mobile" placeholder="Mobile Number" style="width: 100%;">
      </div>
      <div>
        <label class="muted">Remarks</label>
        <textarea id="edit-inv-remarks" placeholder="Remarks" style="width: 100%; min-height: 80px;"></textarea>
      </div>
      <div>
        <label class="muted">Status</label>
        <select id="edit-inv-sent" style="width: 100%;">
          <option value="false">Pending</option>
          <option value="true">Sent</option>
        </select>
      </div>
    </div>
    <div style="display: flex; gap: 10px; margin-top: 20px;">
      <button class="btn" onclick="saveInvitationEdit()">üíæ Save Changes</button>
      <button class="btn ghost" onclick="closeEditInvitationModal()">‚ùå Cancel</button>
    </div>
  </div>
</div>

<!-- Edit Collection Modal -->
<div id="editCollectionModal" class="modal-overlay hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h3>‚úèÔ∏è Edit Collection</h3>
      <button class="modal-close" onclick="closeEditCollectionModal()">&times;</button>
    </div>
    <div style="display: grid; gap: 15px; margin-top: 15px;">
      <div>
        <label class="muted">Bill No *</label>
        <input type="text" id="edit-vc-bill" placeholder="Bill Number" style="width: 100%;">
      </div>
      <div>
        <label class="muted">Collector *</label>
        <select id="edit-vc-collector" style="width: 100%;">
          <option value="">-- Select Collector --</option>
        </select>
      </div>
      <div>
        <label class="muted">Donor Name *</label>
        <input type="text" id="edit-vc-donor" placeholder="Donor Name" style="width: 100%;">
      </div>
      <div>
        <label class="muted">Amount (‚Çπ) *</label>
        <input type="number" id="edit-vc-amount" placeholder="Amount" style="width: 100%;">
      </div>
      <div>
        <label class="muted">Village *</label>
        <select id="edit-vc-village" style="width: 100%;">
          <option value="">-- Select Village --</option>
          <option value="Madhabpur">Madhabpur</option>
          <option value="Paldhui">Paldhui</option>
          <option value="Sabitrapur">Sabitrapur</option>
          <option value="Lalupool">Lalupool</option>
          <option value="Mahakal">Mahakal</option>
          <option value="Others">Others</option>
        </select>
      </div>
      <div>
        <label class="muted">Remarks</label>
        <textarea id="edit-vc-remarks" placeholder="Remarks" style="width: 100%; min-height: 80px;"></textarea>
      </div>
    </div>
    <div style="display: flex; gap: 10px; margin-top: 20px;">
      <button class="btn" onclick="saveCollectionEdit()">üíæ Save Changes</button>
      <button class="btn ghost" onclick="closeEditCollectionModal()">‚ùå Cancel</button>
    </div>
  </div>
</div>

<!-- Screen reader live region -->
<div id="sr-live-region" class="sr-only" aria-live="polite" aria-atomic="true"></div>

<script>
/* ==================== ENHANCEMENTS IMPLEMENTATION ==================== */

/* ---------------- Performance & Lazy Loading ---------------- */
let observers = [];
let lazyLoadObserver;

function initLazyLoading() {
  const observerOptions = {
    rootMargin: '50px',
    threshold: 0.1
  };

  lazyLoadObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const element = entry.target;
        if (element.id === 'collectionChart' && !collectionChart) {
          console.log('Lazy loading collection chart');
          initCollectionChart();
        }
        if (element.id === 'budgetChart' && !budgetChart) {
          console.log('Lazy loading budget chart');
          initBudgetChart();
        }
      }
    });
  }, observerOptions);

  // Observe chart containers
  const chartElements = document.querySelectorAll('#collectionChart, #budgetChart');
  chartElements.forEach(el => {
    if (el) lazyLoadObserver.observe(el);
  });
}

/* ---------------- Enhanced Error Handling ---------------- */
function setupGlobalErrorHandlers() {
  // Global error handler
  window.addEventListener('error', (e) => {
    console.error('Global error:', e.error);
    showNotification('An unexpected error occurred', 'error');
  });

  // Unhandled promise rejection handler
  window.addEventListener('unhandledrejection', (e) => {
    console.error('Unhandled promise rejection:', e.reason);
    showNotification('Operation failed: ' + (e.reason?.message || 'Unknown error'), 'error');
    e.preventDefault();
  });
}

// Enhanced Firebase error handling
function withFirebaseErrorHandling(operation, customMessage) {
  return async (...args) => {
    try {
      return await operation(...args);
    } catch (error) {
      console.error(`Firebase ${operation.name} error:`, error);
      
      if (error.code === 'permission-denied') {
        showNotification('Permission denied: You cannot perform this action', 'error');
      } else if (error.code === 'unavailable') {
        showNotification('Network error: Please check your connection', 'error');
      } else if (error.code === 'not-found') {
        showNotification('Data not found', 'error');
      } else {
        showNotification(customMessage || 'Operation failed', 'error');
      }
      throw error;
    }
  };
}

/* ---------------- Loading States & User Feedback ---------------- */
function withLoading(button, operation) {
  return async (...args) => {
    const originalText = button.textContent;
    const originalHTML = button.innerHTML;
    button.innerHTML = '<span class="loading-spinner"></span> Loading...';
    button.disabled = true;
    button.classList.add('loading');
    
    try {
      const result = await operation(...args);
      return result;
    } finally {
      button.innerHTML = originalHTML;
      button.textContent = originalText;
      button.disabled = false;
      button.classList.remove('loading');
    }
  };
}

// Enhanced button loading for all major actions
function enhanceButtonsWithLoading() {
  const loginBtn = document.getElementById("login-btn");
  if (loginBtn) {
    const originalOnClick = loginBtn.onclick;
    loginBtn.onclick = null;
    loginBtn.addEventListener("click", () => {
      withLoading(loginBtn, async () => {
        const email = document.getElementById("email").value.trim();
        const pw = document.getElementById("password").value;
        if(!email || !pw) throw new Error("Enter email and password");
        
        await auth.signInWithEmailAndPassword(email,pw);
        showToast("Logged in");
        addActivity('User logged in successfully', 'success');
      })().catch(error => {
        alert("Login error: "+error.message);
        addActivity('Login failed: ' + error.message, 'error');
      });
    });
  }
}

/* ---------------- Data Caching Strategy ---------------- */
const cache = new Map();
const CACHE_TTL = 5 * 60 * 1000; // 5 minutes

function withCache(key, operation, ttl = CACHE_TTL) {
  const cached = cache.get(key);
  if (cached && Date.now() - cached.timestamp < ttl) {
    console.log(`Cache hit for: ${key}`);
    return Promise.resolve(cached.data);
  }
  
  return operation().then(data => {
    cache.set(key, { data, timestamp: Date.now() });
    console.log(`Cache set for: ${key}`);
    return data;
  });
}

function clearCache(pattern) {
  let cleared = 0;
  for (const key of cache.keys()) {
    if (key.includes(pattern)) {
      cache.delete(key);
      cleared++;
    }
  }
  console.log(`Cleared ${cleared} cache entries for pattern: ${pattern}`);
}

// Enhanced load functions with caching
const cachedLoadMembers = () => withCache('members', () => membersCol.orderBy("name").get());
const cachedLoadInvitations = () => withCache('invitations', () => invitationCol.orderBy("dateAdded","desc").get());

/* ---------------- Accessibility Improvements ---------------- */
function enhanceAccessibility() {
  // Add aria-live regions for dynamic content
  const liveRegion = document.getElementById('sr-live-region');
  
  // Enhanced notifications for screen readers
  const originalShowNotification = window.showNotification;
  window.showNotification = (message, type = 'info', duration = 5000) => {
    originalShowNotification(message, type, duration);
    if (liveRegion) {
      liveRegion.textContent = message;
      // Clear after a delay so subsequent announcements work
      setTimeout(() => liveRegion.textContent = '', 100);
    }
  };

  // Add keyboard navigation to tables
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Tab') {
      // Ensure focus indicators are visible
      document.body.classList.add('keyboard-navigation');
    }
  });

  document.addEventListener('mousedown', () => {
    document.body.classList.remove('keyboard-navigation');
  });
}

/* ---------------- Memory Management ---------------- */
function cleanup() {
  // Clean up observers
  if (lazyLoadObserver) {
    lazyLoadObserver.disconnect();
  }
  observers.forEach(observer => observer.disconnect());
  observers = [];
  
  // Clear intervals and timeouts
  if (window.updateInterval) {
    clearInterval(window.updateInterval);
  }
  
  // Clear cache
  cache.clear();
  
  // Remove global event listeners
  document.removeEventListener('keydown', handleGlobalKeys);
  
  console.log('Cleanup completed');
}

/* ---------------- Enhanced Search & Filtering ---------------- */
function enhancedFilterTable(tableId, term, searchColumns = []) {
  const table = document.getElementById(tableId);
  if (!table) return;
  
  const rows = table.querySelectorAll("tbody tr");
  const q = (term || "").toLowerCase().trim();
  
  if (!q) {
    rows.forEach(r => r.style.display = "");
    return;
  }
  
  // Use requestAnimationFrame for smoother filtering
  requestAnimationFrame(() => {
    let visibleCount = 0;
    rows.forEach(r => {
      let match = false;
      const cells = r.querySelectorAll('td');
      
      if (searchColumns.length > 0) {
        // Search specific columns
        searchColumns.forEach(colIndex => {
          if (cells[colIndex] && cells[colIndex].textContent.toLowerCase().includes(q)) {
            match = true;
          }
        });
      } else {
        // Search all columns
        match = r.textContent.toLowerCase().includes(q);
      }
      
      r.style.display = match ? "" : "none";
      if (match) visibleCount++;
    });
    
    // Update table info if available
    const tableInfo = table.parentNode.querySelector('.table-info');
    if (tableInfo) {
      tableInfo.textContent = `Showing ${visibleCount} of ${rows.length} records`;
    }
  });
}

/* ---------------- Progressive Enhancement ---------------- */
function checkBrowserCompatibility() {
  const features = {
    intersectionObserver: 'IntersectionObserver' in window,
    firestore: 'firebase' in window && 'firestore' in firebase,
    promises: 'Promise' in window,
    fetch: 'fetch' in window,
  };
  
  const missingFeatures = Object.entries(features).filter(([_, supported]) => !supported).map(([name]) => name);
  
  if (missingFeatures.length > 0) {
    console.warn('Missing browser features:', missingFeatures);
    
    if (!features.intersectionObserver) {
      console.warn('IntersectionObserver not supported, loading all charts immediately');
      // Load charts immediately if IntersectionObserver is not supported
      setTimeout(() => {
        if (!collectionChart) initCollectionChart();
        if (!budgetChart) initBudgetChart();
      }, 1000);
    }
    
    if (!features.promises) {
      showNotification('Your browser may not support all features. Please update for best experience.', 'warning', 10000);
    }
  }
}

/* ---------------- Enhanced Navigation ---------------- */
function navigateToSection(sectionId) {
  const targetElement = document.getElementById(sectionId);
  if (targetElement) {
    // Update URL without page reload
    history.pushState(null, '', `#${sectionId}`);
    
    targetElement.scrollIntoView({ 
      behavior: "smooth",
      block: "start"
    });
    
    // Update active nav
    clearActiveNav();
    const navElement = document.getElementById(`nav-${sectionId}`);
    if (navElement) navElement.classList.add('active');
    
    // Update screen reader
    const liveRegion = document.getElementById('sr-live-region');
    if (liveRegion) {
      liveRegion.textContent = `Navigated to ${sectionId} section`;
    }
  }
}

// Handle browser back/forward buttons
window.addEventListener('popstate', () => {
  const hash = window.location.hash.substring(1);
  if (hash && document.getElementById(hash)) {
    navigateToSection(hash);
  }
});

/* ---------------- Enhanced Utility Functions ---------------- */
const DashboardUtils = {
  debounce,
  escapeHtml,
  safeSetTextContent,
  withLoading,
  withCache,
  enhancedFilterTable,
  withFirebaseErrorHandling
};

const DashboardAPI = {
  loadMembers: cachedLoadMembers,
  loadInvitations: cachedLoadInvitations,
  loadFinancialData,
  // ... other data methods will be enhanced below
};

/* ==================== ORIGINAL CODE WITH ENHANCEMENTS ==================== */

/* ---------------- Firebase config (hardcoded) ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyCuVs6jx7HiNIx25lzLgoq1B6nQqaHLHm0",
  authDomain: "guestandcollection.firebaseapp.com",
  projectId: "guestandcollection",
  storageBucket: "guestandcollection.firebasestorage.app",
  messagingSenderId: "272278233160",
  appId: "1:272278233160:web:d6d1e6a7d58be260d9b87d",
  measurementId: "G-B5783XTFSP"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ---------------- Financial Constants ---------------- */
const INCOME_CATEGORIES = [
    'Donations', 'Membership Fees', 'Sponsorships', 'Advertisement', 
    'Ticket Sales', 'Food Stalls', 'Cultural Events', 'Others'
];

const EXPENSE_CATEGORIES = [
    'Pandal & Decorations', 'Idol & Materials', 'Priest & Rituals',
    'Electricity & Sound', 'Cooking and Materials', 'Food & Prasad', 'Cultural Program',
    'Printing & Publicity', 'Transportation', 'Miscellaneous', 'Puja Hat & Materials', 'Awards & others', 'Club Construction', 'Dhaki & Napit'
];

const BUDGET_ITEMS = {
    'Pandal & Decorations': 70000,
    'Idol & Materials': 40000,
    'Priest & Rituals': 15000,
    'Electricity & Sound': 30000,
    'Cooking and Materials': 8000,
    'Food & Prasad': 40000,
    'Cultural Program': 15000,
    'Printing & Publicity': 20000,
    'Transportation': 7000,
    'Miscellaneous': 12000,
    'Puja Hat & Materials': 35000,
    'Awards & others': 10000,
    'Club Construction': 80000,
    'Dhaki & Napit': 12000
};

/* ---------------- Global Year Selection System ---------------- */
let selectedYear = new Date().getFullYear(); // Default to current year
let allYearsFeesData = {}; // Store fees data from all years
let allYearsVillageData = {}; // Store village collection data from all years
let budgetChart = null;

// Function to populate year dropdowns
function populateYearDropdowns() {
  const loginYearSelect = document.getElementById('loginYearSelect');
  const globalYearSelect = document.getElementById('globalYearSelect');
  
  // Clear existing options
  if (loginYearSelect) loginYearSelect.innerHTML = '';
  if (globalYearSelect) globalYearSelect.innerHTML = '';
  
  // Add "All Years" option
  const allYearsOption = document.createElement('option');
  allYearsOption.value = 'all';
  allYearsOption.textContent = 'All Years';
  
  if (loginYearSelect) loginYearSelect.appendChild(allYearsOption.cloneNode(true));
  if (globalYearSelect) globalYearSelect.appendChild(allYearsOption.cloneNode(true));
  
  // Add years from 2025 to 2050
  for (let year = 2025; year <= 2050; year++) {
    const option = document.createElement('option');
    option.value = year;
    option.textContent = year;
    
    if (year === selectedYear) {
      option.selected = true;
    }
    
    if (loginYearSelect) loginYearSelect.appendChild(option.cloneNode(true));
    if (globalYearSelect) globalYearSelect.appendChild(option);
  }
}

// Function to update year displays
function updateYearDisplays() {
  // Update header displays
  const currentYearDisplay = document.getElementById('current-year-display');
  const feesYearDisplay = document.getElementById('fees-year-display');
  const paidTrackerYearDisplay = document.getElementById('paid-tracker-year-display');
  const villageCollectionYearDisplay = document.getElementById('village-collection-year-display');
  const financialYearDisplay = document.getElementById('financial-year-display');
  const financialTrackerYearDisplay = document.getElementById('financial-tracker-year-display');
  const budgetYearDisplay = document.getElementById('budget-year-display');
  
  if (currentYearDisplay) currentYearDisplay.textContent = selectedYear === 'all' ? 'All Years' : selectedYear;
  if (feesYearDisplay) feesYearDisplay.textContent = selectedYear === 'all' ? 'All Years' : selectedYear;
  if (paidTrackerYearDisplay) paidTrackerYearDisplay.textContent = selectedYear === 'all' ? 'All Years' : selectedYear;
  if (villageCollectionYearDisplay) villageCollectionYearDisplay.textContent = selectedYear === 'all' ? 'All Years' : selectedYear;
  if (financialYearDisplay) financialYearDisplay.textContent = selectedYear === 'all' ? 'All Years' : selectedYear;
  if (financialTrackerYearDisplay) financialTrackerYearDisplay.textContent = selectedYear === 'all' ? 'All Years' : selectedYear;
  if (budgetYearDisplay) budgetYearDisplay.textContent = selectedYear === 'all' ? 'All Years' : selectedYear;
  
  // Update year data status
  const yearDataStatus = document.getElementById('year-data-status');
  const yearDataDescription = document.getElementById('year-data-description');
  
  if (selectedYear === 'all') {
    if (yearDataStatus) yearDataStatus.textContent = 'All Years Data';
    if (yearDataDescription) yearDataDescription.textContent = 'Viewing aggregated data from all years. Membership fees and financial data are combined across all available years.';
  } else {
    if (yearDataStatus) yearDataStatus.textContent = `Year ${selectedYear}`;
    if (yearDataDescription) yearDataDescription.textContent = `Viewing membership fees and financial data for ${selectedYear}. Other data (invitations, members) shows all years.`;
  }
  
  // Update global year selector
  const globalYearSelect = document.getElementById('globalYearSelect');
  if (globalYearSelect) {
    globalYearSelect.value = selectedYear;
  }
}

// Function to change global year
function changeGlobalYear(newYear) {
  selectedYear = newYear === 'all' ? 'all' : parseInt(newYear);
  updateYearDisplays();
  
  // Clear cache when year changes
  clearCache('fees');
  clearCache('village');
  clearCache('financial');
  
  // Reload all year-dependent data
  loadFeeMembersDropdown();
  loadFeeYearlySummary();
  loadVillageCollections();
  loadFinancialData();
  recalcTotalCollected();
  
  // Show notification
  if (selectedYear === 'all') {
    showNotification('Now viewing data from all years', 'info');
    addActivity('Changed to view all years data', 'info');
  } else {
    showNotification(`Year changed to ${selectedYear}. All data updated.`, 'info');
    addActivity(`Changed global year to ${selectedYear}`, 'info');
  }
}

// Function to load fees data from all years
async function loadAllYearsFees() {
  try {
    addActivity('Loading fees data from all years...', 'info');
    
    allYearsFeesData = {};
    const years = [2024, 2025]; // Add all years you have data for
    
    for (const year of years) {
      try {
        const feesCol = membershipFeesCollectionFor(year);
        const snap = await feesCol.get();
        if (!snap.empty) {
          allYearsFeesData[year] = {};
          snap.forEach(doc => {
            allYearsFeesData[year][doc.id] = doc.data();
          });
        }
      } catch (error) {
        console.log(`No data found for year ${year} or collection doesn't exist`);
      }
    }
    
    showNotification('Loaded fees data from all available years', 'success');
    addActivity('Fees data loaded from all years', 'success');
    
    // Refresh the display
    if (selectedYear === 'all') {
      loadFeeYearlySummary();
      recalcTotalCollected();
    }
    
  } catch (error) {
    console.error('Error loading all years fees:', error);
    showNotification('Error loading data from all years', 'error');
  }
}

// Function to load village collection data from all years
async function loadAllYearsVillageCollections() {
  try {
    addActivity('Loading village collection data from all years...', 'info');
    
    allYearsVillageData = {};
    const years = [2024, 2025]; // Add all years you have data for
    
    for (const year of years) {
      try {
        const villageCol = villageCollectionsCollectionFor(year);
        const snap = await villageCol.get();
        if (!snap.empty) {
          allYearsVillageData[year] = {};
          snap.forEach(doc => {
            allYearsVillageData[year][doc.id] = doc.data();
          });
        }
      } catch (error) {
        console.log(`No village collection data found for year ${year} or collection doesn't exist`);
      }
    }
    
    showNotification('Loaded village collection data from all available years', 'success');
    addActivity('Village collection data loaded from all years', 'success');
    
    // Refresh the display
    if (selectedYear === 'all') {
      loadVillageCollections();
      recalcTotalCollected();
    }
    
  } catch (error) {
    console.error('Error loading all years village collections:', error);
    showNotification('Error loading village collection data from all years', 'error');
  }
}

// Function to show all years data
function showAllYearsData() {
  changeGlobalYear('all');
}

// Function to show year comparison (placeholder)
function showYearComparison() {
  showNotification('Year comparison feature coming soon!', 'info');
}

// Initialize year system
populateYearDropdowns();

/* ---------------- Event Listeners for Year Selection ---------------- */
document.addEventListener('DOMContentLoaded', function() {
  // Login year selector
  const loginYearSelect = document.getElementById('loginYearSelect');
  if (loginYearSelect) {
    loginYearSelect.addEventListener('change', function(e) {
      selectedYear = e.target.value === 'all' ? 'all' : parseInt(e.target.value);
      updateYearDisplays();
    });
  }
  
  // Global year selector (in header)
  const globalYearSelect = document.getElementById('globalYearSelect');
  if (globalYearSelect) {
    globalYearSelect.addEventListener('change', function(e) {
      changeGlobalYear(e.target.value);
    });
  }
});

/* ---------------- Roles & constants ---------------- */
const ROLES = {
  "fRpLuiBgU0ZE1AtVmkGaA1RhBJk2": "admin",
  "898Fi5sPKHY01GUgI4iu1xS4TBR2": "viewer"
};
let currentRole = "viewer";
const MONTHS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

/* ---------------- collections (static) ---------------- */
const invitationCol = db.collection("invitations");
const membersCol = db.collection("members");
function membershipFeesCollectionFor(year){ return db.collection(`membership_fees_${year}`); }
function villageCollectionsCollectionFor(year){ return db.collection(`village_collections_${year}`); }
function incomeCollectionFor(year){ return db.collection(`income_${year}`); }
function expenseCollectionFor(year){ return db.collection(`expenses_${year}`); }

/* ---------------- Chart initialization ---------------- */
let collectionChart;
function initCollectionChart() {
  const ctx = document.getElementById('collectionChart');
  if (!ctx) {
    console.warn('Chart canvas not found');
    return;
  }
  
  collectionChart = new Chart(ctx.getContext('2d'), {
    type: 'line',
    data: {
      labels: MONTHS,
      datasets: [{
        label: 'Monthly Collection (‚Çπ)',
        data: Array(12).fill(0),
        borderColor: '#B71C1C',
        backgroundColor: 'rgba(183, 28, 28, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'top',
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return '‚Çπ' + value;
            }
          }
        }
      }
    }
  });
}

// Initialize budget chart
function initBudgetChart() {
  const ctx = document.getElementById('budgetChart');
  if (!ctx) return;
  
  budgetChart = new Chart(ctx.getContext('2d'), {
    type: 'bar',
    data: {
      labels: Object.keys(BUDGET_ITEMS),
      datasets: [
        {
          label: 'Budget',
          data: Object.values(BUDGET_ITEMS),
          backgroundColor: 'rgba(183, 28, 28, 0.6)',
          borderColor: 'rgba(183, 28, 28, 1)',
          borderWidth: 1
        },
        {
          label: 'Actual Spent',
          data: Array(Object.keys(BUDGET_ITEMS).length).fill(0),
          backgroundColor: 'rgba(212, 175, 55, 0.6)',
          borderColor: 'rgba(212, 175, 55, 1)',
          borderWidth: 1
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'top',
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `${context.dataset.label}: ‚Çπ${context.raw.toLocaleString()}`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return '‚Çπ' + value;
            }
          }
        },
        x: {
          ticks: {
            maxRotation: 45,
            minRotation: 45
          }
        }
      }
    }
  });
}

/* ---------------- Summary Cards Functions ---------------- */
async function updateSummaryCards() {
  try {
    // Total invitations
    const invitationsSnap = await cachedLoadInvitations();
    const totalInvitations = invitationsSnap.size;
    safeSetTextContent('total-invitations', totalInvitations);

    // Total members
    const membersSnap = await cachedLoadMembers();
    const totalMembers = membersSnap.size;
    safeSetTextContent('total-members', totalMembers);

    // Pending invitations
    let pendingInvitations = 0;
    invitationsSnap.forEach(doc => {
      const data = doc.data();
      if (!data.sent) pendingInvitations++;
    });
    safeSetTextContent('pending-invitations', pendingInvitations);

    // Active collectors (now using members)
    safeSetTextContent('active-collectors', totalMembers);

  } catch (error) {
    console.error("Error updating summary cards:", error);
  }
}

/* ---------------- Safe DOM element helper ---------------- */
function safeSetTextContent(elementId, text) {
  const element = document.getElementById(elementId);
  if (element) {
    element.textContent = text;
  } else {
    console.warn(`Element with id '${elementId}' not found`);
  }
}

/* ---------------- Village Breakdown Function ---------------- */
async function loadVillageBreakdown() {
  const breakdownContainer = document.getElementById('village-breakdown');
  if (!breakdownContainer) {
    console.warn('Village breakdown container not found');
    return;
  }
  
  try {
    let villageTotals = {};
    
    if (selectedYear === 'all') {
      // Aggregate data from all years
      if (Object.keys(allYearsVillageData).length === 0) {
        await loadAllYearsVillageCollections();
      }
      
      Object.values(allYearsVillageData).forEach(yearData => {
        Object.values(yearData).forEach(collection => {
          const village = collection.village || 'Others';
          villageTotals[village] = (villageTotals[village] || 0) + (collection.amount || 0);
        });
      });
    } else {
      // Single year data
      const villageCol = villageCollectionsCollectionFor(selectedYear);
      const snap = await villageCol.get();
      
      snap.forEach(doc => {
        const d = doc.data();
        const village = d.village || 'Others';
        villageTotals[village] = (villageTotals[village] || 0) + (d.amount || 0);
      });
    }
    
    breakdownContainer.innerHTML = Object.entries(villageTotals)
      .map(([village, total]) => `
        <div class="breakdown-item">
          <div class="breakdown-label">${village}</div>
          <div class="breakdown-value">‚Çπ${total.toLocaleString()}</div>
        </div>
      `).join('');
  } catch (error) {
    console.error("Error loading village breakdown:", error);
    breakdownContainer.innerHTML = '<div class="breakdown-item">Error loading data</div>';
  }
}

/* ---------------- Recent Activity Functions ---------------- */
function addActivity(message, type = 'info') {
  const activityDiv = document.getElementById('recent-activity');
  if (!activityDiv) {
    console.warn('Recent activity container not found');
    return;
  }
  
  const activityItem = document.createElement('div');
  activityItem.className = `activity-item ${type}`;
  activityItem.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <span>${message}</span>
      <small style="color: var(--muted);">${new Date().toLocaleTimeString()}</small>
    </div>
  `;
  activityDiv.insertBefore(activityItem, activityDiv.firstChild);
  
  // Keep only last 10 activities
  if (activityDiv.children.length > 10) {
    activityDiv.removeChild(activityDiv.lastChild);
  }
}

/* ---------------- Enhanced Notification System ---------------- */
function showNotification(message, type = 'info', duration = 5000) {
  // Remove existing notifications of same type to avoid duplicates
  const existingNotifications = document.querySelectorAll('.notification');
  existingNotifications.forEach(notification => {
    if (notification.textContent.includes(message)) {
      notification.remove();
    }
  });

  const notification = document.createElement('div');
  notification.className = `notification notification-${type}`;
  notification.innerHTML = `
    <div style="display: flex; align-items: center; gap: 10px;">
      <span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
      <span>${message}</span>
    </div>
  `;
  
  document.body.appendChild(notification);
  
  // Auto remove after duration
  setTimeout(() => {
    if (notification.parentNode) {
      notification.parentNode.removeChild(notification);
    }
  }, duration);
}

/* ---------------- Data Validation ---------------- */
function validateCollectionData(data) {
  const errors = [];
  if (!data.bill) errors.push('Bill number is required');
  if (!data.collectorId) errors.push('Collector is required');
  if (!data.amount || data.amount <= 0) errors.push('Valid amount is required');
  if (!data.village) errors.push('Village is required');
  
  return errors;
}

/* ---------------- Quick Actions Functions ---------------- */
async function exportAllData() {
  try {
    addActivity('Starting data export...', 'info');
    
    const [invitations, members] = await Promise.all([
      cachedLoadInvitations(),
      cachedLoadMembers()
    ]);
    
    // Get year-specific data
    let fees, collections, income, expenses;
    if (selectedYear === 'all') {
      fees = { docs: [] };
      collections = { docs: [] };
      income = { docs: [] };
      expenses = { docs: [] };
      
      // Aggregate all years data
      if (Object.keys(allYearsFeesData).length === 0) {
        await loadAllYearsFees();
      }
      if (Object.keys(allYearsVillageData).length === 0) {
        await loadAllYearsVillageCollections();
      }
      
      Object.values(allYearsFeesData).forEach(yearData => {
        Object.entries(yearData).forEach(([id, data]) => {
          fees.docs.push({ id, data: () => data });
        });
      });
      
      Object.values(allYearsVillageData).forEach(yearData => {
        Object.entries(yearData).forEach(([id, data]) => {
          collections.docs.push({ id, data: () => data });
        });
      });
    } else {
      [fees, collections, income, expenses] = await Promise.all([
        membershipFeesCollectionFor(selectedYear).get(),
        villageCollectionsCollectionFor(selectedYear).get(),
        incomeCollectionFor(selectedYear).get(),
        expenseCollectionFor(selectedYear).get()
      ]);
    }
    
    const data = {
      invitations: invitations.docs.map(doc => ({ id: doc.id, ...doc.data() })),
      members: members.docs.map(doc => ({ id: doc.id, ...doc.data() })),
      collections: collections.docs.map(doc => ({ id: doc.id, ...doc.data() })),
      fees: fees.docs.map(doc => ({ id: doc.id, ...doc.data() })),
      income: income.docs.map(doc => ({ id: doc.id, ...doc.data() })),
      expenses: expenses.docs.map(doc => ({ id: doc.id, ...doc.data() }))
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    downloadBlob(blob, `club-bornoporichoy-backup-${new Date().toISOString().split('T')[0]}.json`);
    
    showNotification('All data exported successfully!', 'success');
    addActivity('Data exported successfully', 'success');
  } catch (error) {
    showNotification('Export failed: ' + error.message, 'error');
    addActivity('Data export failed: ' + error.message, 'error');
  }
}

function downloadBlob(blob, filename) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

async function sendBulkReminders() {
  showNotification('Bulk reminder feature coming soon!', 'info');
  addActivity('Bulk reminders triggered', 'info');
}

async function generateReport() {
  showNotification('Report generation feature coming soon!', 'info');
  addActivity('Report generation triggered', 'info');
}

async function backupData() {
  showNotification('Auto backup feature coming soon!', 'info');
  addActivity('Backup triggered', 'info');
}

/* ---------------- Performance Optimizations ---------------- */
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

/* ---------------- UI elements ---------------- */
const loginBtn = document.getElementById("login-btn");
const logoutBtn = document.getElementById("logout-btn");
const userInfo = document.getElementById("user-info");
const mainContent = document.getElementById("main-content");
const authCard = document.getElementById("auth-card");

/* ---------------- Toast helpers ---------------- */
function showToast(msg, ttl=2500) {
  const container = document.getElementById('toast-container');
  if (!container) return;
  
  const t = document.createElement('div');
  t.className = 'toast';
  t.innerText = msg;
  container.appendChild(t);
  // show
  requestAnimationFrame(()=> t.classList.add('show'));
  setTimeout(()=> { t.classList.remove('show'); setTimeout(()=> container.removeChild(t), 300); }, ttl);
}

/* ---------------- Auth handlers ---------------- */
if (loginBtn) {
  loginBtn.addEventListener("click", () => {
    const email = document.getElementById("email").value.trim();
    const pw = document.getElementById("password").value;
    if(!email || !pw) return alert("Enter email and password");
    loginBtn.disabled = true;
    auth.signInWithEmailAndPassword(email,pw)
      .then(()=> {
        showToast("Logged in");
        addActivity('User logged in successfully', 'success');
        
        // Show global year selector after login
        const globalYearSelector = document.getElementById('global-year-selector');
        if (globalYearSelector) globalYearSelector.classList.remove('hidden');
        
        // Update year displays
        updateYearDisplays();
      })
      .catch(e => { 
        alert("Login error: "+e.message); 
        addActivity('Login failed: ' + e.message, 'error');
      })
      .finally(()=> loginBtn.disabled=false);
  });
}

if (logoutBtn) {
  logoutBtn.addEventListener("click", () => {
    logoutBtn.disabled = true;
    auth.signOut()
      .then(()=> {
        showToast("Logged out");
        addActivity('User logged out', 'info');
        cleanup();
      })
      .catch(e => {
        alert("Logout error: "+e.message);
        addActivity('Logout failed: ' + e.message, 'error');
      })
      .finally(()=> logoutBtn.disabled=false);
  });
}

/* auth state listener */
auth.onAuthStateChanged(user => {
  if(user){
    currentRole = ROLES[user.uid] || "viewer";
    // Show main content, hide auth card
    const authCard = document.getElementById("auth-card");
    const mainContent = document.getElementById("main-content");
    const logoutBtn = document.getElementById("logout-btn");
    const globalYearSelector = document.getElementById('global-year-selector');
    
    if (authCard) authCard.classList.add("hidden");
    if (mainContent) mainContent.classList.remove("hidden");
    if (logoutBtn) logoutBtn.classList.remove("hidden");
    if (globalYearSelector) globalYearSelector.classList.remove("hidden");
    
    const userInfo = document.getElementById("user-info");
    if (userInfo) userInfo.textContent = `${user.email} (${currentRole})`;
    
    applyRoleToUI();
    
    // Initialize everything with a slight delay to ensure DOM is ready
    setTimeout(() => { 
      loadAllData(); 
      loadFeeMembersDropdown(); 
      loadFeeYearlySummary(); 
      initLazyLoading(); // Initialize lazy loading
      updateSummaryCards(); 
      loadVillageBreakdown();
      updateYearDisplays();
      
      // Initialize enhanced features
      setupGlobalErrorHandlers();
      enhanceAccessibility();
      checkBrowserCompatibility();
      enhanceButtonsWithLoading();
      
      // CRITICAL: Initialize event listeners - FIXED
      initializeAllEventListeners();
      
      // Load financial data
      loadFinancialData();
      
      // Force refresh of dropdowns
      setTimeout(() => {
        loadFeeMembersDropdown();
        // Also trigger a test load if there are members
        const feeMemberSelect = document.getElementById('feeMemberSelect');
        if (feeMemberSelect && feeMemberSelect.options.length > 1) {
          feeMemberSelect.value = feeMemberSelect.options[1].value;
          loadMemberFeeData(feeMemberSelect.value);
        }
      }, 1000);
    }, 500);
  } else {
    // Show auth card, hide main content
    const authCard = document.getElementById("auth-card");
    const mainContent = document.getElementById("main-content");
    const logoutBtn = document.getElementById("logout-btn");
    const globalYearSelector = document.getElementById('global-year-selector');
    
    if (authCard) authCard.classList.remove("hidden");
    if (mainContent) mainContent.classList.add("hidden");
    if (logoutBtn) logoutBtn.classList.add("hidden");
    if (globalYearSelector) globalYearSelector.classList.add("hidden");
    
    const userInfo = document.getElementById("user-info");
    if (userInfo) userInfo.textContent = "";
    clearAllTables();
  }
});

/* ui role enforcement */
function applyRoleToUI(){
  ["add-inv-btn","add-mem-btn","loadMemberFeeBtn","saveFeeConfigBtn","clearFeeRecordBtn","show-paid-btn","exportCsvBtn","add-vc-btn"].forEach(id=>{
    const el=document.getElementById(id); 
    if(el) el.disabled = (currentRole !== "admin");
  });
}

/* helpers */
function escapeHtml(s){ return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

// Use debounced search for better performance
const debouncedFilterTable = debounce(filterTable, 300);

function filterTable(tableId, term){
  const table = document.getElementById(tableId);
  if (!table) return;
  
  const rows = table.querySelectorAll("tbody tr");
  const q = (term||"").toLowerCase();
  rows.forEach(r => {
    if (r) r.style.display = r.innerText.toLowerCase().includes(q) ? "" : "none";
  });
}

function clearAllTables(){
  ["invitation-table","members-table","monthly-summary-table","fee-months-table","fees-yearly-summary","vc-table","transactions-table"].forEach(id=>{
    const tb = document.getElementById(id)?.querySelector("tbody");
    if(tb) tb.innerHTML="";
  });
}

/* ---------------- Load all static data ---------------- */
function loadAllData(){
  loadInvitations();
  loadMembers();
  loadVillageCollections();
  updateMonthlySummary();
  updateSummaryCards();
  loadVillageBreakdown();
}

/* ---------------- Financial Tracking Functions ---------------- */

let currentTransactionType = 'income';

// Load financial data
async function loadFinancialData() {
  console.log('Loading financial data for year:', selectedYear);
  await loadTransactions();
  await loadBudgetData();
  updateFinancialSummary();
}

// Load transactions
async function loadTransactions() {
  const tbody = document.querySelector('#transactions-table tbody');
  if (!tbody) {
    console.error('Transactions table not found');
    return;
  }

  try {
    const targetYear = selectedYear === 'all' ? new Date().getFullYear() : selectedYear;
    const incomeSnap = await incomeCollectionFor(targetYear).orderBy('date', 'desc').get();
    const expenseSnap = await expenseCollectionFor(targetYear).orderBy('date', 'desc').get();
    
    tbody.innerHTML = '';
    let totalIncome = 0;
    let totalExpenses = 0;

    // Process income
    incomeSnap.forEach(doc => {
      const data = doc.data();
      totalIncome += data.amount || 0;
      addTransactionToTable(doc.id, data, 'income', tbody);
    });

    // Process expenses
    expenseSnap.forEach(doc => {
      const data = doc.data();
      totalExpenses += data.amount || 0;
      addTransactionToTable(doc.id, data, 'expense', tbody);
    });

    // Update table totals
    safeSetTextContent('table-total-income', `‚Çπ${totalIncome.toLocaleString()}`);
    safeSetTextContent('table-total-expenses', `‚Çπ${totalExpenses.toLocaleString()}`);
    safeSetTextContent('table-net-balance', `‚Çπ${(totalIncome - totalExpenses).toLocaleString()}`);

  } catch (error) {
    console.error('Error loading transactions:', error);
    showNotification('Error loading transactions: ' + error.message, 'error');
  }
}

// Add transaction to table
function addTransactionToTable(id, data, type, tbody) {
  const tr = document.createElement('tr');
  const isIncome = type === 'income';
  
  tr.innerHTML = `
    <td>${data.date ? new Date(data.date.seconds * 1000).toLocaleDateString() : ''}</td>
    <td>
      <span class="badge ${isIncome ? 'ok' : 'warn'}">
        ${isIncome ? 'üí∞ Income' : 'üí∏ Expense'}
      </span>
    </td>
    <td>${data.category || 'Uncategorized'}</td>
    <td>${escapeHtml(data.description || '')}</td>
    <td style="color: ${isIncome ? '#28a745' : '#dc3545'}; font-weight: bold;">
      ${isIncome ? '+' : '-'}‚Çπ${(data.amount || 0).toLocaleString()}
    </td>
    <td>${data.paymentMode || 'Cash'}</td>
    <td></td>
  `;

  // Add action buttons for admin
  if (currentRole === 'admin') {
    const actionsTd = tr.querySelector('td:last-child');
    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = 'Delete';
    deleteBtn.className = 'btn small ghost';
    deleteBtn.onclick = () => deleteTransaction(id, type);
    actionsTd.appendChild(deleteBtn);
  }

  tbody.appendChild(tr);
}

// Delete transaction
async function deleteTransaction(id, type) {
  if (!confirm('Are you sure you want to delete this transaction?')) return;

  try {
    const targetYear = selectedYear === 'all' ? new Date().getFullYear() : selectedYear;
    const collection = type === 'income' ? incomeCollectionFor(targetYear) : expenseCollectionFor(targetYear);
    await collection.doc(id).delete();
    showNotification('Transaction deleted successfully', 'success');
    loadFinancialData();
  } catch (error) {
    showNotification('Error deleting transaction: ' + error.message, 'error');
  }
}

// Update financial summary
async function updateFinancialSummary() {
  try {
    const targetYear = selectedYear === 'all' ? new Date().getFullYear() : selectedYear;
    const incomeSnap = await incomeCollectionFor(targetYear).get();
    const expenseSnap = await expenseCollectionFor(targetYear).get();
    
    let totalIncome = 0;
    let totalExpenses = 0;

    incomeSnap.forEach(doc => {
      totalIncome += doc.data().amount || 0;
    });

    expenseSnap.forEach(doc => {
      totalExpenses += doc.data().amount || 0;
    });

    const netBalance = totalIncome - totalExpenses;
    const totalBudget = Object.values(BUDGET_ITEMS).reduce((a, b) => a + b, 0);
    const budgetUtilization = totalBudget > 0 ? (totalExpenses / totalBudget) * 100 : 0;

    safeSetTextContent('total-income', `‚Çπ${totalIncome.toLocaleString()}`);
    safeSetTextContent('total-expenses', `‚Çπ${totalExpenses.toLocaleString()}`);
    safeSetTextContent('net-balance', `‚Çπ${netBalance.toLocaleString()}`);
    safeSetTextContent('budget-utilization', `${budgetUtilization.toFixed(1)}%`);

  } catch (error) {
    console.error('Error updating financial summary:', error);
  }
}

// Show transaction modal
function showTransactionModal(type = 'income') {
  currentTransactionType = type;
  const modal = document.getElementById('transactionModal');
  const title = document.getElementById('transactionModalTitle');
  const categorySelect = document.getElementById('transaction-category');
  const dateInput = document.getElementById('transaction-date');
  
  if (!modal || !title || !categorySelect || !dateInput) return;
  
  // Set modal title
  title.textContent = type === 'income' ? 'üí∞ Add Income' : 'üí∏ Add Expense';
  
  // Populate categories
  const categories = type === 'income' ? INCOME_CATEGORIES : EXPENSE_CATEGORIES;
  categorySelect.innerHTML = categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
  
  // Set default date to today
  dateInput.value = new Date().toISOString().split('T')[0];
  
  // Clear other fields
  document.getElementById('transaction-amount').value = '';
  document.getElementById('transaction-payment-mode').value = 'Cash';
  document.getElementById('transaction-description').value = '';
  
  modal.classList.remove('hidden');
}

// Close transaction modal
function closeTransactionModal() {
  const modal = document.getElementById('transactionModal');
  if (modal) {
    modal.classList.add('hidden');
  }
}

// Save transaction
async function saveTransaction() {
  const amount = parseFloat(document.getElementById('transaction-amount').value);
  const date = document.getElementById('transaction-date').value;
  const category = document.getElementById('transaction-category').value;
  const paymentMode = document.getElementById('transaction-payment-mode').value;
  const description = document.getElementById('transaction-description').value;

  if (!amount || amount <= 0) {
    showNotification('Please enter a valid amount', 'error');
    return;
  }

  if (!date) {
    showNotification('Please select a date', 'error');
    return;
  }

  try {
    const targetYear = selectedYear === 'all' ? new Date().getFullYear() : selectedYear;
    const collection = currentTransactionType === 'income' ? incomeCollectionFor(targetYear) : expenseCollectionFor(targetYear);
    
    await collection.add({
      amount: amount,
      date: firebase.firestore.Timestamp.fromDate(new Date(date)),
      category: category,
      paymentMode: paymentMode,
      description: description,
      createdBy: auth.currentUser.uid,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    showNotification(`${currentTransactionType === 'income' ? 'Income' : 'Expense'} added successfully`, 'success');
    closeTransactionModal();
    loadFinancialData();
    
  } catch (error) {
    showNotification('Error saving transaction: ' + error.message, 'error');
  }
}

// Load budget data
async function loadBudgetData() {
  const budgetContainer = document.getElementById('budget-cards-container');
  if (!budgetContainer) return;

  try {
    const targetYear = selectedYear === 'all' ? new Date().getFullYear() : selectedYear;
    const expenseSnap = await expenseCollectionFor(targetYear).get();
    const categoryExpenses = {};
    const actualExpenses = [];

    // Calculate actual expenses by category
    expenseSnap.forEach(doc => {
      const data = doc.data();
      const category = data.category || 'Miscellaneous';
      categoryExpenses[category] = (categoryExpenses[category] || 0) + (data.amount || 0);
    });

    // Create budget cards
    budgetContainer.innerHTML = Object.entries(BUDGET_ITEMS)
      .map(([category, budget]) => {
        const actual = categoryExpenses[category] || 0;
        const percentage = budget > 0 ? (actual / budget) * 100 : 0;
        let statusClass = 'good';
        if (percentage > 100) statusClass = 'over-budget';
        else if (percentage > 80) statusClass = 'warning';

        actualExpenses.push(actual);

        return `
          <div class="budget-card ${statusClass}">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
              <strong>${category}</strong>
              <span style="color: ${percentage > 100 ? '#dc3545' : percentage > 80 ? '#ffc107' : '#28a745'}; font-weight: bold;">
                ${percentage.toFixed(1)}%
              </span>
            </div>
            <div class="progress-bar" style="height: 8px; background: #f0f0f0; border-radius: 4px; margin-bottom: 8px;">
              <div class="progress-fill" style="height: 100%; background: ${percentage > 100 ? '#dc3545' : percentage > 80 ? '#ffc107' : '#28a745'}; width: ${Math.min(percentage, 100)}%; border-radius: 4px;"></div>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--muted);">
              <span>Actual: ‚Çπ${actual.toLocaleString()}</span>
              <span>Budget: ‚Çπ${budget.toLocaleString()}</span>
            </div>
            <div style="font-size: 11px; color: ${percentage > 100 ? '#dc3545' : percentage > 80 ? '#ffc107' : '#28a745'}; margin-top: 5px;">
              ${percentage > 100 ? '‚ö†Ô∏è Over budget' : percentage > 80 ? '‚ö†Ô∏è Approaching limit' : '‚úÖ Within budget'}
            </div>
          </div>
        `;
      }).join('');

    // Update budget chart
    if (budgetChart) {
      budgetChart.data.datasets[1].data = actualExpenses;
      budgetChart.update();
    }

  } catch (error) {
    console.error('Error loading budget data:', error);
  }
}

// Generate financial report
async function generateFinancialReport() {
  try {
    const targetYear = selectedYear === 'all' ? new Date().getFullYear() : selectedYear;
    const incomeSnap = await incomeCollectionFor(targetYear).get();
    const expenseSnap = await expenseCollectionFor(targetYear).get();

    let report = `CLUB BORNOPORICHOY - FINANCIAL REPORT ${targetYear}\n`;
    report += `Generated on: ${new Date().toLocaleDateString()}\n`;
    report += `Total Budget: ‚Çπ${Object.values(BUDGET_ITEMS).reduce((a, b) => a + b, 0).toLocaleString()}\n\n`;

    // Income Summary
    report += `INCOME SUMMARY\n`;
    report += `${'='.repeat(50)}\n`;
    
    const incomeByCategory = {};
    let totalIncome = 0;

    incomeSnap.forEach(doc => {
      const data = doc.data();
      const category = data.category || 'Uncategorized';
      incomeByCategory[category] = (incomeByCategory[category] || 0) + (data.amount || 0);
      totalIncome += data.amount || 0;
    });

    Object.entries(incomeByCategory).forEach(([category, amount]) => {
      report += `${category.padEnd(25)}: ‚Çπ${amount.toLocaleString()}\n`;
    });
    report += `\nTotal Income: ‚Çπ${totalIncome.toLocaleString()}\n\n`;

    // Expense Summary
    report += `EXPENSE SUMMARY\n`;
    report += `${'='.repeat(50)}\n`;
    
    const expenseByCategory = {};
    let totalExpenses = 0;

    expenseSnap.forEach(doc => {
      const data = doc.data();
      const category = data.category || 'Uncategorized';
      expenseByCategory[category] = (expenseByCategory[category] || 0) + (data.amount || 0);
      totalExpenses += data.amount || 0;
    });

    Object.entries(expenseByCategory).forEach(([category, amount]) => {
      const budget = BUDGET_ITEMS[category] || 0;
      const percentage = budget > 0 ? (amount / budget) * 100 : 0;
      report += `${category.padEnd(25)}: ‚Çπ${amount.toLocaleString()} / ‚Çπ${budget.toLocaleString()} (${percentage.toFixed(1)}%)\n`;
    });
    report += `\nTotal Expenses: ‚Çπ${totalExpenses.toLocaleString()}\n\n`;

    // Net Summary
    report += `NET SUMMARY\n`;
    report += `${'='.repeat(50)}\n`;
    const netBalance = totalIncome - totalExpenses;
    report += `Net Balance: ‚Çπ${netBalance.toLocaleString()}\n`;
    report += `Budget Utilization: ${((totalExpenses / Object.values(BUDGET_ITEMS).reduce((a, b) => a + b, 0)) * 100).toFixed(1)}%\n`;

    // Budget Status
    report += `\nBUDGET STATUS\n`;
    report += `${'='.repeat(50)}\n`;
    Object.entries(BUDGET_ITEMS).forEach(([category, budget]) => {
      const actual = expenseByCategory[category] || 0;
      const percentage = budget > 0 ? (actual / budget) * 100 : 0;
      const status = percentage > 100 ? 'OVER BUDGET' : percentage > 80 ? 'WARNING' : 'OK';
      report += `${category.padEnd(25)}: ${status.padEnd(12)} (${percentage.toFixed(1)}%)\n`;
    });

    // Download report
    const blob = new Blob([report], { type: 'text/plain' });
    downloadBlob(blob, `financial-report-${targetYear}.txt`);

    showNotification('Financial report generated successfully', 'success');
    addActivity('Generated financial report', 'success');

  } catch (error) {
    showNotification('Error generating financial report: ' + error.message, 'error');
    addActivity('Failed to generate financial report: ' + error.message, 'error');
  }
}

// Filter transactions
function filterTransactions() {
  const typeFilter = document.getElementById('filter-transaction-type').value;
  const categoryFilter = document.getElementById('filter-transaction-category').value;
  const fromDate = document.getElementById('filter-transaction-from').value;
  const toDate = document.getElementById('filter-transaction-to').value;

  // Implementation for filtering transactions
  // This would filter the displayed transactions based on the selected criteria
  console.log('Filtering transactions:', { typeFilter, categoryFilter, fromDate, toDate });
  showNotification('Filter functionality coming soon!', 'info');
}

/* ---------------- ENHANCED INVITATIONS MANAGEMENT ---------------- */
let editingInvitationId = null;

// Enhanced load invitations function with edit capabilities
async function loadInvitations(){
  const tbody = document.querySelector("#invitation-table tbody");
  if (!tbody) {
    console.error("Invitations table body not found");
    return;
  }
  
  tbody.innerHTML = "";
  try {
    const snapshot = await cachedLoadInvitations();
    let total=0, sent=0;
    
    snapshot.forEach(doc => {
      total++;
      const d = doc.data();
      if(d.sent) sent++;
      
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(d.name||"")}</td>
        <td>${escapeHtml(d.village||"")}</td>
        <td>${escapeHtml(d.mobile||"")}</td>
        <td>${escapeHtml(d.remarks||"")}</td>
        <td class="center">${d.sent?'<span class="badge ok">Sent</span>':'<span class="badge warn">Pending</span>'}</td>
        <td>${d.dateAdded && d.dateAdded.toDate ? d.dateAdded.toDate().toLocaleDateString() : ""}</td>
        <td style="white-space: nowrap;"></td>
      `;
      tbody.appendChild(tr);

      const actionsTd = tr.querySelector("td:last-child");
      if(currentRole==="admin"){
        // Edit button
        const editBtn = document.createElement("button");
        editBtn.textContent = "‚úèÔ∏è Edit";
        editBtn.className = "btn small secondary";
        editBtn.style.marginRight = "5px";
        editBtn.onclick = () => showEditInvitationModal(doc.id, d);
        actionsTd.appendChild(editBtn);

        // Toggle sent status button
        const toggleBtn = document.createElement("button");
        toggleBtn.textContent = d.sent ? "‚Ü∂ Mark Pending" : "‚úì Mark Sent";
        toggleBtn.className = "btn small";
        toggleBtn.style.marginRight = "5px";
        toggleBtn.onclick = () => toggleInvitationStatus(doc.id, d.sent, d.name);
        actionsTd.appendChild(toggleBtn);

        // Delete button
        const delBtn = document.createElement("button");
        delBtn.textContent = "üóëÔ∏è Delete";
        delBtn.className = "btn small ghost";
        delBtn.onclick = () => deleteInvitation(doc.id, d.name);
        actionsTd.appendChild(delBtn);
        
      } else {
        actionsTd.innerHTML = '<span class="muted">View only</span>';
      }
    });
  } catch(e){
    console.error("Load invitations error:", e);
    alert("Failed to load invitations: " + (e.message || e));
  }
}

// Show edit invitation modal
function showEditInvitationModal(invitationId, invitationData) {
  editingInvitationId = invitationId;
  
  let modal = document.getElementById('editInvitationModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'editInvitationModal';
    modal.className = 'modal-overlay';
    modal.innerHTML = `
      <div class="modal-content">
        <div class="modal-header">
          <h3>‚úèÔ∏è Edit Invitation</h3>
          <button class="modal-close" onclick="closeEditInvitationModal()">&times;</button>
        </div>
        <div style="display: grid; gap: 15px; margin-top: 15px;">
          <div>
            <label class="muted">Name *</label>
            <input type="text" id="edit-inv-name" placeholder="Name" style="width: 100%;">
          </div>
          <div>
            <label class="muted">Village *</label>
            <input type="text" id="edit-inv-village" placeholder="Village" style="width: 100%;">
          </div>
          <div>
            <label class="muted">Mobile</label>
            <input type="text" id="edit-inv-mobile" placeholder="Mobile Number" style="width: 100%;">
          </div>
          <div>
            <label class="muted">Remarks</label>
            <textarea id="edit-inv-remarks" placeholder="Remarks" style="width: 100%; min-height: 80px;"></textarea>
          </div>
          <div>
            <label class="muted">Status</label>
            <select id="edit-inv-sent" style="width: 100%;">
              <option value="false">Pending</option>
              <option value="true">Sent</option>
            </select>
          </div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button class="btn" onclick="saveInvitationEdit()">üíæ Save Changes</button>
          <button class="btn ghost" onclick="closeEditInvitationModal()">‚ùå Cancel</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }
  
  // Populate form with current data
  document.getElementById('edit-inv-name').value = invitationData.name || '';
  document.getElementById('edit-inv-village').value = invitationData.village || '';
  document.getElementById('edit-inv-mobile').value = invitationData.mobile || '';
  document.getElementById('edit-inv-remarks').value = invitationData.remarks || '';
  document.getElementById('edit-inv-sent').value = invitationData.sent ? 'true' : 'false';
  
  modal.classList.remove('hidden');
}

// Close edit invitation modal
function closeEditInvitationModal() {
  const modal = document.getElementById('editInvitationModal');
  if (modal) {
    modal.classList.add('hidden');
  }
  editingInvitationId = null;
}

// Save invitation edits
async function saveInvitationEdit() {
  if (!editingInvitationId) return;
  
  const name = document.getElementById('edit-inv-name').value.trim();
  const village = document.getElementById('edit-inv-village').value.trim();
  const mobile = document.getElementById('edit-inv-mobile').value.trim();
  const remarks = document.getElementById('edit-inv-remarks').value.trim();
  const sent = document.getElementById('edit-inv-sent').value === 'true';
  
  if (!name || !village) {
    showNotification('Name and Village are required', 'error');
    return;
  }
  
  try {
    await invitationCol.doc(editingInvitationId).update({
      name,
      village,
      mobile,
      remarks,
      sent,
      lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    showNotification('Invitation updated successfully', 'success');
    addActivity(`Updated invitation for ${name}`, 'success');
    closeEditInvitationModal();
    loadInvitations();
    updateSummaryCards();
    
  } catch (error) {
    console.error('Error updating invitation:', error);
    showNotification('Error updating invitation: ' + error.message, 'error');
  }
}

// Toggle invitation status
async function toggleInvitationStatus(invitationId, currentStatus, name) {
  try {
    await invitationCol.doc(invitationId).update({
      sent: !currentStatus,
      lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    showNotification(`Invitation marked as ${!currentStatus ? 'Sent' : 'Pending'}`, 'success');
    addActivity(`Updated invitation status for ${name}`, 'info');
    loadInvitations();
    updateSummaryCards();
    
  } catch (error) {
    console.error('Error toggling invitation status:', error);
    showNotification('Error updating invitation status: ' + error.message, 'error');
  }
}

// Delete invitation
async function deleteInvitation(invitationId, name) {
  if (!confirm(`Are you sure you want to delete invitation for ${name}?`)) return;
  
  try {
    await invitationCol.doc(invitationId).delete();
    showToast("Deleted"); 
    addActivity(`Deleted invitation for ${name}`, 'info');
    loadInvitations(); 
    updateSummaryCards();
  } catch (error) {
    console.error('Error deleting invitation:', error);
    alert("Delete failed: " + (error.message || error));
  }
}

// Add invitation event listener
const addInvBtn = document.getElementById("add-inv-btn");
if (addInvBtn) {
  addInvBtn.addEventListener("click", async () => {
    if(currentRole !== "admin") return alert("Only admin can add");
    const name = document.getElementById("inv-name").value.trim();
    const village = document.getElementById("inv-village").value.trim();
    const mobile = document.getElementById("inv-mobile").value.trim();
    const remarks = document.getElementById("inv-remarks").value.trim();
    if(!name || !village) return alert("Name & Village required");
    try {
      let dupQuery = invitationCol.where("name","==",name);
      if(mobile) dupQuery = dupQuery.where("mobile","==",mobile);
      const dup = await dupQuery.get();
      if(!dup.empty && !confirm("Possible duplicate found. Add anyway?")) return;
      await invitationCol.add({
        name, village, mobile, remarks,
        sent: false,
        dateAdded: firebase.firestore.FieldValue.serverTimestamp()
      });
      ["inv-name","inv-village","inv-mobile","inv-remarks"].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.value = "";
      });
      showToast("Invitation added");
      addActivity(`Added invitation for ${name} from ${village}`, 'success');
      loadInvitations();
      updateSummaryCards();
    } catch(err){
      console.error("Add invitation error:", err);
      alert("Failed to add invitation: " + (err.message || err));
      addActivity(`Failed to add invitation: ${err.message}`, 'error');
    }
  });
}

// Use debounced search
const searchInvite = document.getElementById("search-invite");
if (searchInvite) {
  searchInvite.addEventListener("input",(e)=> debouncedFilterTable("invitation-table", e.target.value));
}

/* ---------------- ENHANCED MEMBERS MANAGEMENT ---------------- */
let editingMemberId = null;

// Enhanced load members function with edit capabilities
async function loadMembers() {
  const tbody = document.querySelector("#members-table tbody");
  if (!tbody) {
    console.error("Members table body not found");
    return;
  }
  
  tbody.innerHTML = "";
  try {
    const snapshot = await cachedLoadMembers();
    let total = 0;
    
    snapshot.forEach(doc => {
      total++;
      const d = doc.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(d.name||"")}</td>
        <td>${escapeHtml(d.village||"")}</td>
        <td>${escapeHtml(d.mobile||"")}</td>
        <td>${escapeHtml(d.remarks||"")}</td>
        <td>${d.dateAdded && d.dateAdded.toDate ? d.dateAdded.toDate().toLocaleDateString() : ""}</td>
        <td style="white-space: nowrap;"></td>
      `;
      tbody.appendChild(tr);

      const actionsTd = tr.querySelector("td:last-child");
      if(currentRole==="admin"){
        // Edit button
        const editBtn = document.createElement("button"); 
        editBtn.textContent = "‚úèÔ∏è Edit"; 
        editBtn.className = "btn small secondary";
        editBtn.style.marginRight = "5px";
        editBtn.onclick = () => showEditMemberModal(doc.id, d);
        actionsTd.appendChild(editBtn);

        // Delete button
        const delBtn = document.createElement("button"); 
        delBtn.textContent = "üóëÔ∏è Delete"; 
        delBtn.className = "btn small ghost";
        delBtn.onclick = () => { 
          if(confirm("Delete member?")) doc.ref.delete().then(() => { 
            showToast("Deleted"); 
            addActivity(`Deleted member ${d.name}`, 'info');
            loadMembers(); 
            loadFeeMembersDropdown();
            updateSummaryCards();
          }); 
        };
        actionsTd.appendChild(delBtn);
      } else {
        // View-only mode for non-admins
        actionsTd.innerHTML = '<span class="muted">View only</span>';
      }
    });
    
    updateSummaryCards();
  } catch(e){
    console.error("Load members error:", e);
    alert("Failed to load members: " + (e.message || e));
  }
}

// Show edit member modal
function showEditMemberModal(memberId, memberData) {
  editingMemberId = memberId;
  
  // Create or show modal
  let modal = document.getElementById('editMemberModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'editMemberModal';
    modal.className = 'modal-overlay';
    modal.innerHTML = `
      <div class="modal-content">
        <div class="modal-header">
          <h3>‚úèÔ∏è Edit Member</h3>
          <button class="modal-close" onclick="closeEditMemberModal()">&times;</button>
        </div>
        <div style="display: grid; gap: 15px; margin-top: 15px;">
          <div>
            <label class="muted">Name *</label>
            <input type="text" id="edit-mem-name" placeholder="Member Name" style="width: 100%;">
          </div>
          <div>
            <label class="muted">Village *</label>
            <input type="text" id="edit-mem-village" placeholder="Village" style="width: 100%;">
          </div>
          <div>
            <label class="muted">Mobile</label>
            <input type="text" id="edit-mem-mobile" placeholder="Mobile Number" style="width: 100%;">
          </div>
          <div>
            <label class="muted">Remarks</label>
            <textarea id="edit-mem-remarks" placeholder="Remarks" style="width: 100%; min-height: 80px;"></textarea>
          </div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button class="btn" onclick="saveMemberEdit()">üíæ Save Changes</button>
          <button class="btn ghost" onclick="closeEditMemberModal()">‚ùå Cancel</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }
  
  // Populate form with current data
  document.getElementById('edit-mem-name').value = memberData.name || '';
  document.getElementById('edit-mem-village').value = memberData.village || '';
  document.getElementById('edit-mem-mobile').value = memberData.mobile || '';
  document.getElementById('edit-mem-remarks').value = memberData.remarks || '';
  
  modal.classList.remove('hidden');
}

// Close edit member modal
function closeEditMemberModal() {
  const modal = document.getElementById('editMemberModal');
  if (modal) {
    modal.classList.add('hidden');
  }
  editingMemberId = null;
}

// Save member edits
async function saveMemberEdit() {
  if (!editingMemberId) return;
  
  const name = document.getElementById('edit-mem-name').value.trim();
  const village = document.getElementById('edit-mem-village').value.trim();
  const mobile = document.getElementById('edit-mem-mobile').value.trim();
  const remarks = document.getElementById('edit-mem-remarks').value.trim();
  
  if (!name || !village) {
    showNotification('Name and Village are required', 'error');
    return;
  }
  
  try {
    await membersCol.doc(editingMemberId).update({
      name,
      village,
      mobile,
      remarks,
      lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    showNotification('Member updated successfully', 'success');
    addActivity(`Updated member: ${name}`, 'success');
    closeEditMemberModal();
    loadMembers();
    loadFeeMembersDropdown();
    
  } catch (error) {
    console.error('Error updating member:', error);
    showNotification('Error updating member: ' + error.message, 'error');
  }
}

// Add member event listener
const addMemBtn = document.getElementById("add-mem-btn");
if (addMemBtn) {
  addMemBtn.addEventListener("click", async () => {
    if(currentRole !== "admin") return alert("Only admin can add");
    const name = document.getElementById("mem-name").value.trim();
    const village = document.getElementById("mem-village").value.trim();
    const mobile = document.getElementById("mem-mobile").value.trim();
    const remarks = document.getElementById("mem-remarks").value.trim();
    if(!name || !village) return alert("Name & Village required");
    try {
      let dupQuery = membersCol.where("name","==",name);
      if(mobile) dupQuery = dupQuery.where("mobile","==",mobile);
      const dup = await dupQuery.get();
      if(!dup.empty && !confirm("Possible duplicate found. Add anyway?")) return;
      await membersCol.add({
        name, village, mobile, remarks,
        dateAdded: firebase.firestore.FieldValue.serverTimestamp()
      });
      ["mem-name","mem-village","mem-mobile","mem-remarks"].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.value = "";
      });
      showToast("Member added");
      addActivity(`Added member ${name} from ${village}`, 'success');
      loadMembers();
      loadFeeMembersDropdown();
      updateSummaryCards();
    } catch(err){
      console.error("Add member error:", err);
      alert("Failed to add member: " + (err.message || err));
      addActivity(`Failed to add member: ${err.message}`, 'error');
    }
  });
}

// Search members
const searchMembers = document.getElementById("search-members");
if (searchMembers) {
  searchMembers.addEventListener("input",(e)=> debouncedFilterTable("members-table", e.target.value));
}

/* ---------------- LOAD FEE MEMBERS DROPDOWN ---------------- */
async function loadFeeMembersDropdown() {
  const select = document.getElementById("feeMemberSelect");
  const vcCollectorSelect = document.getElementById("vc-collector"); // Village collection dropdown
  
  if (!select) return;
  
  select.innerHTML = '<option value="">-- Select member --</option>';
  if (vcCollectorSelect) {
    vcCollectorSelect.innerHTML = '<option value="">-- Select Collector --</option>';
  }
  
  try {
    const snapshot = await cachedLoadMembers();
    
    if (snapshot.empty) {
      console.log("No members found in database");
      return;
    }
    
    // Create a map to store member names by ID for quick lookup
    window.memberNamesMap = {};
    
    snapshot.forEach(doc => {
      const d = doc.data();
      const displayText = `${d.name} (${d.village})`;
      
      // Store in global map for later lookup
      window.memberNamesMap[doc.id] = d.name;
      
      // Add to fee member dropdown
      const option = document.createElement("option");
      option.value = doc.id;
      option.textContent = displayText;
      select.appendChild(option);
      
      // Also add to village collection collector dropdown
      if (vcCollectorSelect) {
        const collectorOption = document.createElement("option");
        collectorOption.value = doc.id;
        collectorOption.textContent = displayText;
        vcCollectorSelect.appendChild(collectorOption);
      }
    });
    
    console.log(`Loaded ${snapshot.size} members into dropdowns`);
  } catch(e) {
    console.error("Load fee members dropdown error:", e);
    showNotification('Error loading members dropdown: ' + e.message, 'error');
  }
}

/* ---------------- MEMBERSHIP FEES FUNCTIONALITY ---------------- */

// Initialize membership fees event listeners - FIXED VERSION
function initMembershipFeesEvents() {
  console.log('Initializing membership fees events...');
  
  // Load member fee data when member is selected
  const feeMemberSelect = document.getElementById('feeMemberSelect');
  if (feeMemberSelect) {
    feeMemberSelect.addEventListener('change', function() {
      console.log('Member selected:', this.value);
      loadMemberFeeData(this.value);
    });
  }

  // Load button
  const loadMemberFeeBtn = document.getElementById('loadMemberFeeBtn');
  if (loadMemberFeeBtn) {
    loadMemberFeeBtn.addEventListener('click', function() {
      const memberSelect = document.getElementById('feeMemberSelect');
      if (memberSelect && memberSelect.value) {
        console.log('Load button clicked for member:', memberSelect.value);
        loadMemberFeeData(memberSelect.value);
      } else {
        showNotification('Please select a member first', 'error');
      }
    });
  }

  // Save config button
  const saveFeeConfigBtn = document.getElementById('saveFeeConfigBtn');
  if (saveFeeConfigBtn) {
    saveFeeConfigBtn.addEventListener('click', saveFeeConfiguration);
  }

  // Clear record button
  const clearFeeRecordBtn = document.getElementById('clearFeeRecordBtn');
  if (clearFeeRecordBtn) {
    clearFeeRecordBtn.addEventListener('click', clearFeeRecord);
  }

  // Export CSV button
  const exportCsvBtn = document.getElementById('exportCsvBtn');
  if (exportCsvBtn) {
    exportCsvBtn.addEventListener('click', exportFeesCSV);
  }

  // Show paid members button
  const showPaidBtn = document.getElementById("show-paid-btn");
  if (showPaidBtn) {
    showPaidBtn.addEventListener("click", loadPaidMembersTracker);
  }

  // Clear paid view button
  const clearPaidView = document.getElementById("clear-paid-view");
  if (clearPaidView) {
    clearPaidView.addEventListener("click", () => {
      const container = document.getElementById("paid-members-list");
      const countSpan = document.getElementById("paid-tracker-count");
      if (container) container.innerHTML = "<p>Click 'Show Paid Members' to load data</p>";
      if (countSpan) countSpan.textContent = "Loaded: 0";
    });
  }

  console.log('Membership fees events initialized successfully');
}

// Load member fee data when a member is selected - FIXED VERSION
async function loadMemberFeeData(memberId) {
  console.log('Loading fee data for member:', memberId);
  
  if (!memberId) {
    const tbody = document.getElementById('fee-months-table')?.querySelector('tbody');
    if (tbody) tbody.innerHTML = '';
    const summaryEl = document.getElementById('fee-member-summary');
    if (summaryEl) summaryEl.textContent = 'Select member to load fees';
    return;
  }

  try {
    const memberDoc = await membersCol.doc(memberId).get();
    if (!memberDoc.exists) {
      showNotification('Member not found', 'error');
      return;
    }

    const memberData = memberDoc.data();
    const feeAmount = parseInt(document.getElementById('feeAmountInput').value) || 100;
    
    // Get fee record
    const targetYear = selectedYear === 'all' ? new Date().getFullYear() : selectedYear;
    const feesCol = membershipFeesCollectionFor(targetYear);
    const feeDoc = await feesCol.doc(memberId).get();
    
    let feeData = {};
    let needsMigration = false;
    
    if (feeDoc.exists) {
      feeData = feeDoc.data();
      console.log('Found existing fee data:', feeData);
      
      // Check if data uses old structure (nested months object)
      if (feeData.months && typeof feeData.months === 'object') {
        console.log('Detected OLD data structure, migrating to new structure...');
        needsMigration = true;
        feeData = migrateToNewStructure(feeData, memberId, memberData, feeAmount);
        
        // Save migrated data back to Firestore
        await feesCol.doc(memberId).set(feeData);
        console.log('Data migrated to new structure');
      }
    } else {
      // Initialize with default data using the NEW structure
      feeData = {
        memberId: memberId,
        memberName: memberData.name,
        memberVillage: memberData.village,
        monthlyFee: feeAmount,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      // Initialize all months as unpaid using NEW structure
      MONTHS.forEach(month => {
        feeData[month] = {
          paid: false,
          paidOn: null,
          amount: feeAmount
        };
      });
      
      // Save the initial structure to Firestore
      await feesCol.doc(memberId).set(feeData);
      console.log('Created new fee record for member:', memberId);
    }

    // Update the table
    updateFeeTable(memberData, feeData, feeAmount);
    
  } catch (error) {
    console.error('Error loading member fee data:', error);
    showNotification('Error loading fee data: ' + error.message, 'error');
  }
}

// Migrate from old structure to new structure
function migrateToNewStructure(oldData, memberId, memberData, feeAmount) {
  const newData = {
    memberId: memberId,
    memberName: memberData.name || oldData.memberName,
    memberVillage: memberData.village || oldData.memberVillage,
    monthlyFee: oldData.feeAmount || feeAmount,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  
  // Migrate months data from old structure to new structure
  MONTHS.forEach(month => {
    const oldMonthData = oldData.months && oldData.months[month];
    if (oldMonthData) {
      newData[month] = {
        paid: oldMonthData.paid || false,
        paidOn: oldMonthData.paidAt || null,
        amount: oldMonthData.amount || oldData.feeAmount || feeAmount
      };
    } else {
      newData[month] = {
        paid: false,
        paidOn: null,
        amount: oldData.feeAmount || feeAmount
      };
    }
  });
  
  return newData;
}

// Enhanced updateFeeTable function with better debugging
function updateFeeTable(memberData, feeData, feeAmount) {
  const tbody = document.getElementById('fee-months-table').querySelector('tbody');
  if (!tbody) {
    console.error('Fee months table tbody not found');
    return;
  }
  
  tbody.innerHTML = '';
  
  let paidMonths = 0;
  let totalPaid = 0;

  console.log('Updating fee table with data:', feeData);

  MONTHS.forEach(month => {
    // Handle both old and new data structures
    let monthData;
    if (feeData[month]) {
      // New structure: direct month properties
      monthData = feeData[month];
    } else if (feeData.months && feeData.months[month]) {
      // Old structure: nested months object
      monthData = feeData.months[month];
    } else {
      // Default structure
      monthData = { paid: false, paidOn: null, amount: feeAmount };
    }
    
    const isPaid = monthData.paid === true;
    
    if (isPaid) {
      paidMonths++;
      totalPaid += monthData.amount || feeAmount;
    }

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="font-weight: bold;">${month}</td>
      <td>
        <span class="badge ${isPaid ? 'ok' : 'warn'}">
          ${isPaid ? 'Paid' : 'Pending'}
        </span>
      </td>
      <td>${monthData.paidOn ? new Date(monthData.paidOn.seconds * 1000).toLocaleDateString() : '-'}</td>
      <td class="center"></td>
    `;

    // Add toggle button for admin
    const toggleTd = tr.querySelector('td:last-child');
    if (currentRole === 'admin') {
      const toggleBtn = document.createElement('button');
      toggleBtn.textContent = isPaid ? 'Mark Unpaid' : 'Mark Paid';
      toggleBtn.className = 'btn small';
      toggleBtn.onclick = () => togglePaymentStatus(feeData.memberId, month, !isPaid, feeAmount);
      toggleTd.appendChild(toggleBtn);
    }

    tbody.appendChild(tr);
  });

  // Update summary
  const summaryText = `${memberData.name} - ${paidMonths}/12 months paid (‚Çπ${totalPaid})`;
  const summaryEl = document.getElementById('fee-member-summary');
  if (summaryEl) {
    summaryEl.textContent = summaryText;
  }
  
  console.log(`Updated table: ${paidMonths} paid months, total ‚Çπ${totalPaid}`);
}

// Enhanced togglePaymentStatus function
async function togglePaymentStatus(memberId, month, paid, amount) {
  try {
    const targetYear = selectedYear === 'all' ? new Date().getFullYear() : selectedYear;
    const feesCol = membershipFeesCollectionFor(targetYear);
    
    const updateData = {
      [`${month}.paid`]: paid,
      [`${month}.amount`]: amount,
      monthlyFee: amount,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    if (paid) {
      updateData[`${month}.paidOn`] = firebase.firestore.FieldValue.serverTimestamp();
    } else {
      updateData[`${month}.paidOn`] = null;
    }

    await feesCol.doc(memberId).set(updateData, { merge: true });
    
    showNotification(`Payment status updated for ${month}`, 'success');
    addActivity(`Updated ${month} payment for member ID: ${memberId}`, 'info');
    
    // Reload the data
    loadMemberFeeData(memberId);
    loadFeeYearlySummary();
    recalcTotalCollected();
    
  } catch (error) {
    console.error('Error updating payment status:', error);
    showNotification('Error updating payment: ' + error.message, 'error');
  }
}

// Load yearly summary
async function loadFeeYearlySummary() {
  const tbody = document.querySelector('#fees-yearly-summary tbody');
  if (!tbody) return;

  try {
    tbody.innerHTML = '';
    
    let monthlyTotals = {};
    MONTHS.forEach(month => {
      monthlyTotals[month] = { paidCount: 0, totalAmount: 0 };
    });

    // Get fees data based on selected year
    let feesData = [];
    const targetYear = selectedYear === 'all' ? new Date().getFullYear() : selectedYear;
    
    if (selectedYear === 'all') {
      // Aggregate from all years
      if (Object.keys(allYearsFeesData).length === 0) {
        await loadAllYearsFees();
      }
      
      Object.values(allYearsFeesData).forEach(yearData => {
        Object.values(yearData).forEach(feeData => {
          feesData.push(feeData);
        });
      });
    } else {
      // Single year
      const feesCol = membershipFeesCollectionFor(targetYear);
      const feesSnap = await feesCol.get();
      feesSnap.forEach(doc => {
        feesData.push(doc.data());
      });
    }

    console.log('Processing fees data for yearly summary:', feesData.length, 'records');

    // Calculate monthly totals - handle both data structures
    feesData.forEach(feeData => {
      MONTHS.forEach(month => {
        let monthData;
        if (feeData[month]) {
          // New structure
          monthData = feeData[month];
        } else if (feeData.months && feeData.months[month]) {
          // Old structure
          monthData = feeData.months[month];
        }
        
        if (monthData && monthData.paid) {
          monthlyTotals[month].paidCount++;
          monthlyTotals[month].totalAmount += monthData.amount || feeData.monthlyFee || feeData.feeAmount || 100;
        }
      });
    });

    // Populate table
    MONTHS.forEach(month => {
      const tr = document.createElement('tr');
      const data = monthlyTotals[month];
      tr.innerHTML = `
        <td style="font-weight: bold;">${month}</td>
        <td>${data.paidCount}</td>
        <td>‚Çπ${data.totalAmount.toLocaleString()}</td>
      `;
      tbody.appendChild(tr);
    });

    // Add total row
    const totalPaidCount = Object.values(monthlyTotals).reduce((sum, data) => sum + data.paidCount, 0);
    const totalAmount = Object.values(monthlyTotals).reduce((sum, data) => sum + data.totalAmount, 0);
    
    const totalTr = document.createElement('tr');
    totalTr.style.fontWeight = 'bold';
    totalTr.style.background = 'rgba(183,28,28,0.1)';
    totalTr.innerHTML = `
      <td>TOTAL</td>
      <td>${totalPaidCount}</td>
      <td>‚Çπ${totalAmount.toLocaleString()}</td>
    `;
    tbody.appendChild(totalTr);

    console.log('Yearly summary updated:', { totalPaidCount, totalAmount });

  } catch (error) {
    console.error('Error loading yearly summary:', error);
    tbody.innerHTML = '<tr><td colspan="3">Error loading data</td></tr>';
  }
}

// Save fee configuration
async function saveFeeConfiguration() {
  const memberSelect = document.getElementById('feeMemberSelect');
  const amountInput = document.getElementById('feeAmountInput');
  
  if (!memberSelect.value) {
    showNotification('Please select a member first', 'error');
    return;
  }

  const memberId = memberSelect.value;
  const monthlyFee = parseInt(amountInput.value) || 100;

  try {
    const targetYear = selectedYear === 'all' ? new Date().getFullYear() : selectedYear;
    const feesCol = membershipFeesCollectionFor(targetYear);
    const memberDoc = await membersCol.doc(memberId).get();
    
    if (!memberDoc.exists) {
      showNotification('Member not found', 'error');
      return;
    }

    const memberData = memberDoc.data();
    
    // Update the monthly fee for all future months
    const updateData = {
      monthlyFee: monthlyFee,
      memberName: memberData.name,
      memberVillage: memberData.village,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    await feesCol.doc(memberId).set(updateData, { merge: true });
    
    showNotification('Fee configuration saved', 'success');
    addActivity(`Updated monthly fee to ‚Çπ${monthlyFee} for ${memberData.name}`, 'info');
    
    // Reload the data
    loadMemberFeeData(memberId);
    
  } catch (error) {
    console.error('Error saving fee configuration:', error);
    showNotification('Error saving configuration: ' + error.message, 'error');
  }
}

// Clear fee record
async function clearFeeRecord() {
  const memberSelect = document.getElementById('feeMemberSelect');
  
  if (!memberSelect.value) {
    showNotification('Please select a member first', 'error');
    return;
  }

  if (!confirm('Are you sure you want to clear all payment records for this member?')) {
    return;
  }

  const memberId = memberSelect.value;

  try {
    const targetYear = selectedYear === 'all' ? new Date().getFullYear() : selectedYear;
    const feesCol = membershipFeesCollectionFor(targetYear);
    const memberDoc = await membersCol.doc(memberId).get();
    
    if (!memberDoc.exists) {
      showNotification('Member not found', 'error');
      return;
    }

    const memberData = memberDoc.data();
    
    // Reset all months to unpaid
    const resetData = {
      monthlyFee: parseInt(document.getElementById('feeAmountInput').value) || 100,
      memberName: memberData.name,
      memberVillage: memberData.village,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    MONTHS.forEach(month => {
      resetData[month] = {
        paid: false,
        paidOn: null,
        amount: resetData.monthlyFee
      };
    });

    await feesCol.doc(memberId).set(resetData);
    
    showNotification('Payment records cleared', 'success');
    addActivity(`Cleared all payment records for ${memberData.name}`, 'info');
    
    // Reload the data
    loadMemberFeeData(memberId);
    loadFeeYearlySummary();
    recalcTotalCollected();
    
  } catch (error) {
    console.error('Error clearing fee record:', error);
    showNotification('Error clearing records: ' + error.message, 'error');
  }
}

// Export CSV
async function exportFeesCSV() {
  try {
    let feesData = [];
    const targetYear = selectedYear === 'all' ? new Date().getFullYear() : selectedYear;
    
    if (selectedYear === 'all') {
      // Aggregate from all years
      if (Object.keys(allYearsFeesData).length === 0) {
        await loadAllYearsFees();
      }
      
      Object.values(allYearsFeesData).forEach(yearData => {
        Object.entries(yearData).forEach(([memberId, feeData]) => {
          feesData.push({ memberId, ...feeData });
        });
      });
    } else {
      // Single year
      const feesCol = membershipFeesCollectionFor(targetYear);
      const feesSnap = await feesCol.get();
      feesSnap.forEach(doc => {
        feesData.push({ memberId: doc.id, ...doc.data() });
      });
    }

    if (feesData.length === 0) {
      showNotification('No fee data to export', 'info');
      return;
    }

    // Create CSV content
    let csvContent = 'Member Name,Village,Monthly Fee,Total Paid Months,Total Amount\n';
    
    feesData.forEach(fee => {
      let paidMonths = 0;
      let totalAmount = 0;
      
      MONTHS.forEach(month => {
        if (fee[month] && fee[month].paid) {
          paidMonths++;
          totalAmount += fee[month].amount || fee.monthlyFee || 100;
        }
      });

      csvContent += `"${fee.memberName || 'Unknown'}","${fee.memberVillage || ''}",${fee.monthlyFee || 100},${paidMonths},${totalAmount}\n`;
    });

    // Create and download file
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const filename = `membership-fees-${selectedYear === 'all' ? 'all-years' : selectedYear}-${new Date().toISOString().split('T')[0]}.csv`;
    
    downloadBlob(blob, filename);
    
    showNotification('CSV exported successfully', 'success');
    addActivity(`Exported fees CSV for ${selectedYear === 'all' ? 'all years' : selectedYear}`, 'success');
    
  } catch (error) {
    console.error('Error exporting CSV:', error);
    showNotification('Error exporting CSV: ' + error.message, 'error');
  }
}

/* ---------------- ENHANCED VILLAGE COLLECTIONS MANAGEMENT ---------------- */
let editingCollectionId = null;

// Enhanced load village collections function with edit capabilities
async function loadVillageCollections() {
  const tbody = document.querySelector('#vc-table tbody');
  if (!tbody) return;

  try {
    tbody.innerHTML = '';
    
    let totalAmount = 0;
    let collectionsData = [];

    if (selectedYear === 'all') {
      // Aggregate from all years
      if (Object.keys(allYearsVillageData).length === 0) {
        await loadAllYearsVillageCollections();
      }
      
      Object.values(allYearsVillageData).forEach(yearData => {
        Object.entries(yearData).forEach(([id, data]) => {
          collectionsData.push({ id, ...data });
        });
      });
    } else {
      // Single year
      const targetYear = selectedYear === 'all' ? new Date().getFullYear() : selectedYear;
      const villageCol = villageCollectionsCollectionFor(targetYear);
      const snap = await villageCol.orderBy('dateAdded', 'desc').get();
      snap.forEach(doc => {
        collectionsData.push({ id: doc.id, ...doc.data() });
      });
    }

    collectionsData.forEach(collection => {
      const d = collection;
      totalAmount += d.amount || 0;
      
      // Get collector name from our memberNamesMap
      const collectorName = window.memberNamesMap && window.memberNamesMap[d.collectorId] ? 
        window.memberNamesMap[d.collectorId] : d.collectorId;
      
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(d.bill || '')}</td>
        <td>${escapeHtml(collectorName)}</td>
        <td>${escapeHtml(d.donor || '')}</td>
        <td>‚Çπ${(d.amount || 0).toLocaleString()}</td>
        <td>${escapeHtml(d.remarks || '')}</td>
        <td>${escapeHtml(d.village || '')}</td>
        <td>${d.dateAdded && d.dateAdded.toDate ? d.dateAdded.toDate().toLocaleDateString() : ''}</td>
        <td style="white-space: nowrap;"></td>
      `;
      tbody.appendChild(tr);

      const actionsTd = tr.querySelector('td:last-child');
      if (currentRole === 'admin') {
        // Edit button
        const editBtn = document.createElement('button');
        editBtn.textContent = '‚úèÔ∏è Edit';
        editBtn.className = 'btn small secondary';
        editBtn.style.marginRight = '5px';
        editBtn.onclick = () => showEditCollectionModal(collection.id, d);
        actionsTd.appendChild(editBtn);

        // Delete button
        const delBtn = document.createElement('button');
        delBtn.textContent = 'üóëÔ∏è Delete';
        delBtn.className = 'btn small ghost';
        delBtn.onclick = () => deleteCollection(collection.id, d.donor);
        actionsTd.appendChild(delBtn);
      } else {
        actionsTd.innerHTML = '<span class="muted">View only</span>';
      }
    });

    // Update total display
    const totalDisplay = document.getElementById('vc-total-amount');
    const totalContainer = document.getElementById('vc-total-collection');
    if (totalDisplay) totalDisplay.textContent = totalAmount.toLocaleString();
    if (totalContainer) totalContainer.style.display = totalAmount > 0 ? 'block' : 'none';

    // Update collection chart
    if (collectionChart) {
      const monthlyData = Array(12).fill(0);
      collectionsData.forEach(collection => {
        if (collection.dateAdded && collection.dateAdded.toDate) {
          const month = collection.dateAdded.toDate().getMonth();
          monthlyData[month] += collection.amount || 0;
        }
      });
      collectionChart.data.datasets[0].data = monthlyData;
      collectionChart.update();
    }

    // Update village breakdown
    loadVillageBreakdown();

  } catch (error) {
    console.error('Error loading village collections:', error);
  }
}

// Show edit collection modal
function showEditCollectionModal(collectionId, collectionData) {
  editingCollectionId = collectionId;
  
  let modal = document.getElementById('editCollectionModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'editCollectionModal';
    modal.className = 'modal-overlay';
    modal.innerHTML = `
      <div class="modal-content">
        <div class="modal-header">
          <h3>‚úèÔ∏è Edit Collection</h3>
          <button class="modal-close" onclick="closeEditCollectionModal()">&times;</button>
        </div>
        <div style="display: grid; gap: 15px; margin-top: 15px;">
          <div>
            <label class="muted">Bill No *</label>
            <input type="text" id="edit-vc-bill" placeholder="Bill Number" style="width: 100%;">
          </div>
          <div>
            <label class="muted">Collector *</label>
            <select id="edit-vc-collector" style="width: 100%;">
              <option value="">-- Select Collector --</option>
            </select>
          </div>
          <div>
            <label class="muted">Donor Name *</label>
            <input type="text" id="edit-vc-donor" placeholder="Donor Name" style="width: 100%;">
          </div>
          <div>
            <label class="muted">Amount (‚Çπ) *</label>
            <input type="number" id="edit-vc-amount" placeholder="Amount" style="width: 100%;">
          </div>
          <div>
            <label class="muted">Village *</label>
            <select id="edit-vc-village" style="width: 100%;">
              <option value="">-- Select Village --</option>
              <option value="Madhabpur">Madhabpur</option>
              <option value="Paldhui">Paldhui</option>
              <option value="Sabitrapur">Sabitrapur</option>
              <option value="Lalupool">Lalupool</option>
              <option value="Mahakal">Mahakal</option>
              <option value="Others">Others</option>
            </select>
          </div>
          <div>
            <label class="muted">Remarks</label>
            <textarea id="edit-vc-remarks" placeholder="Remarks" style="width: 100%; min-height: 80px;"></textarea>
          </div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button class="btn" onclick="saveCollectionEdit()">üíæ Save Changes</button>
          <button class="btn ghost" onclick="closeEditCollectionModal()">‚ùå Cancel</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }
  
  // Populate collectors dropdown
  const collectorSelect = document.getElementById('edit-vc-collector');
  collectorSelect.innerHTML = '<option value="">-- Select Collector --</option>';
  if (window.memberNamesMap) {
    Object.entries(window.memberNamesMap).forEach(([id, name]) => {
      const option = document.createElement('option');
      option.value = id;
      option.textContent = name;
      collectorSelect.appendChild(option);
    });
  }
  
  // Populate form with current data
  document.getElementById('edit-vc-bill').value = collectionData.bill || '';
  document.getElementById('edit-vc-collector').value = collectionData.collectorId || '';
  document.getElementById('edit-vc-donor').value = collectionData.donor || '';
  document.getElementById('edit-vc-amount').value = collectionData.amount || '';
  document.getElementById('edit-vc-village').value = collectionData.village || '';
  document.getElementById('edit-vc-remarks').value = collectionData.remarks || '';
  
  modal.classList.remove('hidden');
}

// Close edit collection modal
function closeEditCollectionModal() {
  const modal = document.getElementById('editCollectionModal');
  if (modal) {
    modal.classList.add('hidden');
  }
  editingCollectionId = null;
}

// Save collection edits
async function saveCollectionEdit() {
  if (!editingCollectionId) return;
  
  const bill = document.getElementById('edit-vc-bill').value.trim();
  const collectorId = document.getElementById('edit-vc-collector').value;
  const donor = document.getElementById('edit-vc-donor').value.trim();
  const amount = parseFloat(document.getElementById('edit-vc-amount').value);
  const village = document.getElementById('edit-vc-village').value;
  const remarks = document.getElementById('edit-vc-remarks').value.trim();
  
  if (!bill || !collectorId || !donor || !amount || !village) {
    showNotification('Please fill all required fields', 'error');
    return;
  }
  
  if (amount <= 0) {
    showNotification('Amount must be greater than 0', 'error');
    return;
  }
  
  try {
    const targetYear = selectedYear === 'all' ? new Date().getFullYear() : selectedYear;
    await villageCollectionsCollectionFor(targetYear).doc(editingCollectionId).update({
      bill,
      collectorId,
      donor,
      amount,
      village,
      remarks,
      lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    showNotification('Collection updated successfully', 'success');
    addActivity(`Updated collection from ${donor}`, 'success');
    closeEditCollectionModal();
    loadVillageCollections();
    recalcTotalCollected();
    
  } catch (error) {
    console.error('Error updating collection:', error);
    showNotification('Error updating collection: ' + error.message, 'error');
  }
}

// Delete collection
async function deleteCollection(collectionId, donorName) {
  if (!confirm(`Are you sure you want to delete collection from ${donorName}?`)) return;
  
  try {
    if (selectedYear === 'all') {
      showNotification('Cannot delete from "All Years" view. Switch to specific year.', 'error');
      return;
    }
    
    const targetYear = selectedYear === 'all' ? new Date().getFullYear() : selectedYear;
    await villageCollectionsCollectionFor(targetYear).doc(collectionId).delete();
    
    showToast('Deleted');
    addActivity(`Deleted collection record for ${donorName}`, 'info');
    loadVillageCollections();
    recalcTotalCollected();
    
  } catch (error) {
    console.error('Error deleting collection:', error);
    showNotification('Error deleting collection: ' + error.message, 'error');
  }
}

// Add village collection
const addVcBtn = document.getElementById('add-vc-btn');
if (addVcBtn) {
  addVcBtn.addEventListener('click', async () => {
    if (currentRole !== 'admin') {
      showNotification('Only admin can add collections', 'error');
      return;
    }

    const bill = document.getElementById('vc-bill').value.trim();
    const collectorId = document.getElementById('vc-collector').value.trim();
    const donor = document.getElementById('vc-donor').value.trim();
    const amount = parseFloat(document.getElementById('vc-amount').value);
    const remarks = document.getElementById('vc-remarks').value.trim();
    const village = document.getElementById('vc-village').value;

    if (!bill || !collectorId || !donor || !amount || !village) {
      showNotification('Please fill all required fields', 'error');
      return;
    }

    if (amount <= 0) {
      showNotification('Amount must be greater than 0', 'error');
      return;
    }

    try {
      const targetYear = selectedYear === 'all' ? new Date().getFullYear() : selectedYear;
      await villageCollectionsCollectionFor(targetYear).add({
        bill,
        collectorId,
        donor,
        amount,
        remarks,
        village,
        dateAdded: firebase.firestore.FieldValue.serverTimestamp()
      });

      // Clear form
      ['vc-bill', 'vc-donor', 'vc-amount', 'vc-remarks'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });

      showNotification('Collection added successfully', 'success');
      addActivity(`Added collection from ${donor} in ${village}`, 'success');
      
      loadVillageCollections();
      recalcTotalCollected();
      
    } catch (error) {
      console.error('Error adding collection:', error);
      showNotification('Error adding collection: ' + error.message, 'error');
    }
  });
}

// Search village collections
const searchVc = document.getElementById('search-vc');
if (searchVc) {
  searchVc.addEventListener('input', (e) => debouncedFilterTable('vc-table', e.target.value));
}

/* ---------------- LOAD PAID MEMBERS TRACKER - FIXED VERSION ---------------- */
async function loadPaidMembersTracker() {
  const container = document.getElementById("paid-members-list");
  const countSpan = document.getElementById("paid-tracker-count");
  if (!container) {
    console.error('Paid members container not found');
    return;
  }
  
  try {
    container.innerHTML = "<p>Loading paid members...</p>";
    console.log('Starting to load paid members tracker...');
    
    // Get all members
    const membersSnap = await cachedLoadMembers();
    const members = [];
    membersSnap.forEach(doc => {
      members.push({ id: doc.id, ...doc.data() });
    });
    
    console.log(`Found ${members.length} members`);
    
    if (members.length === 0) {
      container.innerHTML = "<p>No members found in database</p>";
      if (countSpan) countSpan.textContent = "Loaded: 0";
      return;
    }
    
    // Get fees data based on selected year
    let feesData = {};
    const targetYear = selectedYear === 'all' ? new Date().getFullYear() : selectedYear;
    console.log(`Loading fees for year: ${targetYear}`);
    
    try {
      const feesCol = membershipFeesCollectionFor(targetYear);
      const feesSnap = await feesCol.get();
      console.log(`Found ${feesSnap.size} fee records`);
      
      feesSnap.forEach(doc => {
        feesData[doc.id] = doc.data();
      });
    } catch (error) {
      console.log('No fee data found for selected year:', error);
    }
    
    // Create the tracker table
    let html = `
      <div style="overflow-x: auto;">
        <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
          <thead>
            <tr>
              <th style="padding: 8px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer;" onclick="sortMembersTable()">Member</th>
            `;
    
    // Add month headers
    MONTHS.forEach(month => {
      html += `<th style="padding: 8px; border: 1px solid #ddd; background: #f5f5f5; text-align: center;">${month}</th>`;
    });
    
    html += `</tr></thead><tbody>`;
    
    // Sort members alphabetically
    members.sort((a, b) => a.name.localeCompare(b.name));
    
    let paidCount = 0;
    let membersWithPayments = 0;
    
    // Add member rows
    members.forEach(member => {
      const memberFees = feesData[member.id] || {};
      let memberPaidMonths = 0;
      
      html += `<tr>
        <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">
          ${escapeHtml(member.name)}<br>
          <small style="color: #666;">${member.village}</small>
        </td>`;
      
      MONTHS.forEach(month => {
        // Check both data structures
        let isPaid = false;
        
        // NEW STRUCTURE: Check direct month properties
        if (memberFees[month] && memberFees[month].paid === true) {
          isPaid = true;
        } 
        // OLD STRUCTURE: Check nested months object
        else if (memberFees.months && memberFees.months[month] && memberFees.months[month].paid === true) {
          isPaid = true;
        }
        
        if (isPaid) memberPaidMonths++;
        
        html += `
          <td style="padding: 8px; border: 1px solid #ddd; text-align: center; background: ${isPaid ? '#d4edda' : '#f8d7da'};">
            <div class="paid-box ${isPaid ? 'paid-yes' : 'paid-no'}" title="${month}: ${isPaid ? 'Paid' : 'Not Paid'}">
              ${isPaid ? '‚úì' : '‚úó'}
            </div>
          </td>
        `;
      });
      
      html += `</tr>`;
      
      if (memberPaidMonths > 0) {
        paidCount += memberPaidMonths;
        membersWithPayments++;
      }
    });
    
    html += `</tbody></table></div>`;
    
    container.innerHTML = html;
    
    if (countSpan) {
      countSpan.textContent = `Loaded: ${members.length} members, ${membersWithPayments} with payments, ${paidCount} total payments`;
    }
    
    showNotification(`Loaded ${members.length} members payment status`, 'success');
    addActivity(`Loaded paid members tracker for ${selectedYear}`, 'info');
    
  } catch (error) {
    console.error("Load paid members tracker error:", error);
    container.innerHTML = `<p style="color: red;">Error loading paid members: ${error.message}</p>`;
    showNotification('Error loading paid members tracker: ' + error.message, 'error');
  }
}

// Sort members table
function sortMembersTable() {
  // This would implement sorting functionality
  showNotification('Sorting feature coming soon!', 'info');
}

/* ---------------- Initialize All Event Listeners ---------------- */
function initializeAllEventListeners() {
  console.log('Initializing all event listeners...');
  initMembershipFeesEvents();
}

/* ---------------- RECALC TOTAL COLLECTED ---------------- */
async function recalcTotalCollected() {
  try {
    let totalVillage = 0;
    let totalMembership = 0;
    
    // Calculate village collections
    if (selectedYear === 'all') {
      // Aggregate from all years
      if (Object.keys(allYearsVillageData).length === 0) {
        await loadAllYearsVillageCollections();
      }
      
      Object.values(allYearsVillageData).forEach(yearData => {
        Object.values(yearData).forEach(collection => {
          totalVillage += collection.amount || 0;
        });
      });
    } else {
      // Single year
      const targetYear = selectedYear === 'all' ? new Date().getFullYear() : selectedYear;
      const villageCol = villageCollectionsCollectionFor(targetYear);
      const villageSnap = await villageCol.get();
      villageSnap.forEach(doc => {
        totalVillage += doc.data().amount || 0;
      });
    }
    
    // Calculate membership fees
    if (selectedYear === 'all') {
      // Aggregate from all years
      Object.values(allYearsFeesData).forEach(yearData => {
        Object.values(yearData).forEach(memberFees => {
          MONTHS.forEach(month => {
            if (memberFees[month] && memberFees[month].paid) {
              totalMembership += memberFees.monthlyFee || 100;
            }
          });
        });
      });
    } else {
      // Single year - we need to calculate from monthly summary
      const targetYear = selectedYear === 'all' ? new Date().getFullYear() : selectedYear;
      const feesCol = membershipFeesCollectionFor(targetYear);
      const feesSnap = await feesCol.get();
      feesSnap.forEach(doc => {
        const data = doc.data();
        MONTHS.forEach(month => {
          if (data[month] && data[month].paid) {
            totalMembership += data.monthlyFee || 100;
          }
        });
      });
    }
    
    const totalCollection = totalVillage + totalMembership;
    
  } catch (error) {
    console.error("Recalc total collected error:", error);
  }
}

/* ---------------- MONTHLY SUMMARY ---------------- */
async function updateMonthlySummary() {
  // This function would update any monthly summary displays
  await recalcTotalCollected();
}

/* ---------------- Bulk Upload Functions ---------------- */

// Export invitations bulk
function exportInvitationsBulk() {
  showNotification('Export invitations feature coming soon!', 'info');
  addActivity('Export invitations triggered', 'info');
}

// Show bulk upload modal
function showBulkUploadModal() {
  const modal = document.getElementById('bulkUploadModal');
  if (modal) {
    modal.classList.remove('hidden');
  }
}

// Close bulk upload modal
function closeBulkUploadModal() {
  const modal = document.getElementById('bulkUploadModal');
  if (modal) {
    modal.classList.add('hidden');
  }
}

// Show village bulk upload modal
function showVillageBulkUploadModal() {
  const modal = document.getElementById('villageBulkUploadModal');
  if (modal) {
    modal.classList.remove('hidden');
  }
}

// Close village bulk upload modal
function closeVillageBulkUploadModal() {
  const modal = document.getElementById('villageBulkUploadModal');
  if (modal) {
    modal.classList.add('hidden');
  }
}

// Download upload template
function downloadUploadTemplate() {
  showNotification('Download template feature coming soon!', 'info');
}

// Download village upload template
function downloadVillageUploadTemplate() {
  showNotification('Download village template feature coming soon!', 'info');
}

// Handle file upload
function handleFileUpload(file) {
  showNotification('File upload feature coming soon!', 'info');
}

// Handle village file upload
function handleVillageFileUpload(file) {
  showNotification('Village file upload feature coming soon!', 'info');
}

// Process bulk upload
function processBulkUpload() {
  showNotification('Bulk upload processing feature coming soon!', 'info');
}

// Process village bulk upload
function processVillageBulkUpload() {
  showNotification('Village bulk upload processing feature coming soon!', 'info');
}

// Export village collection bulk
function exportVillageCollectionBulk() {
  showNotification('Export village collection feature coming soon!', 'info');
  addActivity('Export village collection triggered', 'info');
}

// Debug function to check data structure
async function debugFeeStructure() {
  const targetYear = selectedYear === 'all' ? new Date().getFullYear() : selectedYear;
  const feesCol = membershipFeesCollectionFor(targetYear);
  const feesSnap = await feesCol.get();
  
  console.log('=== FEE DATA STRUCTURE DEBUG ===');
  console.log(`Total records: ${feesSnap.size}`);
  
  feesSnap.forEach(doc => {
    const data = doc.data();
    console.log(`Member: ${data.memberName || 'Unknown'} (${doc.id})`);
    console.log('Data structure:', data);
    
    // Check structure type
    if (data.months) {
      console.log('üìÅ OLD STRUCTURE: Uses nested months object');
    } else {
      let hasNewStructure = false;
      MONTHS.forEach(month => {
        if (data[month]) hasNewStructure = true;
      });
      if (hasNewStructure) {
        console.log('üÜï NEW STRUCTURE: Uses flat month properties');
      } else {
        console.log('‚ùì UNKNOWN STRUCTURE: No recognizable month data');
      }
    }
    console.log('---');
  });
}

// Make debug function available globally
window.debugFeeStructure = debugFeeStructure;

// Add debug button to fees section for testing
function addDebugButton() {
  const feesCard = document.getElementById('fees');
  if (feesCard && currentRole === 'admin') {
    // Remove existing debug button if any
    const existingDebugBtn = feesCard.querySelector('[data-debug-button]');
    if (existingDebugBtn) {
      existingDebugBtn.remove();
    }
    
    const debugButton = document.createElement('button');
    debugButton.textContent = 'üêõ Debug Data Structure';
    debugButton.className = 'btn small ghost';
    debugButton.style.marginLeft = '10px';
    debugButton.setAttribute('data-debug-button', 'true');
    debugButton.onclick = debugFeeStructure;
    
    const summaryDiv = feesCard.querySelector('#fee-member-summary');
    if (summaryDiv) {
      summaryDiv.parentNode.insertBefore(debugButton, summaryDiv.nextSibling);
    }
  }
}

// Update initializeAllEventListeners to include debug button
function initializeAllEventListeners() {
  console.log('Initializing all event listeners...');
  initMembershipFeesEvents();
  
  // Add debug button after a short delay to ensure DOM is ready
  setTimeout(addDebugButton, 1000);
}

/* ---------------- Navigation ---------------- */
function clearActiveNav(){ 
  document.querySelectorAll('nav.topbar a').forEach(a=>{
    if (a) a.classList.remove('active');
  }); 
}

// Add navigation event listeners
const navLinks = ['nav-invitations', 'nav-members', 'nav-fees', 'nav-financial', 'nav-village-collection'];
navLinks.forEach(navId => {
  const navElement = document.getElementById(navId);
  if (navElement) {
    navElement.addEventListener("click", (e)=>{
      e.preventDefault(); 
      const targetId = navId.replace('nav-', '');
      navigateToSection(targetId);
    });
  }
});

/* Expose for debugging */
window.loadAllData = loadAllData;
window.loadPaidMembersTracker = loadPaidMembersTracker;
window.recalcTotalCollected = recalcTotalCollected;
window.addActivity = addActivity;
window.showNotification = showNotification;
window.changeGlobalYear = changeGlobalYear;
window.loadAllYearsFees = loadAllYearsFees;
window.loadAllYearsVillageCollections = loadAllYearsVillageCollections;
window.exportInvitationsBulk = exportInvitationsBulk;
window.showBulkUploadModal = showBulkUploadModal;
window.showVillageBulkUploadModal = showVillageBulkUploadModal;
window.showTransactionModal = showTransactionModal;
window.generateFinancialReport = generateFinancialReport;
window.loadFinancialData = loadFinancialData;
window.loadMemberFeeData = loadMemberFeeData;
window.loadFeeYearlySummary = loadFeeYearlySummary;
window.loadVillageCollections = loadVillageCollections;
window.exportVillageCollectionBulk = exportVillageCollectionBulk;
window.initializeAllEventListeners = initializeAllEventListeners;
window.navigateToSection = navigateToSection;

// Add some initial activities when the page loads
setTimeout(() => {
  if (auth.currentUser) {
    addActivity('Dashboard initialized successfully', 'success');
    addActivity(`Global year set to ${selectedYear}`, 'info');
    addActivity('Welcome to Club Bornoporichoy Dashboard!', 'info');
  }
}, 1000);

</script>
</body>
</html>
