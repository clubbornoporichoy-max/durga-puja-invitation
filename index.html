<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Durga Puja Club Dashboard</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
body { font-family: Arial; background: #fff5f0; color: #4b2e2e; margin: 0; padding: 0; }
header { background: #b71c1c; color: white; padding: 15px; text-align: center; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
h2 { color: #b71c1c; margin-top: 30px; }
.container { padding: 20px; max-width: 1200px; margin: auto; }
table { width: 100%; border-collapse: collapse; margin-bottom: 30px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); border-radius: 5px; overflow: hidden; }
th, td { border: 1px solid #b71c1c; padding: 8px; text-align: left; }
th { background: #fdd835; color: #4b2e2e; cursor: pointer; }
input, select { padding: 5px; margin: 5px 0; border: 1px solid #b71c1c; border-radius: 3px; }
button { background: #b71c1c; color: white; border: none; padding: 5px 10px; cursor: pointer; margin-right: 5px; border-radius: 3px; transition: 0.2s; }
button:hover:not(:disabled) { background: #d32f2f; }
button:disabled { background: #ccc; cursor: not-allowed; }
.editable { background: #fff8e1; cursor: text; transition: 0.2s; }
.editable:hover { border: 2px solid #fdd835; }
.editable:focus { outline: none; border: 2px solid #f57f17; background: #fff3e0; }
.hidden { display: none; }
td { min-width: 80px; }
.summary { margin-bottom: 20px; font-weight: bold; }
.sent-badge { color: white; background: green; padding: 2px 5px; border-radius: 3px; font-size: 0.8em; }
.pending-badge { color: white; background: orange; padding: 2px 5px; border-radius: 3px; font-size: 0.8em; }
</style>
</head>
<body>
<header>
  <h1>Durga Puja Club Dashboard</h1>
  <div id="auth-section">
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button id="login-btn">Login</button>
    <button id="logout-btn" class="hidden">Logout</button>
    <span id="user-info"></span>
  </div>
</header>

<div class="container hidden" id="main-content">

  <div class="summary" id="summary-invitees"></div>
  <h2>Invitation List</h2>
  <input type="text" id="search-invite" placeholder="Search invitations...">
  <table id="invitation-table">
    <thead><tr>
      <th>Name</th><th>Village</th><th>Mobile No</th><th>Remarks</th><th>Sent</th><th>Actions</th>
    </tr></thead>
    <tbody></tbody>
  </table>
  <div id="invitation-form">
    <input type="text" id="inv-name" placeholder="Name">
    <input type="text" id="inv-village" placeholder="Village">
    <input type="text" id="inv-mobile" placeholder="Mobile No">
    <input type="text" id="inv-remarks" placeholder="Remarks">
    <button id="add-inv-btn">Add Invitation</button>
  </div>

  <div class="summary" id="summary-members"></div>
  <h2>Members List</h2>
  <input type="text" id="search-members" placeholder="Search members...">
  <table id="members-table">
    <thead><tr><th>Name</th><th>Village</th><th>Mobile No</th><th>Remarks</th><th>Actions</th></tr></thead>
    <tbody></tbody>
  </table>
  <div id="member-form">
    <input type="text" id="mem-name" placeholder="Name">
    <input type="text" id="mem-village" placeholder="Village">
    <input type="text" id="mem-mobile" placeholder="Mobile No">
    <input type="text" id="mem-remarks" placeholder="Remarks">
    <button id="add-mem-btn">Add Member</button>
  </div>

  <h2>Donation Collectors</h2>
  <input type="text" id="search-collectors" placeholder="Search collectors...">
  <table id="collector-table">
    <thead><tr><th>Name</th><th>Assigned Area</th><th>Actions</th></tr></thead>
    <tbody></tbody>
  </table>
  <div id="collector-form">
    <input type="text" id="col-name" placeholder="Name">
    <input type="text" id="col-area" placeholder="Assigned Area">
    <button id="add-col-btn">Add Collector</button>
  </div>

</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCuVs6jx7HiNIx25lzLgoq1B6nQqaHLHm0",
  authDomain: "guestandcollection.firebaseapp.com",
  projectId: "guestandcollection",
  storageBucket: "guestandcollection.firebasestorage.app",
  messagingSenderId: "272278233160",
  appId: "1:272278233160:web:d6d1e6a7d58be260d9b87d",
  measurementId: "G-B5783XTFSP"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Hardcoded roles
const roles = {
  "fRpLuiBgU0ZE1AtVmkGaA1RhBJk2": "admin",
  "898Fi5sPKHY01GUgI4iu1xS4TBR2": "viewer"
};
let currentRole = "viewer";

// Elements
const loginBtn = document.getElementById("login-btn");
const logoutBtn = document.getElementById("logout-btn");
const userInfo = document.getElementById("user-info");
const mainContent = document.getElementById("main-content");

// Email/password login
loginBtn.onclick = () => {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  if(email && password){
    auth.signInWithEmailAndPassword(email, password)
      .catch(err => alert(err.message));
  }
};
logoutBtn.onclick = () => auth.signOut();

auth.onAuthStateChanged(user => {
  if(user){
    currentRole = roles[user.uid] || "viewer";
    loginBtn.classList.add("hidden");
    logoutBtn.classList.remove("hidden");
    mainContent.classList.remove("hidden");
    userInfo.textContent = `${user.email} (${currentRole})`;
    applyRoleToUI();
    loadAllData();
  } else {
    loginBtn.classList.remove("hidden");
    logoutBtn.classList.add("hidden");
    mainContent.classList.add("hidden");
    userInfo.textContent = "";
  }
});

function applyRoleToUI(){
  const adminOnly = document.querySelectorAll("#add-inv-btn,#add-mem-btn,#add-col-btn,.delete-btn");
  adminOnly.forEach(btn => btn.disabled = currentRole !== "admin");
}

const invitationCol = db.collection("invitations");
const membersCol = db.collection("members");
const collectorsCol = db.collection("collectors");

function loadAllData(){
  loadTable(invitationCol,"invitation-table",["name","village","mobile","remarks","sent"],true);
  loadTable(membersCol,"members-table",["name","village","mobile","remarks"],false);
  loadTable(collectorsCol,"collector-table",["name","area"],false);
}

// Load table and apply search/filter
function loadTable(colRef,tableId,fields,isInvite){
  const tbody=document.getElementById(tableId).querySelector("tbody");
  tbody.innerHTML="";
  colRef.get().then(snapshot=>{
    let countTotal=0,countSent=0;
    snapshot.forEach(doc=>{
      const data=doc.data();
      const tr=document.createElement("tr");
      tr.dataset.id=doc.id;
      fields.forEach(f=>{
        const td=document.createElement("td");
        if(f==="sent" && isInvite){
          const chk=document.createElement("input");
          chk.type="checkbox";
          chk.checked=data.sent||false;
          chk.disabled = currentRole !== "admin";
          chk.onchange=()=>{doc.ref.update({sent:chk.checked}).then(updateSummary);}
          td.appendChild(chk);
          tr.appendChild(td);
        } else {
          td.textContent=data[f]||"";
          if(currentRole==="admin"){
            td.classList.add("editable");
            td.contentEditable=true;
            td.onblur=()=>{let update={}; update[f]=td.textContent; doc.ref.update(update);}
          }
          tr.appendChild(td);
        }
      });
      const actionTd=document.createElement("td");
      const delBtn=document.createElement("button");
      delBtn.textContent="Delete";
      delBtn.disabled=currentRole!=="admin";
      delBtn.onclick=()=>{if(confirm("Delete?"))doc.ref.delete().then(loadAllData);}
      actionTd.appendChild(delBtn);
      tr.appendChild(actionTd);
      tbody.appendChild(tr);

      if(isInvite){countTotal++; if(data.sent)countSent++;}
    });
    if(isInvite) updateSummary(countTotal,countSent);
  });
}

// Update summary
function updateSummary(total=0,sent=0){
  document.getElementById("summary-invitees").textContent = `Total Invitees: ${total} | Sent: ${sent} ✅ | Pending: ${total-sent} ⏳`;
  membersCol.get().then(snap=>document.getElementById("summary-members").textContent = `Total Members: ${snap.size}`);
}

// Add handlers with duplicate check
function addDocument(colRef,fields,values){
  colRef.where("name","==",values.name).where("mobile","==",values.mobile).get().then(snap=>{
    if(!snap.empty){alert("Duplicate entry!"); return;}
    colRef.add({...values, sent:false, dateAdded:new Date()}).then(loadAllData);
  });
}
document.getElementById("add-inv-btn").onclick=()=>{
  const values={name:document.getElementById("inv-name").value,village:document.getElementById("inv-village").value,mobile:document.getElementById("inv-mobile").value,remarks:document.getElementById("inv-remarks").value};
  if(values.name && values.village && values.mobile){addDocument(invitationCol,[],values); ["inv-name","inv-village","inv-mobile","inv-remarks"].forEach(id=>document.getElementById(id).value="");}
};
document.getElementById("add-mem-btn").onclick=()=>{
  const values={name:document.getElementById("mem-name").value,village:document.getElementById("mem-village").value,mobile:document.getElementById("mem-mobile").value,remarks:document.getElementById("mem-remarks").value};
  if(values.name && values.village && values.mobile){addDocument(membersCol,[],values); ["mem-name","mem-village","mem-mobile","mem-remarks"].forEach(id=>document.getElementById(id).value="");}
};
document.getElementById("add-col-btn").onclick=()=>{
  const values={name:document.getElementById("col-name").value,area:document.getElementById("col-area").value};
  if(values.name && values.area){collectorsCol.add(values).then(loadAllData); ["col-name","col-area"].forEach(id=>document.getElementById(id).value="");}
};

// Search functionality
document.getElementById("search-invite").oninput=function(){
  filterTable("invitation-table",this.value);
};
document.getElementById("search-members").oninput=function(){
  filterTable("members-table",this.value);
};
document.getElementById("search-collectors").oninput=function(){
  filterTable("collector-table",this.value);
};

function filterTable(tableId,term){
  const rows=document.getElementById(tableId).querySelectorAll("tbody tr");
  rows.forEach(tr=>{
    const text = tr.innerText.toLowerCase();
    tr.style.display = text.includes(term.toLowerCase()) ? "" : "none";
  });
}
</script>
</body>
</html>
