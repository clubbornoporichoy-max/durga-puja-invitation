<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Club Bornoporichoy ‚Äî Durga Puja Dashboard</title>

<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<!-- Firebase compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
  :root{
    --primary-red: #B71C1C;
    --deep-red: #a31313;
    --accent-gold: #D4AF37;
    --bg-start: #ffffff;
    --bg-end: #f7f0e8; /* soft beige */
    --card: #ffffff;
    --muted: #6b6b6b;
    --text: #2f2f2f;
    --radius: 12px;
    --shadow: 0 10px 30px rgba(17,17,17,0.06);
    --glass-overlay: rgba(255,255,255,0.15);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body {
    margin: 0;
    background: linear-gradient(180deg, var(--bg-start), var(--bg-end));
    color: var(--text);
    font-family: 'Poppins', system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    line-height:1.45;
  }

  /* Header / nav (fixed) */
  header {
    position: fixed; top:0; left:0; right:0; z-index:120;
    background: linear-gradient(90deg, rgba(255,255,255,0.96), rgba(255,250,240,0.96));
    border-bottom: 1px solid rgba(0,0,0,0.04);
    padding: 12px 18px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.05);
    backdrop-filter: blur(6px);
  }
  .header-inner { max-width:1200px; margin:0 auto; display:flex; gap:12px; align-items:center; }
  .brand { display:flex; align-items:center; gap:12px; }
  .logo {
    width:44px; height:44px; border-radius:10px;
    background: linear-gradient(135deg, var(--primary-red), #e34b4b);
    display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; box-shadow:0 4px 14px rgba(183,28,28,0.12);
  }
  .brand h1 { margin:0; font-size:16px; color:var(--deep-red); font-weight:700; letter-spacing:0.2px; }
  .brand .sub { font-size:12px; color:var(--muted); margin-top:2px; }

  nav.topbar { margin-left:20px; display:flex; gap:10px; align-items:center; flex:1; }
  nav.topbar a {
    padding:8px 12px; border-radius:10px; text-decoration:none; color:var(--deep-red);
    font-weight:600; font-size:14px; transition: all 160ms ease;
  }
  nav.topbar a:hover { transform: translateY(-2px); color: #7f0f0f; box-shadow: inset 0 -2px 0 var(--accent-gold); }
  nav.topbar a.active { background: rgba(183,28,28,0.06); }

  .auth-area { margin-left:auto; display:flex; gap:8px; align-items:center; }

  /* sticky summary bar (fixed below header) */
  #sticky-summary {
    position: fixed;
    top: 68px;
    left: 50%;
    transform: translateX(-50%);
    width: min(1200px, calc(100% - 36px));
    z-index:110;
    background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,250,245,0.95));
    border-radius: 10px;
    padding: 8px 14px;
    box-shadow: 0 10px 30px rgba(17,17,17,0.06);
    display: flex;
    gap:12px;
    align-items:center;
    border: 1px solid rgba(0,0,0,0.03);
  }
  #sticky-summary .stat { font-size:14px; color:var(--muted); }
  #sticky-summary .stat strong { color:var(--deep-red); margin-left:6px; }

  /* Container + cards */
  .spacer { height:124px } /* to offset fixed header + sticky summary */
  .container { max-width:1200px; margin:22px auto; padding:0 18px 80px; }
  .card { background:var(--card); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow); margin-bottom:18px; border:1px solid rgba(0,0,0,0.03); transition: transform 160ms ease, box-shadow 160ms ease; }
  .card:hover { transform: translateY(-4px); box-shadow: 0 18px 40px rgba(17,17,17,0.08); }
  .card h2 { margin:0 0 8px 0; color:var(--primary-red); font-size:18px; display:flex; align-items:center; gap:8px; }
  .subtitle { color:var(--muted); font-size:13px; margin-bottom:10px; }

  .flex { display:flex; gap:12px; align-items:center; }
  .flex.space { justify-content:space-between; }

  input[type="text"], input[type="email"], input[type="password"], input[type="number"], select, textarea {
    padding:10px 12px; border-radius:10px; border:1px solid rgba(0,0,0,0.06); background:#fff;
    font-size:14px; color:var(--text); outline:none;
  }
  input:focus, select:focus, textarea:focus { box-shadow: 0 8px 24px rgba(183,28,28,0.06); border-color: rgba(183,28,28,0.18); }

  /* Buttons */
  .btn { background:var(--primary-red); color:#fff; border:none; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:600; box-shadow: 0 8px 20px rgba(183,28,28,0.08); transition: transform 120ms ease, box-shadow 120ms ease; }
  .btn:hover{ transform: translateY(-2px); box-shadow: 0 14px 28px rgba(183,28,28,0.12); }
  .btn.small { padding:7px 10px; font-size:13px; border-radius:8px; }
  .btn.secondary { background:var(--accent-gold); color:#222; box-shadow:none; }
  .btn.ghost { background:transparent; color:var(--deep-red); border:1px solid rgba(0,0,0,0.06); box-shadow:none; }

  .muted { color:var(--muted); font-size:13px; }
  .note { font-size:13px; color:var(--muted); margin-top:8px; }

  /* Tables */
  table { width:100%; border-collapse:collapse; font-size:14px; margin-top:12px; }
  thead th {
    text-align:left; padding:12px 14px; background:linear-gradient(0deg,var(--accent-gold), #f6e9a8); color:var(--text); border-bottom:2px solid rgba(0,0,0,0.04);
  }
  tbody td { padding:12px 14px; border-bottom:1px solid rgba(0,0,0,0.04); vertical-align:middle; }
  tbody tr:hover { background: rgba(183,28,28,0.02); }
  .editable { background: linear-gradient(180deg,#fff8e6,#fffdf7); border-radius:6px; padding:8px; }
  .badge { display:inline-block; padding:6px 8px; border-radius:8px; font-weight:700; font-size:13px; transition: transform 250ms ease, opacity 220ms ease; }
  .badge.ok { background:#28a745; color:#fff; }
  .badge.warn { background:#ff8c00; color:#fff; }
  .badge.sent { background: linear-gradient(90deg,#4caf50,#2e7d32); color:#fff; }
  .badge.pending { background: linear-gradient(90deg,#ff9800,#f57c00); color:#fff; }
  .badge.pulse { animation: badgePulse 1s ease; }

  @keyframes badgePulse {
    0% { transform: scale(1); opacity: 0.9; }
    40% { transform: scale(1.12); opacity: 1; }
    100% { transform: scale(1); opacity: 1; }
  }

  .center { text-align:center; }
  .right { margin-left:auto; }

  /* toasts (bottom-right) */
  #toast-container {
    position: fixed;
    right: 18px;
    bottom: 18px;
    z-index: 9999;
    display:flex;
    flex-direction:column;
    gap:10px;
    align-items:flex-end;
  }
  .toast {
    min-width: 220px;
    max-width: 360px;
    border-radius: 10px;
    padding: 10px 12px;
    color: #fff;
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    display:flex;
    gap:10px;
    align-items:center;
    opacity:0;
    transform: translateY(12px);
    transition: opacity 260ms ease, transform 260ms ease;
    font-size:14px;
  }
  .toast.show { opacity:1; transform: translateY(0); }
  .toast.success { background: linear-gradient(90deg,#2ecc71,#27ae60); }
  .toast.error { background: linear-gradient(90deg,#e74c3c,#c0392b); }
  .toast.info { background: linear-gradient(90deg,#f39c12,#d35400); }

  /* responsive */
  @media (max-width:980px){
    .header-inner{flex-direction:column; gap:10px; align-items:flex-start}
    nav.topbar{flex-wrap:wrap}
    .flex{flex-direction:column; align-items:stretch}
    .spacer{height:160px}
    #sticky-summary { left: 12px; transform: none; width: calc(100% - 24px); }
  }
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="brand">
      <div class="logo">CB</div>
      <div>
        <h1>Club Bornoporichoy</h1>
        <div class="sub">Durga Puja Dashboard</div>
      </div>
    </div>

    <nav class="topbar" role="navigation" aria-label="Main navigation">
      <a href="#invitations" id="nav-invitations" class="active">Manage Invitations</a>
      <a href="#members" id="nav-members">Members</a>
      <a href="#collectors" id="nav-collectors">Donation Collectors</a>
      <a href="#fees" id="nav-fees">Membership Fees</a>
    </nav>

    <div class="auth-area">
      <div id="user-info" class="muted" style="font-size:13px"></div>
      <button id="logout-btn" class="btn small hidden">Logout</button>
    </div>
  </div>
</header>

<!-- Sticky summary bar -->
<div id="sticky-summary" aria-hidden="false">
  <div class="stat">Invitees: <strong id="sticky-invitees">‚Äî</strong></div>
  <div class="stat">Members: <strong id="sticky-members">‚Äî</strong></div>
  <div class="stat">Total Collected: <strong id="sticky-collected">‚Çπ0</strong></div>
  <div class="stat">Paid Members: <strong id="sticky-paid">0</strong></div>
</div>

<div class="spacer"></div>

<div class="container">

  <!-- Auth / Login Card -->
  <div class="card" id="auth-card">
    <div style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap">
      <div style="min-width:240px;flex:1">
        <label class="muted">Email</label>
        <input id="email" type="email" placeholder="admin@example.com" />
      </div>
      <div style="min-width:220px;flex:1">
        <label class="muted">Password</label>
        <input id="password" type="password" placeholder="password" />
      </div>

      <div style="min-width:160px">
        <label class="muted">Fees Year</label>
        <select id="feeYearSelectSmall" style="width:100%;"></select>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <button id="login-btn" class="btn">Login</button>
      </div>
    </div>
    <div class="muted note" style="margin-top:10px">Use email/password login. Admin UID for edits: <code>fRpLuiBgU0ZE1AtVmkGaA1RhBJk2</code></div>
  </div>

  <!-- Main content (hidden until login) -->
  <div id="main-content" class="hidden">

    <!-- Top summary (main) -->
    <div class="card" style="margin-top:0">
      <div class="stats" style="display:flex;gap:14px;align-items:center;flex-wrap:wrap">
        <div style="flex:1 1 200px">
          <div style="font-weight:700;color:var(--primary-red)">Invitees</div>
          <div id="summary-invitees" class="muted">‚Äî</div>
        </div>

        <div style="flex:1 1 200px">
          <div style="font-weight:700;color:var(--primary-red)">Members</div>
          <div id="summary-members" class="muted">‚Äî</div>
        </div>

        <div style="flex:1 1 300px">
          <div style="font-weight:700;color:var(--primary-red)">Total Collected</div>
          <div id="summary-collection" class="muted">‚Çπ0 (0 Paid Members)</div>
        </div>

        <div style="flex:1 1 160px">
          <div style="font-weight:700;color:var(--primary-red)">Pending Fees</div>
          <div id="summary-pending" class="muted">‚Äî</div>
        </div>
      </div>
    </div>

    <!-- Invitations -->
    <div class="card" id="invitations">
      <h2>ü™î Invitation List</h2>
      <div class="subtitle">Add, search and track invitation card distribution</div>

      <div style="display:flex;gap:12px;margin-top:12px;align-items:center">
        <input id="search-invite" type="text" placeholder="Search invitations (name / village / mobile)..." style="flex:1" />
        <div class="muted">Admin can add/edit/delete</div>
      </div>

      <table id="invitation-table" style="margin-top:12px">
        <thead>
          <tr><th>Name</th><th>Village</th><th>Mobile</th><th>Remarks</th><th>Sent</th><th>Date Added</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>

      <div style="margin-top:12px">
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <input id="inv-name" type="text" placeholder="Name" style="min-width:180px" />
          <input id="inv-village" type="text" placeholder="Village" style="min-width:160px" />
          <input id="inv-mobile" type="text" placeholder="Mobile No" style="min-width:140px" />
          <input id="inv-remarks" type="text" placeholder="Remarks" style="min-width:200px" />
          <button id="add-inv-btn" class="btn small">Add Invitation</button>
        </div>
      </div>
    </div>

    <!-- Members -->
    <div class="card" id="members">
      <h2>üå∏ Members List</h2>
      <div class="subtitle">Manage members ‚Äî linked to membership fee tracker</div>

      <div style="display:flex;gap:12px;margin-top:12px;align-items:center">
        <input id="search-members" type="text" placeholder="Search members (name/mobile)..." style="flex:1" />
        <div class="muted">Admin can add/edit/delete</div>
      </div>

      <table id="members-table" style="margin-top:12px">
        <thead><tr><th>Name</th><th>Village</th><th>Mobile</th><th>Remarks</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>

      <div style="margin-top:12px">
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <input id="mem-name" type="text" placeholder="Name" style="min-width:180px" />
          <input id="mem-village" type="text" placeholder="Village" style="min-width:160px" />
          <input id="mem-mobile" type="text" placeholder="Mobile No" style="min-width:140px" />
          <input id="mem-remarks" type="text" placeholder="Remarks" style="min-width:200px" />
          <button id="add-mem-btn" class="btn small">Add Member</button>
        </div>
      </div>

      <!-- Duplicate remover area (admin only) -->
      <div id="removeDuplicatesDiv" style="display:none; margin-top:18px;">
        <button id="removeDuplicatesBtn" class="btn small" style="background:linear-gradient(135deg,#d32f2f,#b71c1c);">üßπ Remove Duplicate Members</button>
        <div id="removeProgress" style="display:none;margin-top:10px;height:6px;background:#fce8b2;border-radius:4px;overflow:hidden;">
          <div id="removeProgressBar" style="width:0%;height:6px;background:linear-gradient(90deg,#fdd835,#f57f17);"></div>
        </div>
      </div>

    </div>

    <!-- Membership Fees -->
    <div class="card" id="fees">
      <h2>üí∞ Membership Fees Tracker (per Year)</h2>
      <div class="subtitle">Track monthly payments (‚Çπ per month configurable)</div>

      <div style="display:flex;gap:12px;align-items:center;margin-top:12px">
        <div style="min-width:160px">
          <label class="muted">Year</label>
          <select id="feeYearSelectSmall2" style="width:100%"></select>
        </div>

        <div style="min-width:260px">
          <label class="muted">Member</label>
          <select id="feeMemberSelect" style="width:100%"><option value="">-- Select member --</option></select>
        </div>

        <div style="min-width:140px">
          <label class="muted">Monthly Fee (‚Çπ)</label>
          <input id="feeAmountInput" type="number" min="1" value="100" />
        </div>

        <div style="display:flex;gap:8px;align-items:center;margin-left:auto">
          <button id="loadMemberFeeBtn" class="btn small">Load</button>
          <button id="exportCsvBtn" class="btn small secondary">Export CSV</button>
        </div>
      </div>

      <table id="fee-months-table" style="margin-top:12px">
        <thead><tr><th>Month</th><th>Status</th><th>Paid On</th><th>Toggle (Admin)</th></tr></thead>
        <tbody></tbody>
      </table>

      <div style="display:flex;align-items:center;gap:12px;margin-top:12px">
        <div id="fee-member-summary" class="muted">Select member to load fees</div>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button id="saveFeeConfigBtn" class="btn small">Save Config</button>
          <button id="clearFeeRecordBtn" class="btn small ghost">Clear</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <h3 style="margin:0 0 8px 0;color:var(--primary-red);font-size:15px">Yearly Summary</h3>
        <table id="fees-yearly-summary">
          <thead><tr><th>Month</th><th>Paid Members</th><th>Total Collected (‚Çπ)</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Collectors -->
    <div class="card" id="collectors">
      <h2>üì¨ Donation Collectors</h2>
      <div class="subtitle">Assign areas and track bills (amounts count towards Total Collected)</div>

      <div style="display:flex;gap:12px;margin-top:12px;align-items:center">
        <input id="search-collectors" type="text" placeholder="Search collectors..." style="flex:1" />
        <div class="muted">Admin can add/edit/delete</div>
      </div>

      <table id="collector-table" style="margin-top:12px">
        <thead><tr><th>Name</th><th>Assigned Area</th><th>Bill No</th><th>Mobile No</th><th>Collected (‚Çπ)</th><th>Remarks</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>

      <div style="margin-top:12px">
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <input id="col-name" type="text" placeholder="Name" style="min-width:160px" />
          <input id="col-area" type="text" placeholder="Assigned Area (comma separated)" style="min-width:160px" />
          <input id="col-bill" type="text" placeholder="Bill No" style="min-width:120px" />
          <input id="col-mobile" type="text" placeholder="Mobile No" style="min-width:120px" />
          <input id="col-amount" type="number" placeholder="Collected Amount (‚Çπ)" style="min-width:140px" />
          <input id="col-remarks" type="text" placeholder="Remarks" style="min-width:200px" />
          <button id="add-col-btn" class="btn small">Add Collector</button>
        </div>
      </div>
    </div>

  </div> <!-- main-content -->
</div> <!-- container -->

<!-- Toast container -->
<div id="toast-container" aria-live="polite" aria-atomic="true"></div>

<script>
/* ---------------- Firebase config (hardcoded) ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyCuVs6jx7HiNIx25lzLgoq1B6nQqaHLHm0",
  authDomain: "guestandcollection.firebaseapp.com",
  projectId: "guestandcollection",
  storageBucket: "guestandcollection.firebasestorage.app",
  messagingSenderId: "272278233160",
  appId: "1:272278233160:web:d6d1e6a7d58be260d9b87d",
  measurementId: "G-B5783XTFSP"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ---------------- Roles & constants ---------------- */
const ROLES = {
  "fRpLuiBgU0ZE1AtVmkGaA1RhBJk2": "admin",
  "898Fi5sPKHY01GUgI4iu1xS4TBR2": "viewer"
};
let currentRole = "viewer";
const MONTHS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

/* ---------------- collections (static) ---------------- */
const invitationCol = db.collection("invitations");
const membersCol = db.collection("members");
const collectorsCol = db.collection("collectors");
/* membership_fees flat per-year: membership_fees_2025, membership_fees_2026, ... */
function membershipFeesCollectionFor(year){ return db.collection(`membership_fees_${year}`); }

/* ---------------- Toast helper (bottom-right) ---------------- */
const toastContainer = document.getElementById('toast-container');
function showToast(type='info', message='') {
  try {
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.innerHTML = `<div style="font-weight:700;margin-right:4px">${type==='success'?'‚úÖ':type==='error'?'‚ùå':'‚ö†Ô∏è'}</div><div style="flex:1">${message}</div>`;
    toastContainer.appendChild(t);
    // small delay to allow transition
    setTimeout(()=> t.classList.add('show'), 10);
    // remove after 3.5s
    setTimeout(()=> {
      t.classList.remove('show');
      setTimeout(()=> t.remove(), 300);
    }, 3500);
  } catch(e) { console.error("Toast error", e); }
}

/* small convenience for success & error */
function toastSuccess(msg){ showToast('success', msg); }
function toastError(msg){ showToast('error', msg); }
function toastInfo(msg){ showToast('info', msg); }

/* ---------------- fee-year dropdown two selectors (2025-2050) ---------------- */
const feeYearSmall = document.getElementById('feeYearSelectSmall');
const feeYearSmall2 = document.getElementById('feeYearSelectSmall2');
const now = new Date().getFullYear();
for(let y=2025;y<=2050;y++){
  const o=document.createElement('option'); o.value=y; o.textContent=y;
  if(y===now){ o.selected=true; }
  feeYearSmall.appendChild(o);
}
let selectedFeeYear = parseInt(feeYearSmall.value || 2025);

/* connect second year select used inside fees card */
(function populateFeeYearSelect2(){
  const sel = document.getElementById('feeYearSelectSmall2');
  if(!sel) return;
  sel.innerHTML = '';
  for(let y=2025;y<=2050;y++){
    const o=document.createElement('option'); o.value=y; o.textContent=y;
    if(y===now) o.selected=true;
    sel.appendChild(o);
  }
  sel.addEventListener('change', ()=> {
    selectedFeeYear = parseInt(sel.value);
    loadFeeMembersDropdown(); loadFeeMonthsTable(); loadFeeYearlySummary(); updateTotalCollectedSummary();
    toastInfo('Fees year changed to ' + selectedFeeYear);
  });
})();

feeYearSmall.addEventListener('change', ()=> {
  selectedFeeYear = parseInt(feeYearSmall.value);
  loadFeeMembersDropdown(); loadFeeMonthsTable(); loadFeeYearlySummary(); updateTotalCollectedSummary();
  toastInfo('Fees year changed to ' + selectedFeeYear);
});

/* ---------------- UI elements ---------------- */
const loginBtn = document.getElementById("login-btn");
const logoutBtn = document.getElementById("logout-btn");
const userInfo = document.getElementById("user-info");
const mainContent = document.getElementById("main-content");

/* ---------------- Auth handlers ---------------- */
loginBtn.addEventListener("click", () => {
  const email = document.getElementById("email").value.trim();
  const pw = document.getElementById("password").value;
  if(!email || !pw) { toastError("Enter email and password"); return; }
  loginBtn.disabled = true;
  auth.signInWithEmailAndPassword(email,pw)
    .then(()=> toastSuccess("Logged in"))
    .catch(e => { console.error(e); toastError("Login error: "+e.message); })
    .finally(()=> loginBtn.disabled = false);
});
logoutBtn.addEventListener("click", () => {
  logoutBtn.disabled = true;
  auth.signOut().then(()=> toastSuccess("Logged out")).catch(e => { console.error(e); toastError("Logout error: "+e.message); }).finally(()=> logoutBtn.disabled = false);
});

/* auth state listener */
auth.onAuthStateChanged(user => {
  if(user){
    currentRole = ROLES[user.uid] || "viewer";
    document.getElementById("email").style.display="none";
    document.getElementById("password").style.display="none";
    loginBtn.style.display="none";
    logoutBtn.classList.remove("hidden");
    mainContent.classList.remove("hidden");
    userInfo.textContent = `${user.email} (${currentRole})`;
    applyRoleToUI();
    setTimeout(()=>{ loadAllData(); loadFeeMembersDropdown(); loadFeeYearlySummary(); updateTotalCollectedSummary(); }, 120);
  } else {
    document.getElementById("email").style.display="";
    document.getElementById("password").style.display="";
    loginBtn.style.display="";
    logoutBtn.classList.add("hidden");
    mainContent.classList.add("hidden");
    userInfo.textContent = "";
    clearAllTables();
  }
});

/* ui role enforcement */
function applyRoleToUI(){
  ["add-inv-btn","add-mem-btn","add-col-btn","loadMemberFeeBtn","saveFeeConfigBtn","clearFeeRecordBtn","removeDuplicatesBtn"].forEach(id=>{
    const el=document.getElementById(id); if(el) el.disabled = (currentRole !== "admin");
  });
  // show duplicate remover only to admin
  document.getElementById("removeDuplicatesDiv").style.display = (currentRole === "admin") ? "block" : "none";
}

/* helpers */
function escapeHtml(s){ return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
function filterTable(tableId, term){
  const rows=document.getElementById(tableId).querySelectorAll("tbody tr");
  const q=(term||"").toLowerCase();
  rows.forEach(r=> r.style.display = r.innerText.toLowerCase().includes(q) ? "" : "none");
}
function clearAllTables(){
  ["invitation-table","members-table","collector-table","monthly-summary-table","fee-months-table","fees-yearly-summary"].forEach(id=>{
    const tb=document.getElementById(id)?.querySelector("tbody");
    if(tb) tb.innerHTML="";
  });
  document.getElementById("summary-invitees").textContent="‚Äî";
  document.getElementById("summary-members").textContent="‚Äî";
  document.getElementById("summary-collection").textContent="‚Çπ0 (0 Paid Members)";
  document.getElementById("summary-pending").textContent="‚Äî";

  // sticky
  document.getElementById("sticky-invitees").textContent = "‚Äî";
  document.getElementById("sticky-members").textContent = "‚Äî";
  document.getElementById("sticky-collected").textContent = "‚Çπ0";
  document.getElementById("sticky-paid").textContent = "0";
}

/* ---------------- Load all static data ---------------- */
function loadAllData(){
  loadInvitations();
  loadMembers();
  loadCollectors();
  updateMonthlySummary();
}

/* ---------------- INVITATIONS ---------------- */
document.getElementById("add-inv-btn").addEventListener("click", async () => {
  if(currentRole !== "admin") return toastError("Only admin can add");
  const name = document.getElementById("inv-name").value.trim();
  const village = document.getElementById("inv-village").value.trim();
  const mobile = document.getElementById("inv-mobile").value.trim();
  const remarks = document.getElementById("inv-remarks").value.trim();
  if(!name || !village) return toastError("Name & Village required");
  try {
    let dupQuery = invitationCol.where("name","==",name);
    if(mobile) dupQuery = dupQuery.where("mobile","==",mobile);
    const dup = await dupQuery.get();
    if(!dup.empty && !confirm("Possible duplicate found. Add anyway?")) return;

    await invitationCol.add({
      name, village, mobile, remarks,
      sent: false,
      dateAdded: firebase.firestore.FieldValue.serverTimestamp()
    });
    ["inv-name","inv-village","inv-mobile","inv-remarks"].forEach(id=>document.getElementById(id).value="");
    toastSuccess("Invitation added");
    loadInvitations();
  } catch(err){
    console.error("Add invitation error:", err);
    toastError("Failed to add invitation: " + (err.message || err));
  }
});

async function loadInvitations(){
  const tbody = document.querySelector("#invitation-table tbody");
  tbody.innerHTML = "";
  try {
    const snapshot = await invitationCol.orderBy("dateAdded","desc").get();
    let total=0, sent=0;
    snapshot.forEach(doc => {
      total++;
      const d = doc.data();
      if(d.sent) sent++;
      const tr = document.createElement("tr");
      const sentHtml = d.sent ? '<span class="badge sent">Sent</span>' : '<span class="badge pending">Pending</span>';
      tr.innerHTML = `
        <td class="${currentRole==='admin'?'editable':''}" contenteditable="${currentRole==='admin'}">${escapeHtml(d.name||"")}</td>
        <td class="${currentRole==='admin'?'editable':''}" contenteditable="${currentRole==='admin'}">${escapeHtml(d.village||"")}</td>
        <td class="${currentRole==='admin'?'editable':''}" contenteditable="${currentRole==='admin'}">${escapeHtml(d.mobile||"")}</td>
        <td class="${currentRole==='admin'?'editable':''}" contenteditable="${currentRole==='admin'}">${escapeHtml(d.remarks||"")}</td>
        <td class="center">${sentHtml}</td>
        <td>${d.dateAdded && d.dateAdded.toDate ? d.dateAdded.toDate().toLocaleString() : ""}</td>
        <td></td>
      `;
      tbody.appendChild(tr);

      const actionsTd = tr.querySelector("td:last-child");
      if(currentRole==="admin"){
        const toggleBtn = document.createElement("button");
        toggleBtn.textContent = d.sent ? "Mark Pending" : "Mark Sent";
        toggleBtn.className = "btn small";
        toggleBtn.onclick = async () => {
          try {
            await doc.ref.update({sent: !d.sent});
            // animate badge: find badge cell and add pulse
            const badgeCell = tr.querySelector("td:nth-child(5) .badge");
            if(badgeCell){
              badgeCell.classList.add('pulse');
              setTimeout(()=> badgeCell.classList.remove('pulse'), 1000);
            }
            toastSuccess(d.sent ? "Marked pending" : "Marked sent");
            loadInvitations();
          } catch(err) { console.error(err); toastError("Update failed: "+(err.message||err)); }
        };
        actionsTd.appendChild(toggleBtn);

        const delBtn = document.createElement("button");
        delBtn.style.marginLeft = "8px";
        delBtn.textContent = "Delete";
        delBtn.className = "btn small ghost";
        delBtn.onclick = () => { if(confirm("Delete invitation?")) { doc.ref.delete().then(()=>{ toastSuccess("Invitation deleted"); loadInvitations(); }); } };
        actionsTd.appendChild(delBtn);

        const editableCells = tr.querySelectorAll("td[contenteditable='true']");
        editableCells.forEach((cell, idx) => {
          const fieldMap = ["name","village","mobile","remarks"];
          cell.onblur = async () => {
            try {
              const val = cell.textContent.trim();
              const update = {}; update[fieldMap[idx]] = val;
              await doc.ref.update(update);
              toastSuccess("Saved");
            } catch(e) { console.error("Save edit error:", e); toastError("Save failed: "+(e.message||e)); }
            loadInvitations();
          };
        });
      }
    });
    document.getElementById("summary-invitees").textContent = `Invitees: ${total} | Sent: ${sent} | Pending: ${total-sent}`;
    document.getElementById("sticky-invitees").textContent = `${total} (Sent: ${sent})`;
  } catch(e){
    console.error("Load invitations error:", e);
    toastError("Failed to load invitations: " + (e.message || e));
  }
}

/* invitation search */
document.getElementById("search-invite").addEventListener("input", (e)=>{
  filterTable("invitation-table", e.target.value);
});

/* ---------------- MEMBERS ---------------- */
document.getElementById("add-mem-btn").addEventListener("click", async () => {
  if(currentRole !== "admin") return toastError("Only admin can add members");
  const name = document.getElementById("mem-name").value.trim();
  const village = document.getElementById("mem-village").value.trim();
  const mobile = document.getElementById("mem-mobile").value.trim();
  const remarks = document.getElementById("mem-remarks").value.trim();
  if(!name || !mobile) return toastError("Name & Mobile required");
  try {
    const dup = await membersCol.where("name","==",name).where("mobile","==",mobile).get();
    if(!dup.empty && !confirm("Possible duplicate member. Add anyway?")) return;
    await membersCol.add({name,village,mobile,remarks,dateAdded:firebase.firestore.FieldValue.serverTimestamp()});
    ["mem-name","mem-village","mem-mobile","mem-remarks"].forEach(id=>document.getElementById(id).value="");
    toastSuccess("Member added");
    loadMembers(); loadFeeMembersDropdown(); updateTotalCollectedSummary();
  } catch(e){
    console.error("Add member error:", e);
    toastError("Failed to add member: " + (e.message || e));
  }
});

async function loadMembers(){
  const tbody = document.querySelector("#members-table tbody");
  tbody.innerHTML = "";
  try {
    const snapshot = await membersCol.orderBy("name").get();
    let total=0;
    snapshot.forEach(docSnap => {
      total++;
      const d = docSnap.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td contenteditable="${currentRole==='admin'}" class="${currentRole==='admin'?'editable':''}">${escapeHtml(d.name||"")}</td>
        <td contenteditable="${currentRole==='admin'}" class="${currentRole==='admin'?'editable':''}">${escapeHtml(d.village||"")}</td>
        <td contenteditable="${currentRole==='admin'}" class="${currentRole==='admin'?'editable':''}">${escapeHtml(d.mobile||"")}</td>
        <td contenteditable="${currentRole==='admin'}" class="${currentRole==='admin'?'editable':''}">${escapeHtml(d.remarks||"")}</td>
        <td></td>
      `;
      tbody.appendChild(tr);

      const actionsTd = tr.querySelector("td:last-child");
      if(currentRole==="admin"){
        const del = document.createElement("button");
        del.textContent = "Delete";
        del.className = "btn small ghost";
        del.onclick = () => { if(confirm("Delete member?")) docSnap.ref.delete().then(()=>{ toastSuccess("Member deleted"); loadMembers(); loadFeeMembersDropdown(); updateTotalCollectedSummary(); }); };
        actionsTd.appendChild(del);

        const editable = tr.querySelectorAll("td[contenteditable='true']");
        editable.forEach((cell, idx) => {
          const map = ["name","village","mobile","remarks"];
          cell.onblur = async () => {
            try { const val = cell.textContent.trim(); const upd = {}; upd[map[idx]] = val; await membersCol.doc(docSnap.id).update(upd); loadFeeMembersDropdown(); toastSuccess("Saved"); } catch(e) { console.error(e); toastError("Save failed: "+(e.message||e)); }
          };
        });
      }
    });
    document.getElementById("summary-members").textContent = `Members: ${total}`;
    document.getElementById("sticky-members").textContent = `${total}`;
  } catch(e){
    console.error("Load members error:", e);
    toastError("Failed to load members: " + (e.message || e));
  }
}
document.getElementById("search-members").addEventListener("input",(e)=> filterTable("members-table", e.target.value));

/* ---------------- Collectors (with bill no, mobile, remarks, collected amount) ---------------- */
document.getElementById("add-col-btn").addEventListener("click", async ()=>{
  if(currentRole!=="admin") return toastError("Only admin can add");
  const name=document.getElementById("col-name").value.trim();
  const area=document.getElementById("col-area").value.trim();
  const bill=document.getElementById("col-bill").value.trim();
  const mobile=document.getElementById("col-mobile").value.trim();
  const amount = Number(document.getElementById("col-amount").value) || 0;
  const remarks=document.getElementById("col-remarks").value.trim();
  if(!name||!area) return toastError("Name & area required");
  try{
    const dup=await collectorsCol.where("name","==",name).where("area","==",area).get();
    if(!dup.empty && !confirm("Possible duplicate. Add anyway?")) return;
    await collectorsCol.add({name,area,bill,mobile,amount,remarks,dateAdded:firebase.firestore.FieldValue.serverTimestamp()});
    ["col-name","col-area","col-bill","col-mobile","col-amount","col-remarks"].forEach(id=>document.getElementById(id).value="");
    loadCollectors();
    updateTotalCollectedSummary();
    toastSuccess("Collector added");
  }catch(e){ console.error(e); toastError("Add collector failed: "+(e.message||e)); }
});

async function loadCollectors(){
  const tbody=document.querySelector("#collector-table tbody"); tbody.innerHTML="";
  try{
    const snap=await collectorsCol.orderBy("name").get();
    snap.forEach(docSnap=>{
      const d=docSnap.data();
      const tr=document.createElement("tr");
      tr.innerHTML=`<td contenteditable="${currentRole==='admin'}" class="${currentRole==='admin'?'editable':''}">${escapeHtml(d.name||"")}</td>
                    <td contenteditable="${currentRole==='admin'}" class="${currentRole==='admin'?'editable':''}">${escapeHtml(d.area||"")}</td>
                    <td contenteditable="${currentRole==='admin'}" class="${currentRole==='admin'?'editable':''}">${escapeHtml(d.bill||"")}</td>
                    <td contenteditable="${currentRole==='admin'}" class="${currentRole==='admin'?'editable':''}">${escapeHtml(d.mobile||"")}</td>
                    <td contenteditable="${currentRole==='admin'}" class="${currentRole==='admin'?'editable':''}">‚Çπ${Number(d.amount||0)}</td>
                    <td contenteditable="${currentRole==='admin'}" class="${currentRole==='admin'?'editable':''}">${escapeHtml(d.remarks||"")}</td>
                    <td></td>`;
      tbody.appendChild(tr);
      if(currentRole==="admin"){
        const del=document.createElement("button"); del.textContent="Delete"; del.className="btn small ghost";
        del.onclick=()=>{ if(confirm("Delete collector?")) docSnap.ref.delete().then(()=>{ loadCollectors(); updateTotalCollectedSummary(); toastSuccess("Collector deleted"); }); };
        tr.querySelector("td:last-child").appendChild(del);

        const editable = tr.querySelectorAll("td[contenteditable='true']");
        editable.forEach((cell, idx)=>{
          // mapping: name, area, bill, mobile, amount (displayed with ‚Çπ), remarks
          cell.onblur = async () => {
            try {
              const raw = cell.textContent.trim();
              const map = ["name","area","bill","mobile","amount","remarks"];
              let val = raw;
              if(map[idx] === "amount"){
                // remove non-numeric chars like ‚Çπ and commas
                const numeric = raw.replace(/[^\d.-]/g,'').trim();
                val = numeric === "" ? 0 : Number(numeric);
              }
              const upd = {}; upd[map[idx]] = val;
              await collectorsCol.doc(docSnap.id).update(upd);
              loadCollectors();
              updateTotalCollectedSummary();
              toastSuccess("Collector saved");
            } catch(e){ console.error("Save collector edit error:", e); toastError("Save failed: "+(e.message||e)); }
          };
        });
      }
    });
  }catch(e){ console.error(e); toastError("Load collectors failed: "+(e.message||e)); }
}
document.getElementById("search-collectors").addEventListener("input",(e)=> filterTable("collector-table", e.target.value));

/* ---------------- Monthly summary placeholder ---------------- */
async function updateMonthlySummary(){
  // placeholder (backwards compatibility)
}

/* ---------------- Membership Fees (flat per-year collections) ---------------- */

/* fee members dropdown (duplicate-safe) */
const feeMemberSelect = document.getElementById('feeMemberSelect');
async function loadFeeMembersDropdown(){
  feeMemberSelect.innerHTML = '<option value="">-- Select member --</option>';
  const seen = new Set(); // Track duplicates using mobile+name
  try {
    const snap = await membersCol.orderBy("name").get();
    snap.forEach(docSnap => {
      const d = docSnap.data();
      const key = ((d.mobile || "") + "|" + (d.name || "")).trim().toLowerCase();
      if (!seen.has(key)) {
        seen.add(key);
        const opt = document.createElement('option');
        opt.value = docSnap.id;
        opt.textContent = `${d.name} ‚Äî ${d.mobile || ''}`;
        feeMemberSelect.appendChild(opt);
      }
    });
    // No alert by default; duplicate remover available for admin.
  } catch (e) {
    console.error("Load fee members failed:", e);
    toastError("Failed to load fee members");
  }
}

/* load member fee months */
document.getElementById("loadMemberFeeBtn").addEventListener("click", loadFeeMonthsTable);
async function loadFeeMonthsTable(){
  const memberId = feeMemberSelect.value;
  const feeAmount = Number(document.getElementById("feeAmountInput").value) || 100;
  const tbody = document.querySelector("#fee-months-table tbody");
  tbody.innerHTML = "";
  if(!memberId){ document.getElementById("fee-member-summary").textContent = "Select a member"; return; }

  try{
    const feesCol = membershipFeesCollectionFor(selectedFeeYear);
    const docRef = feesCol.doc(memberId);
    const docSnap = await docRef.get();
    let record = docSnap.exists ? docSnap.data() : null;
    if(!record){
      const monthsInit = {}; MONTHS.forEach(m=> monthsInit[m] = { paid:false, paidAt:null });
      record = { memberId, months: monthsInit, feeAmount };
    }

    let paidCount = 0;
    MONTHS.forEach(m=>{
      const info = record.months && record.months[m] ? record.months[m] : { paid:false, paidAt:null };
      if(info.paid) paidCount++;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${m}</td>
        <td class="center">${info.paid ? '<span class="badge sent">‚úÖ Paid</span>' : '<span class="badge pending">‚Äî</span>'}</td>
        <td class="center">${info.paid && info.paidAt ? new Date(info.paidAt.seconds ? info.paidAt.seconds*1000 : info.paidAt).toLocaleString() : ''}</td>
        <td class="center"></td>
      `;
      tbody.appendChild(tr);

      const actionTd = tr.querySelector("td:last-child");
      const cb = document.createElement("input"); cb.type="checkbox"; cb.checked = !!info.paid; cb.disabled = (currentRole!=="admin");
      cb.addEventListener("change", async ()=>{
        if(currentRole!=="admin"){ cb.checked = !cb.checked; return toastError("Only admin can change payments"); }
        try{
          if(!docSnap.exists){
            const monthsInit = {}; MONTHS.forEach(mm=> monthsInit[mm] = { paid:false, paidAt:null });
            await docRef.set({ memberId, year: selectedFeeYear, months: monthsInit, feeAmount });
          }
          const updatePaid = {}; updatePaid[`months.${m}.paid`] = cb.checked;
          const updatePaidAt = {}; updatePaidAt[`months.${m}.paidAt`] = cb.checked ? firebase.firestore.FieldValue.serverTimestamp() : null;
          await docRef.update(updatePaid);
          await docRef.update(updatePaidAt);
          // animate the badge in this row
          setTimeout(()=> { loadFeeMonthsTable(); loadFeeYearlySummary(); updateTotalCollectedSummary(); }, 120);
          toastSuccess(cb.checked ? `Marked ${m} paid` : `Marked ${m} unpaid`);
        }catch(err){ console.error("Toggle paid error:", err); toastError("Failed to update: "+(err.message||err)); cb.checked = !cb.checked; }
      });
      actionTd.appendChild(cb);
    });

    const totalPaid = paidCount * feeAmount;
    document.getElementById("fee-member-summary").textContent = `Paid months: ${paidCount}/12 ‚Äî Total: ‚Çπ${totalPaid}`;
  }catch(e){ console.error("Load fee months error:", e); toastError("Failed to load fees: "+(e.message||e)); }
}

/* Save fee config (create or update feeAmount) */
document.getElementById("saveFeeConfigBtn").addEventListener("click", async ()=>{
  const memberId = feeMemberSelect.value; const feeAmount = Number(document.getElementById("feeAmountInput").value) || 100;
  if(!memberId) return toastError("Select a member");
  try{
    const feesCol = membershipFeesCollectionFor(selectedFeeYear);
    const docRef = feesCol.doc(memberId);
    const docSnap = await docRef.get();
    if(!docSnap.exists){
      const monthsInit = {}; MONTHS.forEach(m=> monthsInit[m] = { paid:false, paidAt:null });
      await docRef.set({ memberId, year: selectedFeeYear, months: monthsInit, feeAmount });
    } else {
      await docRef.update({ feeAmount });
    }
    toastSuccess("Fee configuration saved");
    loadFeeMonthsTable(); loadFeeYearlySummary(); updateTotalCollectedSummary();
  }catch(e){ console.error("Save fee config error:", e); toastError("Failed to save fee config: "+(e.message||e)); }
});

/* Clear member fee record */
document.getElementById("clearFeeRecordBtn").addEventListener("click", async ()=>{
  if(currentRole!=="admin") return toastError("Only admin can clear fees");
  const memberId = feeMemberSelect.value; if(!memberId) return toastError("Select a member");
  if(!confirm("Clear all fee records for this member and year?")) return;
  try{
    const docRef = membershipFeesCollectionFor(selectedFeeYear).doc(memberId);
    const snap = await docRef.get();
    if(snap.exists) await docRef.delete();
    toastSuccess("Cleared");
    loadFeeMonthsTable(); loadFeeYearlySummary(); updateTotalCollectedSummary();
  }catch(e){ console.error(e); toastError("Failed to clear: "+(e.message||e)); }
});

/* Yearly aggregated summary for fees (selected year) */
async function loadFeeYearlySummary(){
  const tbody = document.querySelector("#fees-yearly-summary tbody"); if(!tbody) return; tbody.innerHTML="";
  try{
    const feesCol = membershipFeesCollectionFor(selectedFeeYear);
    const snap = await feesCol.get();
    const monthCounts = {}; MONTHS.forEach(m=> monthCounts[m] = { paid:0, total:0 });
    snap.forEach(docSnap=>{
      const d = docSnap.data(); const feeAmt = d.feeAmount || Number(document.getElementById("feeAmountInput").value) || 100;
      const monthsObj = d.months || {};
      MONTHS.forEach(m=>{
        if(monthsObj[m] && monthsObj[m].paid){ monthCounts[m].paid++; monthCounts[m].total += feeAmt; }
      });
    });
    MONTHS.forEach(m=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `<td>${m}</td><td class="center">${monthCounts[m].paid}</td><td class="center">‚Çπ${monthCounts[m].total}</td>`;
      tbody.appendChild(tr);
    });
    // update total collected summary as well
    updateTotalCollectedSummary();
  }catch(e){ console.error("Fee yearly summary error:", e); toastError("Fees summary failed"); }
}

/* ---------------- NEW: compute total collected and paid members for selected year
   - totalCollected = sum_over_members( feeAmount * number_of_paid_months ) + sum_over_collectors(amount)
   - paidMembersCount = count_members_with_at_least_one_paid_month
*/
async function updateTotalCollectedSummary(){
  try{
    const feesCol = membershipFeesCollectionFor(selectedFeeYear);
    const [feeSnap, collectorsSnap, membersSnap] = await Promise.all([feesCol.get(), collectorsCol.get(), membersCol.get()]);
    let totalCollected = 0;
    let paidMembersCount = 0;
    let totalPaidMonthsAcrossAll = 0;

    feeSnap.forEach(docSnap=>{
      const d = docSnap.data() || {};
      const feeAmt = d.feeAmount || Number(document.getElementById("feeAmountInput").value) || 100;
      const months = d.months || {};
      let paidMonths = 0;
      for(const m of MONTHS){
        if(months[m] && months[m].paid) paidMonths++;
      }
      if(paidMonths > 0) paidMembersCount++;
      totalCollected += paidMonths * feeAmt;
      totalPaidMonthsAcrossAll += paidMonths;
    });

    // sum collectors amounts
    let collectorsTotal = 0;
    collectorsSnap.forEach(cs => {
      const a = Number(cs.data().amount || 0);
      if(!isNaN(a)) collectorsTotal += a;
    });

    totalCollected += collectorsTotal;

    // Format currency with comma separators (IN)
    const formatted = totalCollected.toLocaleString('en-IN');
    document.getElementById("summary-collection").textContent = `‚Çπ${formatted} (${paidMembersCount} Paid Member${paidMembersCount===1?'':'s'})`;

    const totalMembers = membersSnap.size;
    const unpaidMonths = (totalMembers * 12) - totalPaidMonthsAcrossAll;
    document.getElementById("summary-pending").textContent = `${unpaidMonths} unpaid months`;

    // update sticky
    document.getElementById("sticky-collected").textContent = `‚Çπ${formatted}`;
    document.getElementById("sticky-paid").textContent = `${paidMembersCount}`;
    // update small sticky invite / members values as well (if empty)
    if(document.getElementById("sticky-invitees").textContent.trim() === '‚Äî') document.getElementById("sticky-invitees").textContent = document.getElementById("summary-invitees").textContent || '‚Äî';
    if(document.getElementById("sticky-members").textContent.trim() === '‚Äî') document.getElementById("sticky-members").textContent = document.getElementById("summary-members").textContent || '‚Äî';
  }catch(e){
    console.error("Update total collected error:", e);
    document.getElementById("summary-collection").textContent = "‚Çπ0 (0 Paid Members)";
    document.getElementById("summary-pending").textContent = "‚Äî";
    toastError("Failed to update total collected");
  }
}

/* ---------------- Export CSV for selected fees year (all members) ---------------- */
document.getElementById("exportCsvBtn").addEventListener("click", async ()=>{
  try{
    const year = selectedFeeYear;
    const feesCol = membershipFeesCollectionFor(year);
    // load all members (master member info)
    const membersSnap = await membersCol.orderBy("name").get();
    // load fees for the year (map by memberId)
    const feeSnap = await feesCol.get();
    const feeMap = {};
    feeSnap.forEach(fs => feeMap[fs.id] = fs.data());
    // assemble CSV rows: Name, Village, Mobile, Remarks, Paid Months Count, Total Paid (‚Çπ), Last Paid Date
    const rows = [];
    rows.push(["Name","Village","Mobile","Remarks","Paid Months Count","Total Paid (‚Çπ)","Last Paid Date"]);
    membersSnap.forEach(mDoc=>{
      const m = mDoc.data();
      const memberId = mDoc.id;
      const feeRec = feeMap[memberId] || { months: {} , feeAmount: Number(document.getElementById("feeAmountInput").value) || 100};
      const monthsObj = feeRec.months || {};
      let paidCount = 0;
      let latestPaidAt = null;
      for(const mm of MONTHS){
        if(monthsObj[mm] && monthsObj[mm].paid){
          paidCount++;
          if(monthsObj[mm].paidAt){
            const t = monthsObj[mm].paidAt.seconds ? monthsObj[mm].paidAt.seconds*1000 : monthsObj[mm].paidAt;
            if(!latestPaidAt || t > latestPaidAt) latestPaidAt = t;
          }
        }
      }
      const feeAmt = feeRec.feeAmount || Number(document.getElementById("feeAmountInput").value) || 100;
      const totalPaid = paidCount * feeAmt;
      const paidDateStr = latestPaidAt ? new Date(latestPaidAt).toLocaleString() : "";
      rows.push([m.name || "", m.village || "", m.mobile || "", m.remarks || "", paidCount, totalPaid, paidDateStr]);
    });

    // convert to CSV text
    const csvContent = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(",")).join("\n");
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const filename = `MembershipFees_${year}.csv`;
    if (navigator.msSaveBlob) { navigator.msSaveBlob(blob, filename); }
    else {
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      link.setAttribute("href", url);
      link.setAttribute("download", filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      setTimeout(()=> URL.revokeObjectURL(url), 1000);
    }
    toastSuccess("CSV exported");
  }catch(e){
    console.error("Export CSV error:", e);
    toastError("Failed to export CSV: " + (e.message || e));
  }
});

/* ---------------- fee dropdown load */
loadFeeMembersDropdown();

/* initial loads if already logged in */
setTimeout(()=>{ if(auth.currentUser){ loadAllData(); loadFeeMembersDropdown(); loadFeeYearlySummary(); updateTotalCollectedSummary(); } }, 200);

/* small feature: navigation links scroll to sections and highlight */
function clearActiveNav(){ document.querySelectorAll('nav.topbar a').forEach(a=>a.classList.remove('active')); }
document.getElementById("nav-invitations").addEventListener("click", (e)=>{ e.preventDefault(); document.getElementById("invitations").scrollIntoView({behavior:"smooth"}); clearActiveNav(); document.getElementById("nav-invitations").classList.add('active'); });
document.getElementById("nav-members").addEventListener("click", (e)=>{ e.preventDefault(); document.getElementById("members").scrollIntoView({behavior:"smooth"}); clearActiveNav(); document.getElementById("nav-members").classList.add('active'); });
document.getElementById("nav-collectors").addEventListener("click", (e)=>{ e.preventDefault(); document.getElementById("collectors").scrollIntoView({behavior:"smooth"}); clearActiveNav(); document.getElementById("nav-collectors").classList.add('active'); });
document.getElementById("nav-fees").addEventListener("click", (e)=>{ e.preventDefault(); document.getElementById("fees").scrollIntoView({behavior:"smooth"}); clearActiveNav(); document.getElementById("nav-fees").classList.add('active'); });

/* ---------------- Duplicate remover (simple) logic (admin only) ---------------- */
document.addEventListener("DOMContentLoaded", () => {
  const adminUID = "fRpLuiBgU0ZE1AtVmkGaA1RhBJk2";
  const removeBtn = document.getElementById("removeDuplicatesBtn");
  const removeDiv = document.getElementById("removeDuplicatesDiv");
  const progress = document.getElementById("removeProgress");
  const progressBar = document.getElementById("removeProgressBar");
  let duplicates = [];

  firebase.auth().onAuthStateChanged(user => {
    removeDiv.style.display = user && user.uid === adminUID ? "block" : "none";
  });

  removeBtn && removeBtn.addEventListener("click", async ()=>{
    if(currentRole !== "admin") return toastError("Only admin can run duplicate remover");
    try{
      progress.style.display = "block";
      progressBar.style.width = "0%";
      const snap = await membersCol.get();
      const seen = new Map();
      duplicates = [];
      let processed = 0;
      snap.forEach(doc => {
        const d = doc.data();
        const key = ((d.name||"").trim().toLowerCase() + "|" + (d.mobile||"").trim().toLowerCase());
        if(seen.has(key)){
          duplicates.push({ id: doc.id, ...d });
        } else {
          seen.set(key, doc.id);
        }
        processed++;
        progressBar.style.width = ((processed / snap.size) * 100).toFixed(1) + "%";
      });
      progress.style.display = "none";
      if(duplicates.length === 0){
        toastInfo("No duplicates found.");
        return;
      }
      const list = duplicates.map(d => `${d.name} ‚Äî ${d.mobile} (${d.village||''})`).join("\n");
      if(confirm("Found duplicates:\n\n" + list + "\n\nDelete these duplicates?")){
        // delete duplicates
        const batch = db.batch();
        duplicates.forEach(d => batch.delete(membersCol.doc(d.id)));
        await batch.commit();
        toastSuccess(`Deleted ${duplicates.length} duplicates.`);
        loadMembers();
        loadFeeMembersDropdown();
        updateTotalCollectedSummary();
      }
    }catch(e){
      progress.style.display = "none";
      console.error(e);
      toastError("Duplicate check failed: " + (e.message||e));
    }
  });
});

</script>
</body>
</html>
