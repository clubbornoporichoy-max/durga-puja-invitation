<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Club Bornoporichoy ‚Äî Durga Puja Dashboard</title>

<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<!-- Firebase compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --primary-red: #B71C1C;
    --deep-red: #a31313;
    --accent-gold: #D4AF37;
    --bg-start: #ffffff;
    --bg-end: #f7f0e8; /* soft beige */
    --card: #ffffff;
    --muted: #6b6b6b;
    --text: #2f2f2f;
    --radius: 12px;
    --shadow: 0 10px 30px rgba(17,17,17,0.06);
    --glass: rgba(255,255,255,0.6);
    --toast-bg: rgba(0,0,0,0.85);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body {
    margin: 0;
    background: linear-gradient(180deg, var(--bg-start), var(--bg-end));
    color: var(--text);
    font-family: 'Poppins', system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    line-height:1.45;
  }

  /* Header / nav (fixed) */
  header {
    position: fixed; top:0; left:0; right:0; z-index:100;
    background: linear-gradient(90deg, rgba(255,255,255,0.96), rgba(255,250,240,0.96));
    border-bottom: 1px solid rgba(0,0,0,0.04);
    padding: 12px 18px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.05);
    backdrop-filter: blur(6px);
  }
  .header-inner { max-width:1200px; margin:0 auto; display:flex; gap:12px; align-items:center; }
  .brand { display:flex; align-items:center; gap:12px; }
  .logo {
    width:44px; height:44px; border-radius:10px;
    background: linear-gradient(135deg, var(--primary-red), #e34b4b);
    display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; box-shadow:0 4px 14px rgba(183,28,28,0.12);
  }
  .brand h1 { margin:0; font-size:16px; color:var(--deep-red); font-weight:700; letter-spacing:0.2px; }
  .brand .sub { font-size:12px; color:var(--muted); margin-top:2px; }

  nav.topbar { margin-left:20px; display:flex; gap:10px; align-items:center; flex:1; }
  nav.topbar a {
    padding:8px 12px; border-radius:10px; text-decoration:none; color:var(--deep-red);
    font-weight:600; font-size:14px; transition: all 160ms ease;
  }
  nav.topbar a:hover { transform: translateY(-2px); color: #7f0f0f; box-shadow: inset 0 -2px 0 var(--accent-gold); }
  nav.topbar a.active { background: rgba(183,28,28,0.06); }

  .auth-area { margin-left:auto; display:flex; gap:8px; align-items:center; }

  /* Global Year Selector */
  .global-year-selector {
    background: var(--accent-gold);
    padding: 8px 15px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: 20px;
  }
  .global-year-selector label {
    font-size: 13px;
    font-weight: 600;
    color: var(--text);
    white-space: nowrap;
  }
  .global-year-selector select {
    background: white;
    border: none;
    border-radius: 6px;
    padding: 6px 10px;
    font-weight: 600;
    color: var(--primary-red);
    min-width: 80px;
  }

  /* Container + cards */
  .spacer { height:92px } /* to offset fixed header */
  .container { max-width:1200px; margin:22px auto; padding:0 18px 80px; }
  .card { background:var(--card); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow); margin-bottom:18px; border:1px solid rgba(0,0,0,0.03); transition: transform 160ms ease, box-shadow 160ms ease; }
  .card:hover { transform: translateY(-4px); box-shadow: 0 18px 40px rgba(17,17,17,0.08); }
  .card h2 { margin:0 0 8px 0; color:var(--primary-red); font-size:18px; display:flex; align-items:center; gap:8px; }
  .subtitle { color:var(--muted); font-size:13px; margin-bottom:10px; }

  .flex { display:flex; gap:12px; align-items:center; }
  .flex.space { justify-content:space-between; }

  input[type="text"], input[type="email"], input[type="password"], input[type="number"], select, textarea {
    padding:10px 12px; border-radius:10px; border:1px solid rgba(0,0,0,0.06); background:#fff;
    font-size:14px; color:var(--text); outline:none;
  }
  input:focus, select:focus, textarea:focus { box-shadow: 0 8px 24px rgba(183,28,28,0.06); border-color: rgba(183,28,28,0.18); }

  /* Buttons */
  .btn { background:var(--primary-red); color:#fff; border:none; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:600; box-shadow: 0 8px 20px rgba(183,28,28,0.08); transition: transform 120ms ease, box-shadow 120ms ease; }
  .btn:hover{ transform: translateY(-2px); box-shadow: 0 14px 28px rgba(183,28,28,0.12); }
  .btn.small { padding:7px 10px; font-size:13px; border-radius:8px; }
  .btn.secondary { background:var(--accent-gold); color:#222; box-shadow:none; }
  .btn.ghost { background:transparent; color:var(--deep-red); border:1px solid rgba(0,0,0,0.06); box-shadow:none; }

  .muted { color:var(--muted); font-size:13px; }
  .note { font-size:13px; color:var(--muted); margin-top:8px; }

  /* Tables */
  table { width:100%; border-collapse:collapse; font-size:14px; margin-top:12px; }
  thead th {
    text-align:left; padding:12px 14px; background:linear-gradient(0deg,var(--accent-gold), #f6e9a8); color:var(--text); border-bottom:2px solid rgba(0,0,0,0.04);
  }
  tbody td { padding:12px 14px; border-bottom:1px solid rgba(0,0,0,0.04); vertical-align:middle; }
  tbody tr:hover { background: rgba(183,28,28,0.02); }
  .editable { background: linear-gradient(180deg,#fff8e6,#fffdf7); border-radius:6px; padding:8px; }
  .badge { display:inline-block; padding:6px 8px; border-radius:8px; font-weight:700; font-size:13px; transition: all 240ms ease; }
  .badge.ok { background:#28a745; color:#fff; animation: pulse 1200ms infinite ease-in-out; }
  .badge.warn { background:#ff8c00; color:#fff; }
  @keyframes pulse { 0% { transform: scale(1); opacity:1 } 50% { transform: scale(1.03); opacity:0.92 } 100% { transform: scale(1); opacity:1 } }

  .center { text-align:center; }
  .right { margin-left:auto; }

  /* Paid tracker icons */
  .paid-box { display:inline-block; width:20px; height:20px; line-height:20px; text-align:center; border-radius:4px; font-weight:700; }
  .paid-yes { background:#28a745; color:white; box-shadow: 0 4px 10px rgba(40,167,69,0.12); }
  .paid-no { background:#fff; color:#888; border:1px solid #eee; }

  /* Sticky summary bar below header */
  .summary-bar {
    position: fixed; top:64px; left:0; right:0; z-index:90;
    background: linear-gradient(90deg, rgba(255,255,255,0.97), rgba(255,250,240,0.97));
    border-bottom: 1px solid rgba(0,0,0,0.03);
    box-shadow: 0 6px 18px rgba(0,0,0,0.04);
    padding: 10px 18px;
  }
  .summary-inner { max-width:1200px; margin:0 auto; display:flex; gap:18px; align-items:center; }
  .summary-card { background: #fff; padding:10px 14px; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,0.03); display:flex; gap:8px; align-items:center; min-width:160px; }
  .summary-card .value { font-weight:700; color:var(--primary-red); }

  /* Toasts */
  .toast-container { position: fixed; bottom:20px; right:20px; z-index:9999; display:flex; flex-direction:column; gap:8px; }
  .toast {
    background: var(--toast-bg); color: #fff; padding:10px 14px; border-radius:8px; min-width:220px; box-shadow:0 8px 26px rgba(0,0,0,0.3);
    opacity:0; transform: translateY(10px); transition: all 300ms ease;
  }
  .toast.show { opacity:1; transform: translateY(0); }

  /* Summary Cards */
  .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
  .summary-card-item { text-align: center; background: var(--card); border-radius: var(--radius); padding: 15px; box-shadow: var(--shadow); }

  /* Village Breakdown */
  .village-breakdown { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 10px; }
  .breakdown-item { background: rgba(255,255,255,0.8); padding: 8px 12px; border-radius: 8px; border: 1px solid rgba(0,0,0,0.05); }
  .breakdown-label { font-size: 11px; color: var(--muted); margin-bottom: 4px; }
  .breakdown-value { font-weight: 700; color: var(--primary-red); font-size: 14px; }

  /* Quick Actions */
  .quick-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }

  /* Recent Activity */
  .activity-item { padding: 8px 12px; border-radius: 8px; margin-bottom: 8px; background: rgba(183,28,28,0.03); border-left: 3px solid var(--primary-red); }
  .activity-item.info { border-left-color: #17a2b8; }
  .activity-item.success { border-left-color: #28a745; }
  .activity-item.error { border-left-color: #dc3545; }

  /* Notifications */
  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    z-index: 10000;
    animation: slideIn 0.3s ease;
  }
  .notification-success { background: #28a745; }
  .notification-error { background: #dc3545; }
  .notification-info { background: #17a2b8; }
  @keyframes slideIn {
    from { transform: translateX(100%); }
    to { transform: translateX(0); }
  }

  /* Advanced Filters */
  .advanced-filters { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }

  /* responsive */
  @media (max-width: 768px) {
    .summary-cards {
      grid-template-columns: repeat(2, 1fr) !important;
    }
    
    .flex-row-mobile {
      flex-direction: column !important;
    }
    
    input, select, button {
      font-size: 16px !important; /* Prevents zoom on iOS */
    }
    
    table {
      font-size: 12px;
    }
    
    .card {
      padding: 12px;
    }

    .advanced-filters {
      flex-direction: column;
    }

    .quick-actions {
      flex-direction: column;
    }

    .header-inner{flex-direction:column; gap:10px; align-items:flex-start}
    nav.topbar{flex-wrap:wrap}
    .flex{flex-direction:column; align-items:stretch}
    .spacer{height:140px}
    .summary-bar { display:none; }
    
    .global-year-selector {
      margin-left: 0;
      margin-top: 10px;
    }
  }

  .total-collection {
    background: linear-gradient(135deg, var(--accent-gold), #f8e8a8);
    padding: 12px 16px;
    border-radius: 10px;
    margin-top: 12px;
    text-align: center;
    font-weight: 700;
    color: var(--text);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  .breakdown-container {
    display: flex;
    gap: 12px;
    margin-top: 8px;
    flex-wrap: wrap;
  }

  /* Utility classes */
  .hidden { display: none !important; }
  .visible { display: block !important; }
  .flex-row { display: flex; flex-direction: row; }
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="brand">
      <div class="logo">CB</div>
      <div>
        <h1>Club Bornoporichoy</h1>
        <div class="sub">Durga Puja Dashboard</div>
      </div>
    </div>

    <nav class="topbar" role="navigation" aria-label="Main navigation">
      <a href="#invitations" id="nav-invitations" class="active">Manage Invitations</a>
      <a href="#members" id="nav-members">Members</a>
      <a href="#collectors" id="nav-collectors">Donation Collectors</a>
      <a href="#fees" id="nav-fees">Membership Fees</a>
      <a href="#paid-tracker" id="nav-paid" style="display:none">Paid Tracker</a>
    </nav>

    <!-- Global Year Selector -->
    <div class="global-year-selector hidden" id="global-year-selector">
      <label>üìÖ Year:</label>
      <select id="globalYearSelect">
        <!-- Options will be populated dynamically -->
      </select>
    </div>

    <div class="auth-area">
      <div id="user-info" class="muted" style="font-size:13px"></div>
      <button id="logout-btn" class="btn small hidden">Logout</button>
    </div>
  </div>
</header>

<!-- sticky summary bar under header - HIDDEN BY DEFAULT -->
<div class="summary-bar hidden" id="summary-bar">
  <div class="summary-inner">
    <div class="summary-card">
      <div style="font-size:12px;color:#666">Invitees</div>
      <div class="value" id="summary-invitees">‚Äî</div>
    </div>
    <div class="summary-card">
      <div style="font-size:12px;color:#666">Members</div>
      <div class="value" id="summary-members">‚Äî</div>
    </div>
    <div class="summary-card" style="margin-left:auto">
      <div style="font-size:12px;color:#666">Total Collected</div>
      <div class="value" id="summary-collection">‚Çπ0</div>
      <div class="breakdown-container">
        <div class="breakdown-item">
          <div class="breakdown-label">Village Collection</div>
          <div class="breakdown-value" id="breakdown-village">‚Çπ0</div>
        </div>
        <div class="breakdown-item">
          <div class="breakdown-label">Membership Fees</div>
          <div class="breakdown-value" id="breakdown-membership">‚Çπ0</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="spacer"></div>

<div class="container">

  <!-- Auth / Login Card -->
  <div class="card" id="auth-card">
    <div style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap">
      <div style="min-width:240px;flex:1">
        <label class="muted">Email</label>
        <input id="email" type="email" placeholder="admin@example.com" style="width:100%" />
      </div>
      <div style="min-width:220px;flex:1">
        <label class="muted">Password</label>
        <input id="password" type="password" placeholder="password" style="width:100%" />
      </div>

      <div style="min-width:160px">
        <label class="muted">Select Year</label>
        <select id="loginYearSelect" style="width:100%;">
          <!-- Options will be populated dynamically -->
        </select>
      </div>

      <div style="display:flex;gap:8px;align-items:center;margin-top:20px">
        <button id="login-btn" class="btn">Login</button>
      </div>
    </div>
    <div class="muted note" style="margin-top:10px">
      Use email/password login. Admin UID for edits: <code>fRpLuiBgU0ZE1AtVmkGaA1RhBJk2</code>
    </div>
  </div>

  <!-- Main content (hidden until login) -->
  <div id="main-content" class="hidden">

    <!-- 1. Real-time Dashboard Summary Cards (SEPARATE PANEL) -->
    <div class="card">
      <h3>üìä Dashboard Overview</h3>
      <div class="summary-cards">
        <div class="summary-card-item">
          <div style="font-size: 24px; font-weight: bold; color: var(--primary-red);" id="total-invitations">0</div>
          <div style="font-size: 14px; color: var(--muted);">Total Invitations</div>
        </div>
        <div class="summary-card-item">
          <div style="font-size: 24px; font-weight: bold; color: var(--primary-red);" id="total-members">0</div>
          <div style="font-size: 14px; color: var(--muted);">Total Members</div>
        </div>
        <div class="summary-card-item">
          <div style="font-size: 24px; font-weight: bold; color: var(--primary-red);" id="pending-invitations">0</div>
          <div style="font-size: 14px; color: var(--muted);">Pending Invitations</div>
        </div>
        <div class="summary-card-item">
          <div style="font-size: 24px; font-weight: bold; color: var(--primary-red);" id="active-collectors">0</div>
          <div style="font-size: 14px; color: var(--muted);">Active Collectors</div>
        </div>
      </div>
    </div>

    <!-- 4. Quick Actions Panel -->
    <div class="card">
      <h3>‚ö° Quick Actions</h3>
      <div class="quick-actions">
        <button class="btn small" onclick="exportAllData()">üìä Export All Data</button>
        <button class="btn small secondary" onclick="sendBulkReminders()">üìß Send Reminders</button>
        <button class="btn small ghost" onclick="generateReport()">üìã Generate Report</button>
        <button class="btn small" onclick="backupData()">üíæ Backup Data</button>
      </div>
    </div>

    <!-- 5. Recent Activity Feed -->
    <div class="card">
      <h3>üïí Recent Activity</h3>
      <div id="recent-activity" style="max-height: 200px; overflow-y: auto;">
        <!-- Activity items will be added here -->
      </div>
    </div>

    <!-- Rest of your content remains the same -->
    <!-- Invitations -->
    <div class="card" id="invitations">
      <h2>ü™î Invitation List</h2>
      <div class="subtitle">Add, search and track invitation card distribution</div>

      <!-- Enhanced Search & Filters -->
      <div class="advanced-filters">
        <select id="filter-village" style="min-width: 150px;">
          <option value="">All Villages</option>
          <option value="Madhabpur">Madhabpur</option>
          <option value="Paldhui">Paldhui</option>
          <option value="Sabitrapur">Sabitrapur</option>
          <option value="Lalupool">Lalupool</option>
          <option value="Mahakal">Mahakal</option>
          <option value="Others">Others</option>
        </select>
        <select id="filter-status" style="min-width: 150px;">
          <option value="">All Status</option>
          <option value="paid">Paid</option>
          <option value="pending">Pending</option>
        </select>
        <input type="date" id="filter-date-from" placeholder="From Date">
        <input type="date" id="filter-date-to" placeholder="To Date">
      </div>

      <div style="display:flex;gap:12px;margin-top:12px;align-items:center">
        <input id="search-invite" type="text" placeholder="Search invitations (name / village / mobile)..." style="flex:1" />
        <div class="muted">Admin can add/edit/delete</div>
      </div>

      <table id="invitation-table" style="margin-top:12px">
        <thead>
          <tr><th>Name</th><th>Village</th><th>Mobile</th><th>Remarks</th><th>Sent</th><th>Date Added</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>

      <div style="margin-top:12px">
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <input id="inv-name" type="text" placeholder="Name" style="min-width:180px" />
          <input id="inv-village" type="text" placeholder="Village" style="min-width:160px" />
          <input id="inv-mobile" type="text" placeholder="Mobile No" style="min-width:140px" />
          <input id="inv-remarks" type="text" placeholder="Remarks" style="min-width:200px" />
          <button id="add-inv-btn" class="btn small">Add Invitation</button>
        </div>
      </div>
    </div>

    <!-- Members -->
    <div class="card" id="members">
      <h2>üå∏ Members List</h2>
      <div class="subtitle">Manage members ‚Äî linked to membership fee tracker</div>

      <div style="display:flex;gap:12px;margin-top:12px;align-items:center">
        <input id="search-members" type="text" placeholder="Search members (name/mobile)..." style="flex:1" />
        <div class="muted">Admin can add/edit/delete</div>
      </div>

      <table id="members-table" style="margin-top:12px">
        <thead><tr><th>Name</th><th>Village</th><th>Mobile</th><th>Remarks</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>

      <div style="margin-top:12px">
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <input id="mem-name" type="text" placeholder="Name" style="min-width:180px" />
          <input id="mem-village" type="text" placeholder="Village" style="min-width:160px" />
          <input id="mem-mobile" type="text" placeholder="Mobile No" style="min-width:140px" />
          <input id="mem-remarks" type="text" placeholder="Remarks" style="min-width:200px" />
          <button id="add-mem-btn" class="btn small">Add Member</button>
        </div>
      </div>
    </div>

    <!-- Membership Fees -->
    <div class="card" id="fees">
      <h2>üí∞ Membership Fees Tracker (<span id="current-year-display">2025</span>)</h2>
      <div class="subtitle">Track monthly payments (‚Çπ per month configurable)</div>

      <div style="display:flex;gap:12px;align-items:center;margin-top:12px">
        <div style="min-width:260px">
          <label class="muted">Member</label>
          <select id="feeMemberSelect" style="width:100%"><option value="">-- Select member --</option></select>
        </div>

        <div style="min-width:140px">
          <label class="muted">Monthly Fee (‚Çπ)</label>
          <input id="feeAmountInput" type="number" min="1" value="100" style="width:100%" />
        </div>

        <div style="display:flex;gap:8px;align-items:center;margin-left:auto">
          <button id="loadMemberFeeBtn" class="btn small">Load</button>
          <button id="exportCsvBtn" class="btn small secondary">Export CSV</button>
        </div>
      </div>

      <table id="fee-months-table" style="margin-top:12px">
        <thead><tr><th>Month</th><th>Status</th><th>Paid On</th><th>Toggle (Admin)</th></tr></thead>
        <tbody></tbody>
      </table>

      <div style="display:flex;align-items:center;gap:12px;margin-top:12px">
        <div id="fee-member-summary" class="muted">Select member to load fees</div>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button id="saveFeeConfigBtn" class="btn small">Save Config</button>
          <button id="clearFeeRecordBtn" class="btn small ghost">Clear</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <h3 style="margin:0 0 8px 0;color:var(--primary-red);font-size:15px">Yearly Summary</h3>
        <table id="fees-yearly-summary">
          <thead><tr><th>Month</th><th>Paid Members</th><th>Total Collected (‚Çπ)</th></tr></thead>
        <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Paid Members Visual Tracker -->
    <div class="card" id="paid-tracker">
      <h2>üí† Paid Members Visual Tracker (<span id="paid-tracker-year-display">2025</span>)</h2>
      <div class="subtitle">Click to load paid status for selected year. Click column header "Member" to sort A‚ÜíZ.</div>

      <div style="display:flex;gap:12px;align-items:center;margin-top:12px">
        <div style="min-width:220px">
          <button id="show-paid-btn" class="btn small">Show Paid Members</button>
          <button id="clear-paid-view" class="btn small ghost" style="margin-left:8px">Clear</button>
        </div>

        <div style="margin-left:auto">
          <div id="paid-tracker-count" class="muted">Loaded: 0</div>
        </div>
      </div>

      <div id="paid-members-list" style="margin-top:14px;overflow:auto;"></div>
    </div>

    <!-- Collectors -->
    <div class="card" id="collectors">
      <h2>üì¨ Donation Collectors</h2>
      <div class="subtitle">Assign areas and track bills</div>

      <div style="display:flex;gap:12px;margin-top:12px;align-items:center">
        <input id="search-collectors" type="text" placeholder="Search collectors..." style="flex:1" />
        <div class="muted">Admin can add/edit/delete</div>
      </div>

      <table id="collector-table" style="margin-top:12px">
        <thead><tr><th>Name</th><th>Assigned Area</th><th>Bill No</th><th>Mobile No</th><th>Remarks</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>

      <div style="margin-top:12px">
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <input id="col-name" type="text" placeholder="Name" style="min-width:160px" />
          <input id="col-area" type="text" placeholder="Assigned Area (comma separated)" style="min-width:160px" />
          <input id="col-bill" type="text" placeholder="Bill No" style="min-width:120px" />
          <input id="col-mobile" type="text" placeholder="Mobile No" style="min-width:120px" />
          <input id="col-remarks" type="text" placeholder="Remarks" style="min-width:200px" />
          <button id="add-col-btn" class="btn small">Add Collector</button>
        </div>
      </div>
    </div>

    <!-- Village Collection Tracker -->
    <div class="card" id="village-collection">
      <h2>üèòÔ∏è Village Collection Tracker</h2>
      <div class="subtitle">Track donations per village and collector</div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px">
        <input id="vc-bill" type="text" placeholder="Bill No" style="min-width:120px" />
        
        <select id="vc-collector" style="min-width:160px">
          <option value="">-- Select Collector --</option>
        </select>

        <input id="vc-donor" type="text" placeholder="Donor Name" style="min-width:160px" />

        <input id="vc-amount" type="number" placeholder="Amount (‚Çπ)" style="min-width:120px" />
        <input id="vc-remarks" type="text" placeholder="Remarks" style="min-width:200px" />

        <select id="vc-village" style="min-width:160px">
          <option value="">-- Select Village --</option>
          <option value="Madhabpur">Madhabpur</option>
          <option value="Paldhui">Paldhui</option>
          <option value="Sabitrapur">Sabitrapur</option>
          <option value="Lalupool">Lalupool</option>
          <option value="Mahakal">Mahakal</option>
          <option value="Others">Others</option>
        </select>

        <button id="add-vc-btn" class="btn small">Add Collection</button>
      </div>

      <!-- Total Collection Display -->
      <div id="vc-total-collection" class="total-collection" style="display:none;">
        Total Village Collection: ‚Çπ<span id="vc-total-amount">0</span>
      </div>

      <!-- Village-wise Collection Breakdown -->
      <div class="card" style="margin-top: 15px;">
        <h3>üèòÔ∏è Village-wise Collection</h3>
        <div id="village-breakdown" class="village-breakdown">
          <!-- Will be populated dynamically -->
        </div>
      </div>

      <!-- Monthly Collection Trends Chart -->
      <div class="card" style="margin-top: 15px;">
        <h3>üìà Monthly Collection Trend</h3>
        <canvas id="collectionChart" height="100"></canvas>
      </div>

      <table id="vc-table" style="margin-top:12px">
        <thead>
          <tr>
            <th>Bill No</th>
            <th>Collector</th>
            <th>Donor Name</th>
            <th>Amount (‚Çπ)</th>
            <th>Remarks</th>
            <th>Village</th>
            <th>Date Added</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <input id="search-vc" type="text" placeholder="Search collections..." style="margin-top:12px;width:100%;padding:8px;border-radius:8px;border:1px solid #ccc;" />
    </div>

  </div> <!-- main-content -->
</div> <!-- container -->

<!-- Toast container -->
<div class="toast-container" id="toast-container"></div>

<script>
/* ---------------- Firebase config (hardcoded) ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyCuVs6jx7HiNIx25lzLgoq1B6nQqaHLHm0",
  authDomain: "guestandcollection.firebaseapp.com",
  projectId: "guestandcollection",
  storageBucket: "guestandcollection.firebasestorage.app",
  messagingSenderId: "272278233160",
  appId: "1:272278233160:web:d6d1e6a7d58be260d9b87d",
  measurementId: "G-B5783XTFSP"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ---------------- Global Year Selection System ---------------- */
let selectedYear = new Date().getFullYear(); // Default to current year

// Function to populate year dropdowns
function populateYearDropdowns() {
  const loginYearSelect = document.getElementById('loginYearSelect');
  const globalYearSelect = document.getElementById('globalYearSelect');
  
  // Clear existing options
  if (loginYearSelect) loginYearSelect.innerHTML = '';
  if (globalYearSelect) globalYearSelect.innerHTML = '';
  
  // Add years from 2025 to 2050
  for (let year = 2025; year <= 2050; year++) {
    const option = document.createElement('option');
    option.value = year;
    option.textContent = year;
    
    if (year === selectedYear) {
      option.selected = true;
    }
    
    if (loginYearSelect) loginYearSelect.appendChild(option.cloneNode(true));
    if (globalYearSelect) globalYearSelect.appendChild(option);
  }
}

// Function to update year displays
function updateYearDisplays() {
  // Update header displays
  const currentYearDisplay = document.getElementById('current-year-display');
  const paidTrackerYearDisplay = document.getElementById('paid-tracker-year-display');
  
  if (currentYearDisplay) currentYearDisplay.textContent = selectedYear;
  if (paidTrackerYearDisplay) paidTrackerYearDisplay.textContent = selectedYear;
  
  // Update global year selector
  const globalYearSelect = document.getElementById('globalYearSelect');
  if (globalYearSelect) {
    globalYearSelect.value = selectedYear;
  }
}

// Function to change global year
function changeGlobalYear(newYear) {
  selectedYear = parseInt(newYear);
  updateYearDisplays();
  
  // Reload all year-dependent data
  loadFeeMembersDropdown();
  loadFeeYearlySummary();
  recalcTotalCollected();
  
  // Show notification
  showNotification(`Year changed to ${selectedYear}. All data updated.`, 'info');
  addActivity(`Changed global year to ${selectedYear}`, 'info');
}

// Initialize year system
populateYearDropdowns();

/* ---------------- Event Listeners for Year Selection ---------------- */
document.addEventListener('DOMContentLoaded', function() {
  // Login year selector
  const loginYearSelect = document.getElementById('loginYearSelect');
  if (loginYearSelect) {
    loginYearSelect.addEventListener('change', function(e) {
      selectedYear = parseInt(e.target.value);
      updateYearDisplays();
    });
  }
  
  // Global year selector (in header)
  const globalYearSelect = document.getElementById('globalYearSelect');
  if (globalYearSelect) {
    globalYearSelect.addEventListener('change', function(e) {
      changeGlobalYear(e.target.value);
    });
  }
});

/* ---------------- Roles & constants ---------------- */
const ROLES = {
  "fRpLuiBgU0ZE1AtVmkGaA1RhBJk2": "admin",
  "898Fi5sPKHY01GUgI4iu1xS4TBR2": "viewer"
};
let currentRole = "viewer";
const MONTHS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

/* ---------------- collections (static) ---------------- */
const invitationCol = db.collection("invitations");
const membersCol = db.collection("members");
const collectorsCol = db.collection("collectors");
const villageCollectionsCol = db.collection("village_collections");
function membershipFeesCollectionFor(year){ return db.collection(`membership_fees_${year}`); }

/* ---------------- Chart initialization ---------------- */
let collectionChart;
function initCollectionChart() {
  const ctx = document.getElementById('collectionChart');
  if (!ctx) {
    console.warn('Chart canvas not found');
    return;
  }
  
  collectionChart = new Chart(ctx.getContext('2d'), {
    type: 'line',
    data: {
      labels: MONTHS,
      datasets: [{
        label: 'Monthly Collection (‚Çπ)',
        data: Array(12).fill(0),
        borderColor: '#B71C1C',
        backgroundColor: 'rgba(183, 28, 28, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'top',
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return '‚Çπ' + value;
            }
          }
        }
      }
    }
  });
}

/* ---------------- Summary Cards Functions ---------------- */
async function updateSummaryCards() {
  try {
    // Total invitations
    const invitationsSnap = await invitationCol.get();
    const totalInvitations = invitationsSnap.size;
    safeSetTextContent('total-invitations', totalInvitations);

    // Total members
    const membersSnap = await membersCol.get();
    const totalMembers = membersSnap.size;
    safeSetTextContent('total-members', totalMembers);

    // Pending invitations
    let pendingInvitations = 0;
    invitationsSnap.forEach(doc => {
      const data = doc.data();
      if (!data.sent) pendingInvitations++;
    });
    safeSetTextContent('pending-invitations', pendingInvitations);

    // Active collectors
    const collectorsSnap = await collectorsCol.get();
    const activeCollectors = collectorsSnap.size;
    safeSetTextContent('active-collectors', activeCollectors);

  } catch (error) {
    console.error("Error updating summary cards:", error);
  }
}

/* ---------------- Safe DOM element helper ---------------- */
function safeSetTextContent(elementId, text) {
  const element = document.getElementById(elementId);
  if (element) {
    element.textContent = text;
  } else {
    console.warn(`Element with id '${elementId}' not found`);
  }
}

/* ---------------- Village Breakdown Function ---------------- */
async function loadVillageBreakdown() {
  const breakdownContainer = document.getElementById('village-breakdown');
  if (!breakdownContainer) {
    console.warn('Village breakdown container not found');
    return;
  }
  
  try {
    const snap = await villageCollectionsCol.get();
    
    const villageTotals = {};
    snap.forEach(doc => {
      const d = doc.data();
      const village = d.village || 'Others';
      villageTotals[village] = (villageTotals[village] || 0) + (d.amount || 0);
    });
    
    breakdownContainer.innerHTML = Object.entries(villageTotals)
      .map(([village, total]) => `
        <div class="breakdown-item">
          <div class="breakdown-label">${village}</div>
          <div class="breakdown-value">‚Çπ${total.toLocaleString()}</div>
        </div>
      `).join('');
  } catch (error) {
    console.error("Error loading village breakdown:", error);
    breakdownContainer.innerHTML = '<div class="breakdown-item">Error loading data</div>';
  }
}

/* ---------------- Recent Activity Functions ---------------- */
function addActivity(message, type = 'info') {
  const activityDiv = document.getElementById('recent-activity');
  if (!activityDiv) {
    console.warn('Recent activity container not found');
    return;
  }
  
  const activityItem = document.createElement('div');
  activityItem.className = `activity-item ${type}`;
  activityItem.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <span>${message}</span>
      <small style="color: var(--muted);">${new Date().toLocaleTimeString()}</small>
    </div>
  `;
  activityDiv.insertBefore(activityItem, activityDiv.firstChild);
  
  // Keep only last 10 activities
  if (activityDiv.children.length > 10) {
    activityDiv.removeChild(activityDiv.lastChild);
  }
}

/* ---------------- Enhanced Notification System ---------------- */
function showNotification(message, type = 'info', duration = 5000) {
  // Remove existing notifications of same type to avoid duplicates
  const existingNotifications = document.querySelectorAll('.notification');
  existingNotifications.forEach(notification => {
    if (notification.textContent.includes(message)) {
      notification.remove();
    }
  });

  const notification = document.createElement('div');
  notification.className = `notification notification-${type}`;
  notification.innerHTML = `
    <div style="display: flex; align-items: center; gap: 10px;">
      <span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
      <span>${message}</span>
    </div>
  `;
  
  document.body.appendChild(notification);
  
  // Auto remove after duration
  setTimeout(() => {
    if (notification.parentNode) {
      notification.parentNode.removeChild(notification);
    }
  }, duration);
}

// ... (rest of your existing JavaScript code remains the same)
// Just make sure to replace all instances of selectedFeeYear with selectedYear

/* ---------------- Auth handlers ---------------- */
const loginBtn = document.getElementById("login-btn");
if (loginBtn) {
  loginBtn.addEventListener("click", () => {
    const email = document.getElementById("email").value.trim();
    const pw = document.getElementById("password").value;
    if(!email || !pw) return alert("Enter email and password");
    loginBtn.disabled = true;
    auth.signInWithEmailAndPassword(email,pw)
      .then(()=> {
        showToast("Logged in");
        addActivity('User logged in successfully', 'success');
        
        // Show global year selector after login
        const globalYearSelector = document.getElementById('global-year-selector');
        if (globalYearSelector) globalYearSelector.classList.remove('hidden');
        
        // Update year displays
        updateYearDisplays();
      })
      .catch(e => { 
        alert("Login error: "+e.message); 
        addActivity('Login failed: ' + e.message, 'error');
      })
      .finally(()=> loginBtn.disabled=false);
  });
}

/* auth state listener */
auth.onAuthStateChanged(user => {
  if(user){
    currentRole = ROLES[user.uid] || "viewer";
    // Show main content and summary bar, hide auth card
    const authCard = document.getElementById("auth-card");
    const mainContent = document.getElementById("main-content");
    const summaryBar = document.getElementById("summary-bar");
    const logoutBtn = document.getElementById("logout-btn");
    const globalYearSelector = document.getElementById('global-year-selector');
    
    if (authCard) authCard.classList.add("hidden");
    if (mainContent) mainContent.classList.remove("hidden");
    if (summaryBar) summaryBar.classList.remove("hidden");
    if (logoutBtn) logoutBtn.classList.remove("hidden");
    if (globalYearSelector) globalYearSelector.classList.remove("hidden");
    
    const userInfo = document.getElementById("user-info");
    if (userInfo) userInfo.textContent = `${user.email} (${currentRole})`;
    
    applyRoleToUI();
    setTimeout(()=>{ 
      loadAllData(); 
      loadFeeMembersDropdown(); 
      loadFeeYearlySummary(); 
      initCollectionChart(); 
      updateSummaryCards(); 
      loadVillageBreakdown();
      updateYearDisplays(); // Update year displays after login
    }, 120);
  } else {
    // Show auth card, hide main content and summary bar
    const authCard = document.getElementById("auth-card");
    const mainContent = document.getElementById("main-content");
    const summaryBar = document.getElementById("summary-bar");
    const logoutBtn = document.getElementById("logout-btn");
    const globalYearSelector = document.getElementById('global-year-selector');
    
    if (authCard) authCard.classList.remove("hidden");
    if (mainContent) mainContent.classList.add("hidden");
    if (summaryBar) summaryBar.classList.add("hidden");
    if (logoutBtn) logoutBtn.classList.add("hidden");
    if (globalYearSelector) globalYearSelector.classList.add("hidden");
    
    const userInfo = document.getElementById("user-info");
    if (userInfo) userInfo.textContent = "";
    clearAllTables();
  }
});

/* ---------------- Update all functions to use selectedYear instead of selectedFeeYear ---------------- */

// In your existing code, replace all instances of:
// selectedFeeYear -> selectedYear
// membershipFeesCollectionFor(selectedFeeYear) -> membershipFeesCollectionFor(selectedYear)

// For example:
async function loadFeeMonthsTable(){
  const memberId = document.getElementById('feeMemberSelect')?.value;
  const feeAmount = Number(document.getElementById("feeAmountInput")?.value) || 100;
  const tbody = document.querySelector("#fee-months-table tbody");
  if (!tbody) return;
  
  tbody.innerHTML = "";
  if(!memberId){ 
    safeSetTextContent("fee-member-summary", "Select a member"); 
    return; 
  }

  try{
    const feesCol = membershipFeesCollectionFor(selectedYear); // Changed to selectedYear
    // ... rest of the function
  } catch(e) { /* error handling */ }
}

// Similarly update:
// loadFeeYearlySummary()
// export CSV function
// Paid tracker functions
// recalcTotalCollected()

// ... (rest of your existing JavaScript code)

// Make sure to update the initial loads:
setTimeout(()=>{ 
  if(auth.currentUser){ 
    loadAllData(); 
    loadFeeMembersDropdown(); 
    loadFeeYearlySummary(); 
    recalcTotalCollected(); 
    initCollectionChart(); 
    updateChartData();
    updateYearDisplays(); // Add this
  } 
}, 200);

// Update the interval for recalc:
setInterval(()=>{ 
  if(auth.currentUser) {
    recalcTotalCollected(); 
    updateSummaryCards(); // Also update summary cards periodically
  } 
}, 12000);

// Expose the global year change function
window.changeGlobalYear = changeGlobalYear;

// Add some initial activities when the page loads
setTimeout(() => {
  if (auth.currentUser) {
    addActivity('Dashboard initialized successfully', 'success');
    addActivity(`Global year set to ${selectedYear}`, 'info');
    addActivity('Welcome to Club Bornoporichoy Dashboard!', 'info');
  }
}, 1000);

</script>
</body>
</html>
