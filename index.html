<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Club Bornoporichoy — Durga Puja Dashboard</title>

<!-- Firebase compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
  :root{
    --red:#b71c1c;
    --gold:#fdd835;
    --bg:#fff5f0;
    --text:#4b2e2e;
  }
  body {font-family: "Segoe UI", Roboto, Arial; background:var(--bg); color:var(--text); margin:0; padding:0;}
  header{background:var(--red); color:#fff; padding:16px; text-align:center; box-shadow:0 4px 10px rgba(0,0,0,0.12);}
  header h1{margin:0; font-size:20px;}
  .topbar{margin-top:8px;}
  .container{max-width:1150px; margin:20px auto; padding:18px;}
  .card{background:#fff; padding:14px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.06); margin-bottom:18px;}
  .flex{display:flex; gap:10px; align-items:center;}
  input[type="text"], input[type="email"], input[type="password"], input[type="number"], select{
    padding:8px; border:1px solid var(--red); border-radius:4px;
  }
  button{background:var(--red); color:#fff; border:none; padding:8px 10px; border-radius:6px; cursor:pointer;}
  button:disabled{background:#ccc; cursor:not-allowed;}
  h2{color:var(--red); margin:0 0 8px 0;}
  table{width:100%; border-collapse:collapse; margin-top:10px;}
  th, td{padding:8px; border:1px solid rgba(0,0,0,0.08); text-align:left; vertical-align:middle;}
  th{background:var(--gold); color:var(--text);}
  .summary{font-weight:700; margin-bottom:8px;}
  .muted{color:#666; font-size:0.95em;}
  .editable{background:#fff8e1; cursor:text;}
  .badge-sent{background:green;color:#fff;padding:3px 6px;border-radius:4px;font-size:0.85em}
  .badge-pending{background:orange;color:#fff;padding:3px 6px;border-radius:4px;font-size:0.85em}
  .month-checkbox{margin-right:6px;}
  .small{font-size:0.9em}
  .right{margin-left:auto}
  .center{text-align:center}
  @media (max-width:900px){
    .flex{flex-direction:column; align-items:stretch;}
    table, thead, tbody, th, td, tr{font-size:13px;}
  }
</style>
</head>
<body>
<header>
  <h1>Club Bornoporichoy — Durga Puja Dashboard</h1>
  <div class="topbar muted">
    Manage Invitations · Members · Donation Collectors · Membership Fees
  </div>
</header>

<div class="container">

  <!-- Auth Card -->
  <div class="card" id="auth-card">
    <div class="flex">
      <div>
        <label class="small">Email</label><br>
        <input id="email" type="email" placeholder="admin@club.com" />
      </div>
      <div>
        <label class="small">Password</label><br>
        <input id="password" type="password" placeholder="password" />
      </div>
      <div class="right">
        <button id="login-btn">Login</button>
        <button id="logout-btn" class="hidden">Logout</button>
        <div id="user-info" class="muted small" style="margin-top:8px;"></div>
      </div>
    </div>
    <div class="muted small" style="margin-top:10px;">
      Use email/password login. Admin features require the admin UID: <code>fRpLuiBgU0ZE1AtVmkGaA1RhBJk2</code>
    </div>
  </div>

  <!-- Page content (hidden until login) -->
  <div id="main-content" class="hidden">

    <!-- Top summaries -->
    <div class="card">
      <div class="flex">
        <div>
          <div class="summary" id="summary-invitees">Invitees: —</div>
          <div class="muted">Invitation list summary</div>
        </div>
        <div>
          <div class="summary" id="summary-members">Members: —</div>
          <div class="muted">Members & membership collection</div>
        </div>
        <div class="right">
          <div id="summary-collection" class="summary">Total Collected: ₹0</div>
          <div class="muted">Membership collection overall</div>
        </div>
      </div>
    </div>

    <!-- Invitations section -->
    <div class="card">
      <h2>Invitation List</h2>
      <div class="flex">
        <input id="search-invite" type="text" placeholder="Search invitations (name / village / mobile)..." style="flex:1" />
        <div class="right muted small">Admin can add/edit/delete</div>
      </div>

      <table id="invitation-table">
        <thead>
          <tr>
            <th>Name</th><th>Village</th><th>Mobile</th><th>Remarks</th><th>Sent</th><th>Date Added</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div style="margin-top:10px" id="invitation-form">
        <div class="flex">
          <input id="inv-name" type="text" placeholder="Name" />
          <input id="inv-village" type="text" placeholder="Village" />
          <input id="inv-mobile" type="text" placeholder="Mobile No" />
          <input id="inv-remarks" type="text" placeholder="Remarks" />
          <button id="add-inv-btn">Add Invitation</button>
        </div>
      </div>
    </div>

    <!-- Members and membership fees -->
    <div class="card">
      <h2>Members List & Membership Fees (₹100/month)</h2>

      <!-- Monthly summary -->
      <div style="margin-bottom:12px">
        <h3 class="small">Monthly Summary</h3>
        <table id="monthly-summary-table">
          <thead><tr><th>Month</th><th>Paid Members</th><th>Total Collected (₹)</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div style="margin-top:12px" class="flex">
        <input id="search-members" type="text" placeholder="Search members (name/mobile)..." style="flex:1" />
        <div class="right muted small">Click month checkbox to mark paid/unpaid (admin only)</div>
      </div>

      <table id="members-table">
        <thead>
          <tr>
            <th>Name</th><th>Village</th><th>Mobile</th><th>Remarks</th>
            <th>Jan</th><th>Feb</th><th>Mar</th><th>Apr</th><th>May</th><th>Jun</th>
            <th>Jul</th><th>Aug</th><th>Sep</th><th>Oct</th><th>Nov</th><th>Dec</th>
            <th>Total Paid (₹)</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div style="margin-top:10px" id="member-form">
        <div class="flex">
          <input id="mem-name" type="text" placeholder="Name" />
          <input id="mem-village" type="text" placeholder="Village" />
          <input id="mem-mobile" type="text" placeholder="Mobile No" />
          <input id="mem-remarks" type="text" placeholder="Remarks" />
          <button id="add-mem-btn">Add Member</button>
        </div>
      </div>
    </div>

    <!-- Donation collectors -->
    <div class="card">
      <h2>Donation Collectors</h2>
      <div class="flex">
        <input id="search-collectors" type="text" placeholder="Search collectors..." style="flex:1" />
        <div class="right muted small">Area assignment for collectors</div>
      </div>

      <table id="collector-table">
        <thead><tr><th>Name</th><th>Assigned Area</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>

      <div style="margin-top:10px" id="collector-form">
        <div class="flex">
          <input id="col-name" type="text" placeholder="Name" />
          <input id="col-area" type="text" placeholder="Assigned Area (comma separated areas)" />
          <button id="add-col-btn">Add Collector</button>
        </div>
      </div>
    </div>

  </div> <!-- main-content -->
</div> <!-- container -->

<script>
/* ---------------- Firebase config (hardcoded) ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyCuVs6jx7HiNIx25lzLgoq1B6nQqaHLHm0",
  authDomain: "guestandcollection.firebaseapp.com",
  projectId: "guestandcollection",
  storageBucket: "guestandcollection.firebasestorage.app",
  messagingSenderId: "272278233160",
  appId: "1:272278233160:web:d6d1e6a7d58be260d9b87d",
  measurementId: "G-B5783XTFSP"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ---------------- Roles (hardcoded) ---------------- */
const ROLES = {
  "fRpLuiBgU0ZE1AtVmkGaA1RhBJk2": "admin",
  "898Fi5sPKHY01GUgI4iu1xS4TBR2": "viewer"
};
let currentRole = "viewer";
const MONTHS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

/* ---------------- Elements ---------------- */
const loginBtn = document.getElementById("login-btn");
const logoutBtn = document.getElementById("logout-btn");
const userInfo = document.getElementById("user-info");
const mainContent = document.getElementById("main-content");

/* collection refs */
const invitationCol = db.collection("invitations");
const membersCol = db.collection("members");
const collectorsCol = db.collection("collectors");

/* ---------------- Auth handlers ---------------- */

/* Use click handlers that are idempotent; guard against multiple clicks */
loginBtn.addEventListener("click", () => {
  const email = document.getElementById("email").value.trim();
  const pw = document.getElementById("password").value;
  if(!email || !pw) return alert("Enter email and password");
  loginBtn.disabled = true;
  auth.signInWithEmailAndPassword(email,pw)
    .catch(e => alert("Login error: "+e.message))
    .finally(()=> loginBtn.disabled = false);
});

logoutBtn.addEventListener("click", () => {
  logoutBtn.disabled = true;
  auth.signOut().catch(e => alert("Logout error: " + e.message))
    .finally(()=> logoutBtn.disabled = false);
});

/* Auth state listener — keeps UI in sync */
auth.onAuthStateChanged(user => {
  // This will run on initial load and whenever auth state changes.
  if(user){
    // determine role
    currentRole = ROLES[user.uid] || "viewer";

    // toggle UI
    document.getElementById("email").style.display = "none";
    document.getElementById("password").style.display = "none";
    loginBtn.style.display = "none";
    logoutBtn.classList.remove("hidden");
    mainContent.classList.remove("hidden");
    userInfo.textContent = `${user.email} (${currentRole})`;

    // ensure role UI and data load are stable and serial
    applyRoleToUI();
    // small delay to ensure UI shows before heavy queries start (avoids perceived freeze)
    setTimeout(() => loadAllData(), 100);
  } else {
    // show login inputs
    document.getElementById("email").style.display = "";
    document.getElementById("password").style.display = "";
    loginBtn.style.display = "";
    logoutBtn.classList.add("hidden");
    mainContent.classList.add("hidden");
    userInfo.textContent = "";
    clearAllTables();
  }
});

/* ---------------- UI Role enforcement ---------------- */
function applyRoleToUI(){
  const adminOnlyBtns = ["add-inv-btn","add-mem-btn","add-col-btn"];
  adminOnlyBtns.forEach(id => {
    const el = document.getElementById(id);
    if(el) el.disabled = (currentRole !== "admin");
  });
}

/* ---------------- Clear tables ---------------- */
function clearAllTables(){
  const tables = ["invitation-table","members-table","collector-table","monthly-summary-table"];
  tables.forEach(t => {
    const bb = document.querySelector(`#${t} tbody`);
    if(bb) bb.innerHTML = "";
  });
  document.getElementById("summary-invitees").textContent = "Invitees: —";
  document.getElementById("summary-members").textContent = "Members: —";
  document.getElementById("summary-collection").textContent = "Total Collected: ₹0";
}

/* ---------------- Load everything ---------------- */
function loadAllData(){
  // load in parallel but keep UI responsive
  loadInvitations();
  loadMembersTable();
  loadCollectors();
  updateMonthlySummary();
}

/* ---------------- INVITATIONS ---------------- */
/* add invitation */
document.getElementById("add-inv-btn").addEventListener("click", async () => {
  if(currentRole !== "admin") return alert("Only admin can add");
  const name = document.getElementById("inv-name").value.trim();
  const village = document.getElementById("inv-village").value.trim();
  const mobile = document.getElementById("inv-mobile").value.trim();
  const remarks = document.getElementById("inv-remarks").value.trim();
  if(!name || !village) return alert("Name & Village required");
  try {
    // duplicate check
    let dupQuery = invitationCol.where("name","==",name);
    if(mobile) dupQuery = dupQuery.where("mobile","==",mobile);
    const dup = await dupQuery.get();
    if(!dup.empty && !confirm("Possible duplicate found. Add anyway?")) return;

    await invitationCol.add({
      name, village, mobile, remarks,
      sent: false,
      dateAdded: firebase.firestore.FieldValue.serverTimestamp()
    });
    ["inv-name","inv-village","inv-mobile","inv-remarks"].forEach(id=>document.getElementById(id).value="");
    loadInvitations();
  } catch(err){
    console.error("Add invitation error:", err);
    alert("Failed to add invitation: " + (err.message || err));
  }
});

/* load invitations */
async function loadInvitations(){
  const tbody = document.querySelector("#invitation-table tbody");
  tbody.innerHTML = "";
  try {
    const snapshot = await invitationCol.orderBy("dateAdded","desc").get();
    let total=0, sent=0;
    snapshot.forEach(doc => {
      total++;
      const d = doc.data();
      if(d.sent) sent++;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="${currentRole==='admin'?'editable':''}" contenteditable="${currentRole==='admin'}">${escape(d.name||"")}</td>
        <td class="${currentRole==='admin'?'editable':''}" contenteditable="${currentRole==='admin'}">${escape(d.village||"")}</td>
        <td class="${currentRole==='admin'?'editable':''}" contenteditable="${currentRole==='admin'}">${escape(d.mobile||"")}</td>
        <td class="${currentRole==='admin'?'editable':''}" contenteditable="${currentRole==='admin'}">${escape(d.remarks||"")}</td>
        <td class="center">${d.sent?'<span class="badge-sent">Sent</span>':'<span class="badge-pending">Pending</span>'}</td>
        <td>${d.dateAdded && d.dateAdded.toDate ? d.dateAdded.toDate().toLocaleString() : ""}</td>
        <td></td>
      `;
      tbody.appendChild(tr);

      // actions and editable handlers for admin
      const actionsTd = tr.querySelector("td:last-child");
      if(currentRole==="admin"){
        const toggleBtn = document.createElement("button");
        toggleBtn.textContent = d.sent ? "Mark Pending" : "Mark Sent";
        toggleBtn.onclick = () => doc.ref.update({sent: !d.sent}).then(loadInvitations);
        actionsTd.appendChild(toggleBtn);

        const delBtn = document.createElement("button");
        delBtn.style.marginLeft = "8px";
        delBtn.textContent = "Delete";
        delBtn.onclick = () => { if(confirm("Delete invitation?")) doc.ref.delete().then(loadInvitations); };
        actionsTd.appendChild(delBtn);

        const editableCells = tr.querySelectorAll("td[contenteditable='true']");
        editableCells.forEach((cell, idx) => {
          const fieldMap = ["name","village","mobile","remarks"];
          cell.onblur = async () => {
            try {
              const val = cell.textContent.trim();
              const update = {}; update[fieldMap[idx]] = val;
              await doc.ref.update(update);
            } catch(e) { console.error("Save edit error:", e); alert("Save failed: "+e.message); }
          };
        });
      }
    });
    document.getElementById("summary-invitees").textContent = `Invitees: ${total} | Sent: ${sent} | Pending: ${total - sent}`;
  } catch(e){
    console.error("Load invitations error:", e);
    alert("Failed to load invitations: " + (e.message || e));
  }
}

/* invitation search */
document.getElementById("search-invite").addEventListener("input", (e)=>{
  filterTable("invitation-table", e.target.value);
});

/* ---------------- MEMBERS & FEES ---------------- */

/* add member */
document.getElementById("add-mem-btn").addEventListener("click", async () => {
  if(currentRole !== "admin") return alert("Only admin can add members");
  const name = document.getElementById("mem-name").value.trim();
  const village = document.getElementById("mem-village").value.trim();
  const mobile = document.getElementById("mem-mobile").value.trim();
  const remarks = document.getElementById("mem-remarks").value.trim();
  if(!name || !mobile) return alert("Name & Mobile required");
  try {
    const dup = await membersCol.where("name","==",name).where("mobile","==",mobile).get();
    if(!dup.empty && !confirm("Possible duplicate member. Add anyway?")) return;
    const fees = {}; MONTHS.forEach(m => fees[m]=false);
    await membersCol.add({
      name, village, mobile, remarks,
      monthlyFee: 100, year: new Date().getFullYear(),
      fees, totalPaid: 0, dateAdded: firebase.firestore.FieldValue.serverTimestamp()
    });
    ["mem-name","mem-village","mem-mobile","mem-remarks"].forEach(id=>document.getElementById(id).value="");
    loadMembersTable();
    updateMonthlySummary();
  } catch(e){
    console.error("Add member error:", e);
    alert("Failed to add member: " + (e.message || e));
  }
});

/* load members table */
async function loadMembersTable(){
  const tbody = document.querySelector("#members-table tbody");
  tbody.innerHTML = "";
  try {
    const snapshot = await membersCol.orderBy("name").get();
    let totalMembers = 0, overallCollected = 0;
    snapshot.forEach(docSnap => {
      totalMembers++;
      const d = docSnap.data();
      // create row
      const tr = document.createElement("tr");
      const monthCells = MONTHS.map(m => {
        const checked = d.fees && d.fees[m];
        return `<td class="center"><input class="month-checkbox" type="checkbox" data-month="${m}" ${checked ? "checked" : ""} ${currentRole!=='admin' ? "disabled" : ""}></td>`;
      }).join("");
      const paidCount = Object.values(d.fees || {}).filter(v => v).length;
      const totalPaid = paidCount * (d.monthlyFee || 100);
      overallCollected += totalPaid;
      tr.innerHTML = `
        <td class="${currentRole==='admin'?'editable':''}" contenteditable="${currentRole==='admin'}">${escape(d.name||"")}</td>
        <td class="${currentRole==='admin'?'editable':''}" contenteditable="${currentRole==='admin'}">${escape(d.village||"")}</td>
        <td class="${currentRole==='admin'?'editable':''}" contenteditable="${currentRole==='admin'}">${escape(d.mobile||"")}</td>
        <td class="${currentRole==='admin'?'editable':''}" contenteditable="${currentRole==='admin'}">${escape(d.remarks||"")}</td>
        ${monthCells}
        <td class="center"><b>₹${totalPaid}</b><div class="muted small">${paidCount}/12</div></td>
        <td></td>
      `;
      tbody.appendChild(tr);

      // attach admin interactions
      if(currentRole==="admin"){
        const editableCells = tr.querySelectorAll("td[contenteditable='true']");
        editableCells.forEach((cell, idx) => {
          const fieldMap = ["name","village","mobile","remarks"];
          cell.onblur = async () => {
            try {
              const val = cell.textContent.trim();
              const update = {}; update[fieldMap[idx]] = val;
              await membersCol.doc(docSnap.id).update(update);
            } catch(e){ console.error("Save member edit error:", e); alert("Save failed: "+e.message); }
          };
        });

        const checkboxes = tr.querySelectorAll("input.month-checkbox");
        checkboxes.forEach(cb => {
          cb.onchange = async () => {
            try {
              const month = cb.getAttribute("data-month");
              const status = cb.checked;
              const update = {}; update[`fees.${month}`] = status;
              await membersCol.doc(docSnap.id).update(update);
              // recalc and store totalPaid
              const refres = await membersCol.doc(docSnap.id).get();
              const feesObj = refres.data().fees || {};
              const paid = Object.values(feesObj).filter(v => v).length;
              const totalPaidNew = paid * (refres.data().monthlyFee || 100);
              await membersCol.doc(docSnap.id).update({ totalPaid: totalPaidNew });
              loadMembersTable();
              updateMonthlySummary();
            } catch(e){ console.error("Toggle month error:", e); alert("Update failed: "+e.message); }
          };
        });

        const actionsTd = tr.querySelector("td:last-child");
        const delBtn = document.createElement("button");
        delBtn.textContent = "Delete";
        delBtn.onclick = async () => {
          if(confirm("Delete member?")) {
            await membersCol.doc(docSnap.id).delete();
            loadMembersTable();
            updateMonthlySummary();
          }
        };
        actionsTd.appendChild(delBtn);
      }

    });

    document.getElementById("summary-members").textContent = `Members: ${totalMembers}`;
    document.getElementById("summary-collection").textContent = `Total Collected: ₹${overallCollected}`;
  } catch(e){
    console.error("Load members error:", e);
    alert("Failed to load members: " + (e.message || e));
  }
}

/* members search */
document.getElementById("search-members").addEventListener("input", (e)=> filterTable("members-table", e.target.value));

/* ---------------- Monthly Summary ---------------- */
async function updateMonthlySummary(){
  const tbody = document.querySelector("#monthly-summary-table tbody");
  tbody.innerHTML = "";
  try {
    const monthData = {}; MONTHS.forEach(m => monthData[m] = { paid:0, total:0 });
    const snapshot = await membersCol.get();
    snapshot.forEach(docSnap => {
      const d = docSnap.data();
      MONTHS.forEach(m => {
        if(d.fees && d.fees[m]){
          monthData[m].paid++;
          monthData[m].total += (d.monthlyFee || 100);
        }
      });
    });
    MONTHS.forEach(m => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${m}</td><td class="center">${monthData[m].paid}</td><td class="center">₹${monthData[m].total}</td>`;
      tbody.appendChild(tr);
    });
  } catch(e){
    console.error("Monthly summary error:", e);
  }
}

/* ---------------- COLLECTORS ---------------- */
document.getElementById("add-col-btn").addEventListener("click", async () => {
  if(currentRole !== "admin") return alert("Only admin can add");
  const name = document.getElementById("col-name").value.trim();
  const area = document.getElementById("col-area").value.trim();
  if(!name || !area) return alert("Name & area required");
  try {
    const dup = await collectorsCol.where("name","==",name).where("area","==",area).get();
    if(!dup.empty && !confirm("Possible duplicate. Add anyway?")) return;
    await collectorsCol.add({ name, area, dateAdded: firebase.firestore.FieldValue.serverTimestamp() });
    ["col-name","col-area"].forEach(id=>document.getElementById(id).value="");
    loadCollectors();
  } catch(e){
    console.error("Add collector error:", e);
    alert("Failed to add collector: " + (e.message || e));
  }
});

async function loadCollectors(){
  const tbody = document.querySelector("#collector-table tbody");
  tbody.innerHTML = "";
  try {
    const snapshot = await collectorsCol.orderBy("name").get();
    snapshot.forEach(docSnap => {
      const d = docSnap.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${escape(d.name||"")}</td><td>${escape(d.area||"")}</td><td></td>`;
      tbody.appendChild(tr);
      if(currentRole==="admin"){
        const actionsTd = tr.querySelector("td:last-child");
        const delBtn = document.createElement("button");
        delBtn.textContent = "Delete";
        delBtn.onclick = ()=>{ if(confirm("Delete collector?")) docSnap.ref.delete().then(loadCollectors); };
        actionsTd.appendChild(delBtn);
      }
    });
  } catch(e){
    console.error("Load collectors error:", e);
  }
}

/* collectors search */
document.getElementById("search-collectors").addEventListener("input",(e)=> filterTable("collector-table", e.target.value));

/* ---------------- Helpers ---------------- */
function escape(s){ return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

function filterTable(tableId, term){
  const rows = document.getElementById(tableId).querySelectorAll("tbody tr");
  const q = (term||"").toLowerCase();
  rows.forEach(r => {
    r.style.display = r.innerText.toLowerCase().includes(q) ? "" : "none";
  });
}

/* ---------------- Ensure we attach initial state safely ---------------- */
/* If user is already logged in, auth.onAuthStateChanged will handle it; this ensures the UI doesn't stay stuck */
setTimeout(() => {
  if(auth.currentUser){
    // trigger a UI refresh defensively
    auth.onAuthStateChanged(user => { if(user) { currentRole = ROLES[user.uid] || "viewer"; applyRoleToUI(); loadAllData(); } });
  }
}, 200);

/* expose loadAllData for debugging in console if needed */
window.loadAllData = loadAllData;

</script>
</body>
</html>
