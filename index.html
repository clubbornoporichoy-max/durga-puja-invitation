<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Club Bornoporichoy ‚Äî Durga Puja Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* Existing styles unchanged */
    :root {
      --primary-red: #B71C1C;
      --deep-red: #a31313;
      --accent-gold: #D4AF37;
      --bg-start: #ffffff;
      --bg-end: #f7f0e8;
      --card: #ffffff;
      --muted: #6b6b6b;
      --text: #2f2f2f;
      --radius: 12px;
      --shadow: 0 10px 30px rgba(17,17,17,0.06);
      --glass: rgba(255,255,255,0.6);
      --toast-bg: rgba(0,0,0,0.85);
    }
    body { margin: 0; background: linear-gradient(180deg, var(--bg-start), var(--bg-end)); color: var(--text); font-family: 'Poppins', system-ui; }
    .card { background: var(--card); border-radius: var(--radius); padding: 18px; box-shadow: var(--shadow); margin-bottom: 18px; }
    .btn { background: var(--primary-red); color: #fff; border: none; padding: 10px 12px; border-radius: 10px; cursor: pointer; }
    .btn.small { padding: 7px 10px; font-size: 13px; }
    .btn.ghost { background: transparent; color: var(--deep-red); border: 1px solid rgba(0,0,0,0.06); }
    .filter-group { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 15px; }
    .filter-label { font-size: 13px; color: var(--muted); font-weight: 600; }
    .error-input { border-color: #dc3545 !important; box-shadow: 0 0 5px rgba(220, 53, 69, 0.3); }
    .pdf-download-btn { background: #17a2b8; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; }
    .pdf-download-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(23, 162, 184, 0.2); }
    .year-info { background: var(--primary-red); color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; }
    .total-collection { background: linear-gradient(135deg, var(--accent-gold), #f8e8a8); padding: 12px 16px; border-radius: 10px; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    thead th { padding: 12px 14px; background: linear-gradient(0deg, var(--accent-gold), #f6e9a8); }
    tbody td { padding: 12px 14px; border-bottom: 1px solid rgba(0,0,0,0.04); }
    .badge { padding: 6px 8px; border-radius: 8px; font-weight: 700; font-size: 13px; }
    .badge.ok { background: #28a745; color: #fff; }
    .badge.warn { background: #ff8c00; color: #fff; }
    /* Additional styles for responsiveness and other elements unchanged */
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="brand">
        <div class="logo">CB</div>
        <div>
          <h1>Club Bornoporichoy</h1>
          <div class="sub">Durga Puja Dashboard</div>
        </div>
      </div>
      <nav class="topbar">
        <a href="#invitations" id="nav-invitations" class="active">Manage Invitations</a>
        <a href="#members" id="nav-members">Members</a>
        <a href="#fees" id="nav-fees">Membership Fees</a>
        <a href="#village-collection" id="nav-village-collection">Village Collections</a>
      </nav>
      <div class="global-year-selector hidden" id="global-year-selector">
        <label>üìÖ Year:</label>
        <select id="globalYearSelect"></select>
      </div>
      <div class="auth-area">
        <div id="user-info" class="muted"></div>
        <button id="logout-btn" class="btn small hidden">Logout</button>
      </div>
    </div>
  </header>
  <div class="spacer"></div>
  <div class="container">
    <div class="card" id="auth-card">
      <div style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap">
        <div style="min-width:240px;flex:1">
          <label class="muted">Email</label>
          <input id="email" type="email" placeholder="admin@example.com" style="width:100%" />
        </div>
        <div style="min-width:220px;flex:1">
          <label class="muted">Password</label>
          <input id="password" type="password" placeholder="password" style="width:100%" />
        </div>
        <div style="min-width:160px">
          <label class="muted">Select Year</label>
          <select id="loginYearSelect" style="width:100%;"></select>
        </div>
        <button id="login-btn" class="btn">Login</button>
      </div>
      <div class="muted note">Use email/password login. Admin UID: <code>fRpLuiBgU0ZE1AtVmkGaA1RhBJk2</code></div>
    </div>
    <div id="main-content" class="hidden">
      <div class="card" id="invitations">
        <h2>ü™î Invitation List</h2>
        <div class="subtitle">Add, search, and track invitation card distribution (global data)</div>
        <div class="filter-group">
          <div><label class="filter-label">Village</label><select id="filter-village" style="min-width:150px;">
            <option value="">All Villages</option><option value="Madhabpur">Madhabpur</option><option value="Paldhui">Paldhui</option>
            <option value="Sabitrapur">Sabitrapur</option><option value="Lalupool">Lalupool</option><option value="Mahakal">Mahakal</option>
            <option value="Others">Others</option></select></div>
          <div><label class="filter-label">Status</label><select id="filter-status" style="min-width:150px;">
            <option value="">All Status</option><option value="paid">Sent</option><option value="pending">Pending</option></select></div>
          <div><label class="filter-label">From Date</label><input type="date" id="filter-date-from"></div>
          <div><label class="filter-label">To Date</label><input type="date" id="filter-date-to"></div>
          <button class="btn small" onclick="applyInvitationFilters()">Apply Filters</button>
          <button class="btn small ghost" onclick="resetInvitationFilters()">Reset</button>
          <button class="pdf-download-btn" onclick="exportInvitationsToPDF()">üìÑ Export to PDF</button>
        </div>
        <div style="display:flex;gap:12px;margin-top:12px;align-items:center">
          <input id="search-invite" type="text" placeholder="Search invitations (name / village / mobile)..." style="flex:1" />
          <div class="muted">Admin can add/edit/delete</div>
        </div>
        <table id="invitation-table" style="margin-top:12px">
          <thead><tr><th>Name</th><th>Village</th><th>Mobile</th><th>Remarks</th><th>Sent</th><th>Date Added</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
        <div style="margin-top:12px">
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <input id="inv-name" type="text" placeholder="Name" style="min-width:180px" />
            <input id="inv-village" type="text" placeholder="Village" style="min-width:160px" />
            <input id="inv-mobile" type="text" placeholder="Mobile No" style="min-width:140px" />
            <input id="inv-remarks" type="text" placeholder="Remarks" style="min-width:200px" />
            <button id="add-inv-btn" class="btn small">Add Invitation</button>
          </div>
        </div>
      </div>
      <div class="card" id="members">
        <h2>üå∏ Members List</h2>
        <div class="subtitle">Manage members (global data, used as collectors)</div>
        <div style="display:flex;gap:12px;margin-top:12px;align-items:center">
          <input id="search-members" type="text" placeholder="Search members (name/mobile)..." style="flex:1" />
          <div class="muted">Admin can add/delete</div>
        </div>
        <table id="members-table" style="margin-top:12px">
          <thead><tr><th>Name</th><th>Village</th><th>Mobile</th><th>Remarks</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
        <div style="margin-top:12px">
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <input id="mem-name" type="text" placeholder="Name" style="min-width:180px" />
            <input id="mem-village" type="text" placeholder="Village" style="min-width:160px" />
            <input id="mem-mobile" type="text" placeholder="Mobile No" style="min-width:140px" />
            <input id="mem-remarks" type="text" placeholder="Remarks" style="min-width:200px" />
            <button id="add-mem-btn" class="btn small">Add Member</button>
          </div>
        </div>
      </div>
      <div class="card" id="fees">
        <h2>üí∞ Membership Fees Tracker (<span id="fees-year-display">2025</span>)</h2>
        <div class="subtitle">Track monthly payments (year-specific data)</div>
        <div style="display:flex;gap:12px;align-items:center;margin-top:12px">
          <div style="min-width:260px">
            <label class="muted">Member</label>
            <select id="feeMemberSelect" style="width:100%"><option value="">-- Select member --</option></select>
          </div>
          <div style="min-width:140px">
            <label class="muted">Monthly Fee (‚Çπ)</label>
            <input id="feeAmountInput" type="number" min="1" value="100" style="width:100%" />
          </div>
          <div style="display:flex;gap:8px;align-items:center;margin-left:auto">
            <button id="loadMemberFeeBtn" class="btn small">Load</button>
            <button id="exportCsvBtn" class="btn small ghost">Export CSV</button>
          </div>
        </div>
        <table id="fee-months-table" style="margin-top:12px">
          <thead><tr><th>Month</th><th>Status</th><th>Paid On</th><th>Toggle (Admin)</th></tr></thead>
          <tbody></tbody>
        </table>
        <div style="margin-top:12px">
          <h3 style="margin:0 0 8px 0;color:var(--primary-red);font-size:15px">Yearly Summary</h3>
          <table id="fees-yearly-summary">
            <thead><tr><th>Month</th><th>Paid Members</th><th>Total Collected (‚Çπ)</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="card" id="village-collection">
        <h2>üèòÔ∏è Village Collection Tracker (<span id="village-collection-year-display">2025</span>)</h2>
        <div class="subtitle">Track donations per village and member (year-specific data)</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px">
          <input id="vc-bill" type="text" placeholder="Bill No" style="min-width:120px" />
          <select id="vc-member" style="min-width:160px"><option value="">-- Select Member --</option></select>
          <input id="vc-donor" type="text" placeholder="Donor Name" style="min-width:160px" />
          <input id="vc-amount" type="number" placeholder="Amount (‚Çπ)" style="min-width:120px" />
          <input id="vc-remarks" type="text" placeholder="Remarks" style="min-width:200px" />
          <select id="vc-village" style="min-width:160px">
            <option value="">-- Select Village --</option><option value="Madhabpur">Madhabpur</option><option value="Paldhui">Paldhui</option>
            <option value="Sabitrapur">Sabitrapur</option><option value="Lalupool">Lalupool</option><option value="Mahakal">Mahakal</option>
            <option value="Others">Others</option>
          </select>
          <button id="add-vc-btn" class="btn small">Add Collection</button>
          <button class="pdf-download-btn" onclick="exportVillageCollectionsToPDF()">üìÑ Export to PDF</button>
        </div>
        <div id="vc-total-collection" class="total-collection" style="display:none;">
          Total Village Collection: ‚Çπ<span id="vc-total-amount">0</span>
        </div>
        <div class="card" style="margin-top:15px;">
          <h3>üèòÔ∏è Village-wise Collection</h3>
          <div id="village-breakdown" class="village-breakdown"></div>
        </div>
        <div class="card" style="margin-top:15px;">
          <h3>üìà Monthly Collection Trend</h3>
          <canvas id="collectionChart" height="100"></canvas>
        </div>
        <table id="vc-table" style="margin-top:12px">
          <thead><tr><th>Bill No</th><th>Member</th><th>Donor Name</th><th>Amount (‚Çπ)</th><th>Remarks</th><th>Village</th><th>Date Added</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
        <input id="search-vc" type="text" placeholder="Search collections..." style="margin-top:12px;width:100%;padding:8px;border-radius:8px;border:1px solid #ccc;" />
      </div>
    </div>
  </div>
  <div class="toast-container" id="toast-container"></div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCuVs6jx7HiNIx25lzLgoq1B6nQqaHLHm0",
      authDomain: "guestandcollection.firebaseapp.com",
      projectId: "guestandcollection",
      storageBucket: "guestandcollection.firebasestorage.app",
      messagingSenderId: "272278233160",
      appId: "1:272278233160:web:d6d1e6a7d58be260d9b87d",
      measurementId: "G-B5783XTFSP"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const { jsPDF } = window.jspdf;

    let selectedYear = new Date().getFullYear();
    const ROLES = { "fRpLuiBgU0ZE1AtVmkGaA1RhBJk2": "admin", "898Fi5sPKHY01GUgI4iu1xS4TBR2": "viewer" };
    let currentRole = "viewer";
    const MONTHS = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    const invitationCol = db.collection("invitations");
    const membersCol = db.collection("members");
    function villageCollectionsColFor(year) { return db.collection(`village_collections_${year}`); }
    function membershipFeesCollectionFor(year) { return db.collection(`membership_fees_${year}`); }

    let collectionChart;
    function initCollectionChart() {
      const ctx = document.getElementById('collectionChart');
      if (!ctx) return;
      collectionChart = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
          labels: MONTHS,
          datasets: [{ label: 'Monthly Collection (‚Çπ)', data: Array(12).fill(0), borderColor: '#B71C1C', backgroundColor: 'rgba(183, 28, 28, 0.1)', tension: 0.4, fill: true }]
        },
        options: { responsive: true, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true, ticks: { callback: value => '‚Çπ' + value } } } }
      });
    }

    function populateYearDropdowns() {
      const loginYearSelect = document.getElementById('loginYearSelect');
      const globalYearSelect = document.getElementById('globalYearSelect');
      if (loginYearSelect) loginYearSelect.innerHTML = '';
      if (globalYearSelect) globalYearSelect.innerHTML = '';
      for (let year = 2025; year <= 2050; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        if (year === selectedYear) option.selected = true;
        if (loginYearSelect) loginYearSelect.appendChild(option.cloneNode(true));
        if (globalYearSelect) globalYearSelect.appendChild(option);
      }
      if (globalYearSelect) globalYearSelect.onchange = () => changeGlobalYear(globalYearSelect.value);
    }

    function updateYearDisplays() {
      ['fees-year-display', 'village-collection-year-display'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = selectedYear;
      });
    }

    function changeGlobalYear(newYear) {
      selectedYear = parseInt(newYear);
      updateYearDisplays();
      loadVillageCollections();
      loadFeeMembersDropdown();
      loadFeeYearlySummary();
      recalcTotalCollected();
      updateChartData();
      showNotification(`Year changed to ${selectedYear}`, 'info');
    }

    async function updateSummaryCards() {
      try {
        const invitationsSnap = await invitationCol.get();
        const membersSnap = await membersCol.get();
        const collectionsSnap = await villageCollectionsColFor(selectedYear).get();
        const feesSnap = await membershipFeesCollectionFor(selectedYear).get();
        let totalCollection = 0;
        collectionsSnap.forEach(doc => totalCollection += (doc.data().amount || 0));
        feesSnap.forEach(doc => {
          const months = doc.data().months || {};
          Object.values(months).forEach(m => { if (m.paid) totalCollection += (m.amount || 0); });
        });
        safeSetTextContent('summary-invitees', invitationsSnap.size);
        safeSetTextContent('summary-members', membersSnap.size);
        safeSetTextContent('summary-collection', `‚Çπ${totalCollection.toLocaleString()}`);
      } catch (e) {
        console.error('Update summary error:', e);
      }
    }

    function safeSetTextContent(elementId, text) {
      const element = document.getElementById(elementId);
      if (element) element.textContent = text;
    }

    async function loadVillageBreakdown() {
      const breakdownContainer = document.getElementById('village-breakdown');
      if (!breakdownContainer) return;
      try {
        const snap = await villageCollectionsColFor(selectedYear).get();
        const villageTotals = {};
        snap.forEach(doc => {
          const d = doc.data();
          const village = d.village || 'Others';
          villageTotals[village] = (villageTotals[village] || 0) + (d.amount || 0);
        });
        breakdownContainer.innerHTML = Object.entries(villageTotals)
          .map(([village, total]) => `<div class="breakdown-item"><div class="breakdown-label">${village}</div><div class="breakdown-value">‚Çπ${total.toLocaleString()}</div></div>`)
          .join('');
      } catch (e) {
        console.error('Load village breakdown error:', e);
        breakdownContainer.innerHTML = '<div class="breakdown-item">Error loading data</div>';
      }
    }

    function showNotification(message, type = 'info', duration = 5000) {
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      notification.innerHTML = `<span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span><span>${message}</span>`;
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), duration);
    }

    function validateMobile(mobile) {
      return mobile ? /^[0-9]{10}$/.test(mobile) : true;
    }

    function validateAmount(amount) {
      return amount > 0;
    }

    function markInvalidInput(inputElement) {
      if (inputElement) {
        inputElement.classList.add('error-input');
        setTimeout(() => inputElement.classList.remove('error-input'), 3000);
      }
    }

    async function exportInvitationsToPDF() {
      try {
        const doc = new jsPDF();
        doc.setFontSize(18);
        doc.text('Club Bornoporichoy - Invitations Report', 20, 20);
        doc.setFontSize(12);
        doc.text(`Generated on: ${new Date().toLocaleString()}`, 20, 30);
        const headers = ['Name', 'Village', 'Mobile', 'Remarks', 'Sent', 'Date Added'];
        const data = [];
        const snapshot = await invitationCol.orderBy('dateAdded', 'desc').get();
        snapshot.forEach(docSnap => {
          const d = docSnap.data();
          data.push([
            d.name || '', d.village || '', d.mobile || '', d.remarks || '',
            d.sent ? 'Sent' : 'Pending',
            d.dateAdded && d.dateAdded.toDate ? d.dateAdded.toDate().toLocaleString() : ''
          ]);
        });
        doc.autoTable({ startY: 40, head: [headers], body: data, theme: 'striped', headStyles: { fillColor: [183, 28, 28], textColor: [255, 255, 255] } });
        doc.save(`Invitations_Report_${new Date().toISOString().split('T')[0]}.pdf`);
        showNotification('Invitations PDF exported successfully', 'success');
      } catch (e) {
        showNotification('Failed to export PDF: ' + e.message, 'error');
      }
    }

    async function exportVillageCollectionsToPDF() {
      try {
        const doc = new jsPDF();
        doc.setFontSize(18);
        doc.text(`Club Bornoporichoy - Village Collections Report (${selectedYear})`, 20, 20);
        doc.setFontSize(12);
        doc.text(`Generated on: ${new Date().toLocaleString()}`, 20, 30);
        const headers = ['Bill No', 'Member', 'Donor Name', 'Amount (‚Çπ)', 'Remarks', 'Village', 'Date Added'];
        const data = [];
        const membersSnap = await membersCol.get();
        const memberMap = {};
        membersSnap.forEach(doc => { memberMap[doc.id] = doc.data().name || doc.id; });
        const snapshot = await villageCollectionsColFor(selectedYear).orderBy('dateAdded', 'desc').get();
        snapshot.forEach(docSnap => {
          const d = docSnap.data();
          data.push([
            d.bill || '',
            memberMap[d.memberId] || 'Unknown',
            d.donorName || '',
            `‚Çπ${d.amount || 0}`,
            d.remarks || '',
            d.village || '',
            d.dateAdded && d.dateAdded.toDate ? d.dateAdded.toDate().toLocaleString() : ''
          ]);
        });
        doc.autoTable({ startY: 40, head: [headers], body: data, theme: 'striped', headStyles: { fillColor: [183, 28, 28], textColor: [255, 255, 255] } });
        doc.save(`Village_Collections_${selectedYear}_${new Date().toISOString().split('T')[0]}.pdf`);
        showNotification('Village Collections PDF exported successfully', 'success');
      } catch (e) {
        showNotification('Failed to export PDF: ' + e.message, 'error');
      }
    }

    async function loadInvitations() {
      const tbody = document.querySelector('#invitation-table tbody');
      if (!tbody) return;
      const village = document.getElementById('filter-village')?.value;
      const status = document.getElementById('filter-status')?.value;
      const dateFrom = document.getElementById('filter-date-from')?.value;
      const dateTo = document.getElementById('filter-date-to')?.value;
      const searchTerm = document.getElementById('search-invite')?.value.toLowerCase() || '';
      let query = invitationCol.orderBy('dateAdded', 'desc');
      if (village) query = query.where('village', '==', village);
      if (status) query = query.where('sent', '==', status === 'paid');
      if (dateFrom) query = query.where('dateAdded', '>=', firebase.firestore.Timestamp.fromDate(new Date(dateFrom)));
      if (dateTo) {
        const toDate = new Date(dateTo);
        toDate.setHours(23, 59, 59, 999);
        query = query.where('dateAdded', '<=', firebase.firestore.Timestamp.fromDate(toDate));
      }
      try {
        const snapshot = await query.get();
        tbody.innerHTML = '';
        let total = 0;
        snapshot.forEach(doc => {
          const d = doc.data();
          if (searchTerm && !`${d.name || ''} ${d.village || ''} ${d.mobile || ''}`.toLowerCase().includes(searchTerm)) return;
          total++;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td contenteditable="${currentRole === 'admin'}">${d.name || ''}</td>
            <td contenteditable="${currentRole === 'admin'}">${d.village || ''}</td>
            <td contenteditable="${currentRole === 'admin'}">${d.mobile || ''}</td>
            <td contenteditable="${currentRole === 'admin'}">${d.remarks || ''}</td>
            <td class="center">${d.sent ? '<span class="badge ok">Sent</span>' : '<span class="badge warn">Pending</span>'}</td>
            <td>${d.dateAdded && d.dateAdded.toDate ? d.dateAdded.toDate().toLocaleString() : ''}</td>
            <td></td>
          `;
          tbody.appendChild(tr);
          if (currentRole === 'admin') {
            const actionsTd = tr.querySelector('td:last-child');
            const toggle = document.createElement('button');
            toggle.textContent = d.sent ? 'Mark Pending' : 'Mark Sent';
            toggle.className = 'btn small';
            toggle.onclick = () => doc.ref.update({ sent: !d.sent }).then(() => {
              showNotification('Invitation updated', 'success');
              loadInvitations();
              updateSummaryCards();
            });
            actionsTd.appendChild(toggle);
            const del = document.createElement('button');
            del.textContent = 'Delete';
            del.className = 'btn small ghost';
            del.onclick = () => {
              if (confirm('Delete invitation?')) doc.ref.delete().then(() => {
                showNotification('Invitation deleted', 'success');
                loadInvitations();
                updateSummaryCards();
              });
            };
            actionsTd.appendChild(del);
            tr.querySelectorAll('td[contenteditable="true"]').forEach((cell, idx) => {
              const map = ['name', 'village', 'mobile', 'remarks'];
              cell.onblur = async () => {
                const upd = { [map[idx]]: cell.textContent.trim() };
                await doc.ref.update(upd);
                showNotification('Invitation updated', 'success');
              };
            });
          }
        });
        safeSetTextContent('summary-invitees', total);
      } catch (e) {
        showNotification('Failed to load invitations: ' + e.message, 'error');
      }
    }

    function resetInvitationFilters() {
      ['filter-village', 'filter-status', 'filter-date-from', 'filter-date-to', 'search-invite'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
      loadInvitations();
    }

    async function loadMembers() {
      const tbody = document.querySelector('#members-table tbody');
      if (!tbody) return;
      tbody.innerHTML = '';
      try {
        const snap = await membersCol.orderBy('name').get();
        let total = 0;
        snap.forEach(doc => {
          total++;
          const d = doc.data();
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${d.name || ''}</td>
            <td>${d.village || ''}</td>
            <td>${d.mobile || ''}</td>
            <td>${d.remarks || ''}</td>
            <td></td>
          `;
          tbody.appendChild(tr);
          if (currentRole === 'admin') {
            const actionsTd = tr.querySelector('td:last-child');
            const del = document.createElement('button');
            del.textContent = 'Delete';
            del.className = 'btn small ghost';
            del.onclick = () => {
              if (confirm('Delete member?')) doc.ref.delete().then(() => {
                showNotification('Member deleted', 'success');
                loadMembers();
                loadFeeMembersDropdown();
                loadVcMemberDropdown();
                updateSummaryCards();
              });
            };
            actionsTd.appendChild(del);
          }
        });
        safeSetTextContent('summary-members', total);
      } catch (e) {
        showNotification('Failed to load members: ' + e.message, 'error');
      }
    }

    async function loadVcMemberDropdown() {
      const vcMemberSelect = document.getElementById('vc-member');
      if (!vcMemberSelect) return;
      vcMemberSelect.innerHTML = '<option value="">-- Select Member --</option>';
      try {
        const snap = await membersCol.orderBy('name').get();
        snap.forEach(doc => {
          const d = doc.data();
          const opt = document.createElement('option');
          opt.value = doc.id;
          opt.textContent = `${d.name} ‚Äî ${d.mobile || ''}`;
          vcMemberSelect.appendChild(opt);
        });
      } catch (e) {
        showNotification('Failed to load members: ' + e.message, 'error');
      }
    }

    async function loadVillageCollections() {
      const tbody = document.querySelector('#vc-table tbody');
      if (!tbody) return;
      tbody.innerHTML = '';
      try {
        const membersSnap = await membersCol.get();
        const memberMap = {};
        membersSnap.forEach(doc => { memberMap[doc.id] = doc.data().name || doc.id; });
        const snap = await villageCollectionsColFor(selectedYear).orderBy('dateAdded', 'desc').get();
        let totalAmount = 0;
        snap.forEach(doc => {
          const d = doc.data();
          totalAmount += (d.amount || 0);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${d.bill || ''}</td>
            <td>${memberMap[d.memberId] || 'Unknown'}</td>
            <td>${d.donorName || ''}</td>
            <td>‚Çπ${d.amount || 0}</td>
            <td>${d.remarks || ''}</td>
            <td>${d.village || ''}</td>
            <td>${d.dateAdded && d.dateAdded.toDate ? d.dateAdded.toDate().toLocaleString() : ''}</td>
            <td></td>
          `;
          tbody.appendChild(tr);
          if (currentRole === 'admin') {
            const delBtn = document.createElement('button');
            delBtn.textContent = 'Delete';
            delBtn.className = 'btn small ghost';
            delBtn.onclick = () => {
              if (confirm('Delete collection?')) doc.ref.delete().then(() => {
                showNotification('Collection deleted', 'success');
                loadVillageCollections();
                recalcTotalCollected();
                loadVillageBreakdown();
                updateChartData();
              });
            };
            tr.querySelector('td:last-child').appendChild(delBtn);
          }
        });
        const totalElement = document.getElementById('vc-total-collection');
        const totalAmountElement = document.getElementById('vc-total-amount');
        if (totalAmount > 0 && totalElement && totalAmountElement) {
          totalAmountElement.textContent = totalAmount.toLocaleString();
          totalElement.style.display = 'block';
        } else if (totalElement) {
          totalElement.style.display = 'none';
        }
      } catch (e) {
        showNotification('Failed to load collections: ' + e.message, 'error');
      }
    }

    async function recalcTotalCollected() {
      try {
        const collectionsSnap = await villageCollectionsColFor(selectedYear).get();
        const feesSnap = await membershipFeesCollectionFor(selectedYear).get();
        let total = 0;
        collectionsSnap.forEach(doc => total += (doc.data().amount || 0));
        feesSnap.forEach(doc => {
          const months = doc.data().months || {};
          Object.values(months).forEach(m => { if (m.paid) total += (m.amount || 0); });
        });
        safeSetTextContent('summary-collection', `‚Çπ${total.toLocaleString()}`);
      } catch (e) {
        showNotification('Failed to calculate total: ' + e.message, 'error');
      }
    }

    async function updateChartData() {
      try {
        const snap = await villageCollectionsColFor(selectedYear).get();
        const monthlyData = Array(12).fill(0);
        snap.forEach(doc => {
          const d = doc.data();
          if (d.dateAdded && d.dateAdded.toDate) {
            const month = d.dateAdded.toDate().getMonth();
            monthlyData[month] += (d.amount || 0);
          }
        });
        if (collectionChart) {
          collectionChart.data.datasets[0].data = monthlyData;
          collectionChart.update();
        }
      } catch (e) {
        showNotification('Failed to update chart: ' + e.message, 'error');
      }
    }

    async function loadFeeMembersDropdown() {
      const feeMemberSelect = document.getElementById('feeMemberSelect');
      if (!feeMemberSelect) return;
      feeMemberSelect.innerHTML = '<option value="">-- Select member --</option>';
      try {
        const snap = await membersCol.orderBy('name').get();
        snap.forEach(doc => {
          const d = doc.data();
          const opt = document.createElement('option');
          opt.value = doc.id;
          opt.textContent = `${d.name} ‚Äî ${d.mobile || ''}`;
          feeMemberSelect.appendChild(opt);
        });
      } catch (e) {
        showNotification('Failed to load members: ' + e.message, 'error');
      }
    }

    async function loadFeeYearlySummary() {
      const tbody = document.querySelector('#fees-yearly-summary tbody');
      if (!tbody) return;
      tbody.innerHTML = '';
      try {
        const snap = await membershipFeesCollectionFor(selectedYear).get();
        const monthlyTotals = Array(12).fill(0);
        const paidMembers = Array(12).fill(0);
        snap.forEach(doc => {
          const months = doc.data().months || {};
          Object.entries(months).forEach(([month, data]) => {
            const monthIdx = MONTHS.indexOf(month);
            if (data.paid) {
              monthlyTotals[monthIdx] += (data.amount || 0);
              paidMembers[monthIdx]++;
            }
          });
        });
        MONTHS.forEach((month, idx) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${month}</td><td>${paidMembers[idx]}</td><td>‚Çπ${monthlyTotals[idx].toLocaleString()}</td>`;
          tbody.appendChild(tr);
        });
      } catch (e) {
        showNotification('Failed to load fee summary: ' + e.message, 'error');
      }
    }

    document.getElementById('add-inv-btn')?.addEventListener('click', async () => {
      if (currentRole !== 'admin') return alert('Only admin can add');
      const name = document.getElementById('inv-name')?.value.trim();
      const village = document.getElementById('inv-village')?.value.trim();
      const mobile = document.getElementById('inv-mobile')?.value.trim();
      const remarks = document.getElementById('inv-remarks')?.value.trim();
      if (!name || !village) {
        showNotification('Name and Village are required', 'error');
        if (!name) markInvalidInput(document.getElementById('inv-name'));
        if (!village) markInvalidInput(document.getElementById('inv-village'));
        return;
      }
      if (mobile && !validateMobile(mobile)) {
        showNotification('Invalid mobile number (must be 10 digits)', 'error');
        markInvalidInput(document.getElementById('inv-mobile'));
        return;
      }
      try {
        await invitationCol.add({ name, village, mobile, remarks, sent: false, dateAdded: firebase.firestore.FieldValue.serverTimestamp() });
        ['inv-name', 'inv-village', 'inv-mobile', 'inv-remarks'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.value = '';
        });
        showNotification('Invitation added', 'success');
        loadInvitations();
        updateSummaryCards();
      } catch (e) {
        showNotification('Failed to add invitation: ' + e.message, 'error');
      }
    });

    document.getElementById('add-mem-btn')?.addEventListener('click', async () => {
      if (currentRole !== 'admin') return alert('Only admin can add');
      const name = document.getElementById('mem-name')?.value.trim();
      const village = document.getElementById('mem-village')?.value.trim();
      const mobile = document.getElementById('mem-mobile')?.value.trim();
      const remarks = document.getElementById('mem-remarks')?.value.trim();
      if (!name || !mobile) {
        showNotification('Name and Mobile are required', 'error');
        if (!name) markInvalidInput(document.getElementById('mem-name'));
        if (!mobile) markInvalidInput(document.getElementById('mem-mobile'));
        return;
      }
      if (!validateMobile(mobile)) {
        showNotification('Invalid mobile number (must be 10 digits)', 'error');
        markInvalidInput(document.getElementById('mem-mobile'));
        return;
      }
      try {
        await membersCol.add({ name, village, mobile, remarks, dateAdded: firebase.firestore.FieldValue.serverTimestamp() });
        ['mem-name', 'mem-village', 'mem-mobile', 'mem-remarks'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.value = '';
        });
        showNotification('Member added', 'success');
        loadMembers();
        loadFeeMembersDropdown();
        loadVcMemberDropdown();
        updateSummaryCards();
      } catch (e) {
        showNotification('Failed to add member: ' + e.message, 'error');
      }
    });

    document.getElementById('add-vc-btn')?.addEventListener('click', async () => {
      if (currentRole !== 'admin') return alert('Only admin can add');
      const bill = document.getElementById('vc-bill')?.value.trim();
      const memberId = document.getElementById('vc-member')?.value;
      const donorName = document.getElementById('vc-donor')?.value.trim();
      const amount = Number(document.getElementById('vc-amount')?.value) || 0;
      const remarks = document.getElementById('vc-remarks')?.value.trim();
      const village = document.getElementById('vc-village')?.value;
      if (!bill || !memberId || !donorName || !amount || !village) {
        showNotification('All fields are required', 'error');
        if (!bill) markInvalidInput(document.getElementById('vc-bill'));
        if (!memberId) markInvalidInput(document.getElementById('vc-member'));
        if (!donorName) markInvalidInput(document.getElementById('vc-donor'));
        if (!amount) markInvalidInput(document.getElementById('vc-amount'));
        if (!village) markInvalidInput(document.getElementById('vc-village'));
        return;
      }
      if (!validateAmount(amount)) {
        showNotification('Amount must be greater than 0', 'error');
        markInvalidInput(document.getElementById('vc-amount'));
        return;
      }
      try {
        await villageCollectionsColFor(selectedYear).add({
          bill, memberId, donorName, amount, remarks, village,
          dateAdded: firebase.firestore.FieldValue.serverTimestamp()
        });
        ['vc-bill', 'vc-member', 'vc-donor', 'vc-amount', 'vc-remarks', 'vc-village'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.value = '';
        });
        showNotification('Collection added', 'success');
        loadVillageCollections();
        recalcTotalCollected();
        loadVillageBreakdown();
        updateChartData();
      } catch (e) {
        showNotification('Failed to add collection: ' + e.message, 'error');
      }
    });

    document.getElementById('loadMemberFeeBtn')?.addEventListener('click', async () => {
      const memberId = document.getElementById('feeMemberSelect')?.value;
      const feeAmount = Number(document.getElementById('feeAmountInput')?.value) || 100;
      if (!memberId) return showNotification('Select a member', 'error');
      try {
        const doc = await membershipFeesCollectionFor(selectedYear).doc(memberId).get();
        const tbody = document.querySelector('#fee-months-table tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        const months = doc.exists ? (doc.data().months || {}) : {};
        MONTHS.forEach(month => {
          const data = months[month] || { paid: false, paidOn: null, amount: feeAmount };
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${month}</td>
            <td>${data.paid ? '<span class="badge ok">Paid</span>' : '<span class="badge warn">Not Paid</span>'}</td>
            <td>${data.paidOn && data.paidOn.toDate ? data.paidOn.toDate().toLocaleString() : ''}</td>
            <td>${currentRole === 'admin' ? `<button class="btn small" onclick="toggleFee('${memberId}', '${month}', ${!data.paid})">${data.paid ? 'Mark Not Paid' : 'Mark Paid'}</button>` : ''}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (e) {
        showNotification('Failed to load fees: ' + e.message, 'error');
      }
    });

    async function toggleFee(memberId, month, paid) {
      try {
        const feeAmount = Number(document.getElementById('feeAmountInput')?.value) || 100;
        const upd = { [`months.${month}`]: { paid, amount: feeAmount, paidOn: paid ? firebase.firestore.FieldValue.serverTimestamp() : null } };
        await membershipFeesCollectionFor(selectedYear).doc(memberId).set(upd, { merge: true });
        showNotification(`Marked ${month} as ${paid ? 'paid' : 'not paid'}`, 'success');
        document.getElementById('loadMemberFeeBtn')?.click();
        recalcTotalCollected();
        loadFeeYearlySummary();
      } catch (e) {
        showNotification('Failed to update fee: ' + e.message, 'error');
      }
    }

    document.getElementById('exportCsvBtn')?.addEventListener('click', async () => {
      try {
        const snap = await membershipFeesCollectionFor(selectedYear).get();
        const membersSnap = await membersCol.get();
        const memberMap = {};
        membersSnap.forEach(doc => { memberMap[doc.id] = doc.data().name; });
        let csv = 'Member,Month,Status,Amount,Paid On\n';
        snap.forEach(doc => {
          const memberId = doc.id;
          const months = doc.data().months || {};
          MONTHS.forEach(month => {
            const data = months[month] || { paid: false, amount: 0, paidOn: null };
            csv += `"${memberMap[memberId] || memberId}","${month}","${data.paid ? 'Paid' : 'Not Paid'}","${data.amount || 0}","${data.paidOn && data.paidOn.toDate ? data.paidOn.toDate().toLocaleString() : ''}"\n`;
          });
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Membership_Fees_${selectedYear}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        showNotification('Fees exported to CSV', 'success');
      } catch (e) {
        showNotification('Failed to export CSV: ' + e.message, 'error');
      }
    });

    document.getElementById('search-vc')?.addEventListener('input', e => {
      const term = e.target.value.toLowerCase();
      const rows = document.querySelectorAll('#vc-table tbody tr');
      rows.forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(term) ? '' : 'none';
      });
    });

    document.getElementById('search-members')?.addEventListener('input', e => {
      const term = e.target.value.toLowerCase();
      const rows = document.querySelectorAll('#members-table tbody tr');
      rows.forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(term) ? '' : 'none';
      });
    });

    document.getElementById('login-btn')?.addEventListener('click', () => {
      const email = document.getElementById('email')?.value.trim();
      const pw = document.getElementById('password')?.value;
      selectedYear = parseInt(document.getElementById('loginYearSelect')?.value) || new Date().getFullYear();
      if (!email || !pw) return showNotification('Enter email and password', 'error');
      auth.signInWithEmailAndPassword(email, pw)
        .then(() => {
          showNotification('Logged in successfully', 'success');
          document.getElementById('main-content').classList.remove('hidden');
          document.getElementById('auth-card').classList.add('hidden');
          document.getElementById('global-year-selector').classList.remove('hidden');
        })
        .catch(e => showNotification('Login failed: ' + e.message, 'error'));
    });

    document.getElementById('logout-btn')?.addEventListener('click', () => {
      auth.signOut().then(() => {
        showNotification('Logged out', 'success');
        document.getElementById('main-content').classList.add('hidden');
        document.getElementById('auth-card').classList.remove('hidden');
        document.getElementById('global-year-selector').classList.add('hidden');
      }).catch(e => showNotification('Logout failed: ' + e.message, 'error'));
    });

    auth.onAuthStateChanged(user => {
      if (user) {
        currentRole = ROLES[user.uid] || 'viewer';
        document.getElementById('user-info').textContent = `${user.email} (${currentRole})`;
        ['add-inv-btn', 'add-mem-btn', 'add-vc-btn', 'loadMemberFeeBtn'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.disabled = currentRole !== 'admin';
        });
        loadInvitations();
        loadMembers();
        loadVillageCollections();
        loadFeeMembersDropdown();
        loadFeeYearlySummary();
        updateSummaryCards();
        loadVillageBreakdown();
        updateChartData();
        initCollectionChart();
        populateYearDropdowns();
        updateYearDisplays();
      } else {
        document.getElementById('user-info').textContent = '';
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      populateYearDropdowns();
    });
  </script>
</body>
</html>
