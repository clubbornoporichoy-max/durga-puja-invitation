<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Club Bornoporichoy ‚Äî Durga Puja Dashboard</title>

<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<!-- Firebase compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
  :root{
    --red:#B71C1C;
    --deep-red:#a31313;
    --gold:#D4AF37;
    --bg-start:#ffffff;
    --bg-end:#f7f0e8;
    --card:#ffffff;
    --muted:#6b6b6b;
    --text:#2f2f2f;
    --radius:12px;
    --shadow:0 10px 30px rgba(17,17,17,0.06);
    --glass: rgba(255,255,255,0.6);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body {
    margin: 0;
    background: linear-gradient(180deg, var(--bg-start), var(--bg-end));
    color: var(--text);
    font-family: 'Poppins', system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    line-height:1.45;
  }

  /* Header / nav (fixed) */
  header {
    position: fixed; top:0; left:0; right:0; z-index:100;
    background: linear-gradient(90deg, rgba(255,255,255,0.96), rgba(255,250,240,0.96));
    border-bottom: 1px solid rgba(0,0,0,0.04);
    padding: 12px 18px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.05);
    backdrop-filter: blur(6px);
  }
  .header-inner { max-width:1200px; margin:0 auto; display:flex; gap:12px; align-items:center; }
  .brand { display:flex; align-items:center; gap:12px; }
  .logo {
    width:44px; height:44px; border-radius:10px;
    background: linear-gradient(135deg, var(--red), #e34b4b);
    display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; box-shadow:0 4px 14px rgba(183,28,28,0.12);
  }
  .brand h1 { margin:0; font-size:16px; color:var(--deep-red); font-weight:700; letter-spacing:0.2px; }
  .brand .sub { font-size:12px; color:var(--muted); margin-top:2px; }

  nav.topbar { margin-left:20px; display:flex; gap:10px; align-items:center; flex:1; }
  nav.topbar a {
    padding:8px 12px; border-radius:10px; text-decoration:none; color:var(--deep-red);
    font-weight:600; font-size:14px; transition: all 160ms ease;
  }
  nav.topbar a:hover { transform: translateY(-2px); color: #7f0f0f; box-shadow: inset 0 -2px 0 var(--gold); }
  nav.topbar a.active { background: rgba(183,28,28,0.06); }

  .auth-area { margin-left:auto; display:flex; gap:8px; align-items:center; }

  /* Container + cards */
  .spacer { height:110px } /* to offset fixed header */
  .container { max-width:1200px; margin:22px auto; padding:0 18px 120px; }
  .card { background:var(--card); padding:18px; border-radius:var(--radius); box-shadow:var(--shadow); margin-bottom:18px; border:1px solid rgba(0,0,0,0.03); }
  .card h2 { margin:0 0 8px 0; color:var(--red); font-size:18px; display:flex; align-items:center; gap:8px; }
  .subtitle { color:var(--muted); font-size:13px; margin-bottom:10px; }

  .flex { display:flex; gap:12px; align-items:center; }
  .flex.space { justify-content:space-between; }

  input[type="text"], input[type="email"], input[type="password"], input[type="number"], select, textarea {
    padding:10px 12px; border-radius:10px; border:1px solid rgba(0,0,0,0.06); background:#fff;
    font-size:14px; color:var(--text); outline:none;
  }
  input:focus, select:focus, textarea:focus { box-shadow: 0 8px 24px rgba(183,28,28,0.06); border-color: rgba(183,28,28,0.18); }

  /* Buttons */
  .btn { background:var(--red); color:#fff; border:none; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:600; box-shadow: 0 8px 20px rgba(183,28,28,0.08); transition: transform 120ms ease, box-shadow 120ms ease; }
  .btn:hover{ transform: translateY(-2px); box-shadow: 0 14px 28px rgba(183,28,28,0.12); }
  .btn.small { padding:7px 10px; font-size:13px; border-radius:8px; }
  .btn.secondary { background:var(--gold); color:#222; box-shadow:none; }
  .btn.ghost { background:transparent; color:var(--deep-red); border:1px solid rgba(0,0,0,0.06); box-shadow:none; }

  .muted { color:var(--muted); font-size:13px; }
  .note { font-size:13px; color:var(--muted); margin-top:8px; }

  /* Tables */
  table { width:100%; border-collapse:collapse; font-size:14px; margin-top:12px; }
  thead th {
    text-align:left; padding:12px 14px; background:linear-gradient(0deg,var(--gold), #f6e9a8); color:var(--text); border-bottom:2px solid rgba(0,0,0,0.04);
  }
  tbody td { padding:12px 14px; border-bottom:1px solid rgba(0,0,0,0.04); vertical-align:middle; }
  tbody tr:hover { background: rgba(183,28,28,0.02); }
  .editable { background: linear-gradient(180deg,#fff8e6,#fffdf7); border-radius:6px; padding:8px; }
  .badge { display:inline-block; padding:6px 8px; border-radius:8px; font-weight:700; font-size:13px; transition: transform 240ms ease, opacity 240ms ease; }
  .badge.ok { background:#28a745; color:#fff; }
  .badge.warn { background:#ff8c00; color:#fff; }
  .badge.pulse { animation: pulse 1.6s infinite; }
  @keyframes pulse{0%{transform:scale(1);opacity:1}50%{transform:scale(1.04);opacity:0.88}100%{transform:scale(1);opacity:1}}

  .center { text-align:center; }
  .right { margin-left:auto; }

  /* small helpers */
  .hidden{display:none}
  .small{font-size:0.9em}

  /* responsive */
  @media (max-width:980px){
    .header-inner{flex-direction:column; gap:10px; align-items:flex-start}
    nav.topbar{flex-wrap:wrap}
    .flex{flex-direction:column; align-items:stretch}
    .spacer{height:180px}
    table thead{display:none}
    table, tbody, tr, td { display:block; width:100%;}
    tbody td{padding:8px;border-bottom:1px solid #eee}
    tbody td:before{content:attr(data-label);font-weight:600;display:block;margin-bottom:6px;color:#444}
  }

  /* donations extras */
  .donation-filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:10px}
  .search-small{padding:8px 10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)}
  .donation-quick{font-weight:700;color:var(--red)}
  .toast{position:fixed;right:18px;bottom:20px;background:#111;color:#fff;padding:10px 14px;border-radius:8px;opacity:0;transition:opacity 240ms}
  .toast.show{opacity:1}
  .timeline { font-family: monospace; white-space: nowrap; overflow-x:auto; padding:6px 0; }
  .timeline .dot { display:inline-block; width:18px; height:18px; line-height:18px; text-align:center; margin-right:6px; border-radius:4px; }
  .dot.paid { background:#28a745; color:#fff; }
  .dot.pending { background:#ddd; color:#777; }
</style>
</head>
<body>
<header>
  <div class="header-inner">
    <div class="brand">
      <div class="logo">CB</div>
      <div>
        <h1>Club Bornoporichoy</h1>
        <div class="sub">Durga Puja Dashboard</div>
      </div>
    </div>

    <nav class="topbar" role="navigation" aria-label="Main navigation">
      <a href="#invitations" id="nav-invitations" class="active">Manage Invitations</a>
      <a href="#members" id="nav-members">Members</a>
      <a href="#collectors" id="nav-collectors">Donation Collectors</a>
      <a href="#fees" id="nav-fees">Membership Fees</a>
      <a href="#village-collection" id="nav-village">Village Collection</a>
    </nav>

    <div class="auth-area">
      <div id="user-info" class="muted small" style="margin-right:8px;"></div>
      <button id="logout-btn" class="btn small hidden">Logout</button>
    </div>
  </div>
</header>

<div class="spacer"></div>

<div class="container">

  <!-- Auth Card -->
  <div class="card" id="auth-card">
    <div class="flex" style="align-items:flex-end;">
      <div style="min-width:260px;">
        <label class="small muted">Email</label><br>
        <input id="email" type="email" placeholder="admin@club.com" />
      </div>
      <div style="min-width:220px;">
        <label class="small muted">Password</label><br>
        <input id="password" type="password" placeholder="password" />
      </div>

      <div style="min-width:200px;" class="year-select">
        <label class="small muted" for="yearSelect">Default Year</label>
        <select id="yearSelect"></select>
      </div>

      <div class="right">
        <button id="login-btn" class="btn">Login</button>
      </div>
    </div>
    <div class="muted small" style="margin-top:10px;">
      Use email/password login. Admin UID: <code>fRpLuiBgU0ZE1AtVmkGaA1RhBJk2</code>
    </div>
  </div>

  <!-- Summary bar (sticky under header) -->
  <div class="card" id="summary-card" style="position:sticky; top:74px; z-index:80;">
    <div class="flex space">
      <div>
        <div style="font-weight:700;color:var(--red)">Invitees</div>
        <div id="summary-invitees" class="muted">‚Äî</div>
      </div>
      <div>
        <div style="font-weight:700;color:var(--red)">Members</div>
        <div id="summary-members" class="muted">‚Äî</div>
      </div>
      <div class="right">
        <div style="font-weight:700;color:var(--red)">Total Collected (Membership)</div>
        <div id="summary-collection" class="muted">‚Çπ0 (0 members)</div>
      </div>
    </div>
  </div>

  <!-- Invitations -->
  <div class="card" id="invitations">
    <h2>ü™î Invitation List</h2>
    <div class="subtitle">Add, search and track invitation card distribution</div>

    <div class="flex" style="margin-top:12px;align-items:center">
      <input id="search-invite" type="text" placeholder="Search invitations (name / village / mobile)..." style="flex:1" />
      <div class="muted">Admin can add/edit/delete</div>
    </div>

    <table id="invitation-table">
      <thead><tr><th>Name</th><th>Village</th><th>Mobile</th><th>Remarks</th><th>Sent</th><th>Date Added</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>

    <div style="margin-top:12px">
      <div class="flex" style="flex-wrap:wrap">
        <input id="inv-name" type="text" placeholder="Name" style="min-width:180px" />
        <input id="inv-village" type="text" placeholder="Village" style="min-width:160px" />
        <input id="inv-mobile" type="text" placeholder="Mobile No" style="min-width:140px" />
        <input id="inv-remarks" type="text" placeholder="Remarks" style="min-width:200px" />
        <button id="add-inv-btn" class="btn small">Add Invitation</button>
      </div>
    </div>
  </div>

  <!-- Members -->
  <div class="card" id="members">
    <h2>üå∏ Members List</h2>
    <div class="subtitle">Manage members ‚Äî linked to membership fee tracker</div>

    <div class="flex" style="margin-top:12px;align-items:center">
      <input id="search-members" type="text" placeholder="Search members (name/mobile)..." style="flex:1" />
      <div class="muted">Admin can add/edit/delete</div>
    </div>

    <table id="members-table">
      <thead><tr><th>Name</th><th>Village</th><th>Mobile</th><th>Remarks</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>

    <div style="margin-top:12px">
      <div class="flex" style="flex-wrap:wrap">
        <input id="mem-name" type="text" placeholder="Name" style="min-width:180px" />
        <input id="mem-village" type="text" placeholder="Village" style="min-width:160px" />
        <input id="mem-mobile" type="text" placeholder="Mobile No" style="min-width:140px" />
        <input id="mem-remarks" type="text" placeholder="Remarks" style="min-width:200px" />
        <button id="add-mem-btn" class="btn small">Add Member</button>
      </div>
    </div>
  </div>

  <!-- Membership Fees -->
  <div class="card" id="fees">
    <h2>üí∞ Membership Fees Tracker (per Year)</h2>
    <div class="subtitle">Track monthly payments (‚Çπ per month configurable)</div>

    <div class="flex" style="margin-top:12px;align-items:center">
      <div style="min-width:160px">
        <label class="muted">Year</label>
        <select id="feeYearSelectSmall2" style="width:100%"></select>
      </div>

      <div style="min-width:260px">
        <label class="muted">Member</label>
        <select id="feeMemberSelect" style="width:100%"><option value="">-- Select member --</option></select>
      </div>

      <div style="min-width:140px">
        <label class="muted">Monthly Fee (‚Çπ)</label>
        <input id="feeAmountInput" type="number" min="1" value="100" />
      </div>

      <div style="display:flex;gap:8px;align-items:center;margin-left:auto">
        <button id="loadMemberFeeBtn" class="btn small">Load</button>
        <button id="exportCsvBtn" class="btn small secondary">Export CSV</button>
      </div>
    </div>

    <table id="fee-months-table">
      <thead><tr><th>Month</th><th>Status</th><th>Paid On</th><th>Toggle (Admin)</th></tr></thead>
      <tbody></tbody>
    </table>

    <div style="display:flex;align-items:center;gap:12px;margin-top:12px">
      <div id="fee-member-summary" class="muted">Select member to load fees</div>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button id="saveFeeConfigBtn" class="btn small">Save Config</button>
        <button id="clearFeeRecordBtn" class="btn small ghost">Clear</button>
      </div>
    </div>

    <div style="margin-top:12px">
      <h3 style="margin:0 0 8px 0;color:var(--red);font-size:15px">Yearly Summary</h3>
      <table id="fees-yearly-summary">
        <thead><tr><th>Month</th><th>Paid Members</th><th>Total Collected (‚Çπ)</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Village Collection (Donations) -->
  <div class="card" id="village-collection">
    <h2>üè∫ Village Collection (Donations)</h2>
    <div class="subtitle">Record bill no, collector, village, amount, remark and date (per year)</div>

    <div class="donation-filters">
      <div style="min-width:140px">
        <label class="muted">Year</label>
        <select id="donationYearSelectSmall" style="width:100%"></select>
      </div>

      <div style="min-width:240px">
        <label class="muted">Collector</label>
        <select id="donationCollectorSelectSmall" style="width:100%"><option value="">-- All collectors --</option></select>
      </div>

      <div style="min-width:180px">
        <label class="muted">Village</label>
        <select id="donationVillageFilter" style="width:100%">
          <option value="">-- All villages --</option>
          <option>Madhabpur</option>
          <option>Paldhui</option>
          <option>Sabitrapur</option>
          <option>Collage More</option>
          <option>Lalupul</option>
          <option>Mahakal</option>
          <option>Ganesh More</option>
        </select>
      </div>

      <input id="donationSearch" class="search-small" style="flex:1" placeholder="Search by bill no or collector name...">

      <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
        <button id="exportDonationsCsvBtn" class="btn small secondary export-btn">Export Donations CSV</button>
        <div style="text-align:right">
          <div class="muted">Village Collection (year)</div>
          <div id="donation-year-total" class="donation-quick">‚Çπ0</div>
        </div>
      </div>
    </div>

    <div style="margin-top:12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
      <input id="donationBillInput" type="text" placeholder="Bill No (manual allowed)" style="min-width:120px" />
      <select id="donationCollectorInput" style="min-width:220px"><option value="">-- Select collector --</option></select>
      <select id="donationVillageInput" style="min-width:160px">
        <option>Madhabpur</option><option>Paldhui</option><option>Sabitrapur</option><option>Collage More</option><option>Lalupul</option><option>Mahakal</option><option>Ganesh More</option>
      </select>
      <input id="donationMobileInput" type="text" placeholder="Collector Mobile (optional)" style="min-width:140px" />
      <input id="donationAmountInput" type="number" min="1" value="0" style="min-width:120px" />
      <input id="donationRemarksInput" type="text" placeholder="Remarks (optional)" style="flex:1; min-width:180px" />
      <button id="add-donation-btn" class="btn small">Add Donation</button>
    </div>

    <table id="donation-table">
      <thead><tr><th>Bill No</th><th>Collector</th><th>Mobile</th><th>Village</th><th>Amount (‚Çπ)</th><th>Remarks</th><th>Date</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Timeline paid-month visualization -->
  <div class="card" id="paid-timeline">
    <h2>üìã Paid-Month Timeline (All Members)</h2>
    <div class="subtitle">Each row shows paid months for a member in selected year (üü© = paid)</div>
    <div id="timeline-container" style="max-height:320px; overflow:auto;"></div>
  </div>

</div> <!-- container -->

<!-- toast -->
<div id="toast" class="toast"></div>

<script>
/* ---------------- Firebase config (hardcoded) ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyCuVs6jx7HiNIx25lzLgoq1B6nQqaHLHm0",
  authDomain: "guestandcollection.firebaseapp.com",
  projectId: "guestandcollection",
  storageBucket: "guestandcollection.firebasestorage.app",
  messagingSenderId: "272278233160",
  appId: "1:272278233160:web:d6d1e6a7d58be260d9b87d",
  measurementId: "G-B5783XTFSP"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ---------------- Roles & constants ---------------- */
const ROLES = {
  "fRpLuiBgU0ZE1AtVmkGaA1RhBJk2": "admin",
  "898Fi5sPKHY01GUgI4iu1xS4TBR2": "viewer"
};
const ADMIN_UID = "fRpLuiBgU0ZE1AtVmkGaA1RhBJk2";
let currentRole = "viewer";
const MONTHS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

/* ---------------- collections helpers ---------------- */
const invitationCol = db.collection("invitations");
const membersCol = db.collection("members");
const collectorsCol = db.collection("collectors");
function membershipFeesCollectionFor(year){ return db.collection(`membership_fees_${year}`); }
function villageCollectionsFor(year){ return db.collection(`village_collections_${year}`); }
function donationsCollectionFor(year){ return db.collection(`donations_${year}`); } // kept if needed

/* ---------------- year selectors (2025-2050) ---------------- */
const yearSelect = document.getElementById('yearSelect');
const feeYearSmall = document.getElementById('feeYearSelectSmall2');
const feeYearSmall2 = document.getElementById('feeYearSelectSmall2'); // alias
const donationYearSmall = document.getElementById('donationYearSelectSmall');
const now = new Date().getFullYear();
for(let y=2025;y<=2050;y++){
  const o=document.createElement('option'); o.value=y; o.textContent=y;
  if(y===now) o.selected=true;
  yearSelect.appendChild(o);
  feeYearSmall.appendChild(o.cloneNode(true));
  donationYearSmall.appendChild(o.cloneNode(true));
}
let selectedFeeYear = parseInt(feeYearSmall.value || 2025);
let selectedDonationYear = parseInt(donationYearSmall.value || 2025);
feeYearSmall.addEventListener('change', ()=>{ selectedFeeYear = parseInt(feeYearSmall.value); loadFeeMembersDropdown(); loadFeeYearlySummary(); updateSummaryTotals(); loadTimeline(); });
donationYearSmall.addEventListener('change', ()=>{ selectedDonationYear = parseInt(donationYearSmall.value); loadDonationCollectorsDropdownSmall(); loadDonationsTable(); updateDonationTotal(); });

/* ---------------- UI helpers ---------------- */
function showToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2500); }
function escapeHtml(s){ return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,">").replace(/"/g,"&quot;"); }
function setVisible(id, visible){ const el=document.getElementById(id); if(!el) return; el.classList.toggle('hidden', !visible); }

/* ---------------- Auth (email/password) ---------------- */
const loginBtn = document.getElementById("login-btn");
const logoutBtn = document.getElementById("logout-btn");
const userInfo = document.getElementById("user-info");
const mainContent = document.querySelector('.container');

loginBtn.addEventListener("click", () => {
  const email = document.getElementById("email").value.trim();
  const pw = document.getElementById("password").value;
  if(!email || !pw) return alert("Enter email and password");
  loginBtn.disabled = true;
  auth.signInWithEmailAndPassword(email,pw)
    .catch(e => { alert("Login error: "+e.message); })
    .finally(()=> loginBtn.disabled = false);
});
logoutBtn.addEventListener("click", () => {
  logoutBtn.disabled = true;
  auth.signOut().catch(e => alert("Logout error: "+e.message)).finally(()=> logoutBtn.disabled = false);
});

auth.onAuthStateChanged(user => {
  if(user){
    currentRole = ROLES[user.uid] || "viewer";
    document.getElementById("email").style.display = "none";
    document.getElementById("password").style.display = "none";
    loginBtn.style.display = "none";
    logoutBtn.classList.remove("hidden");
    userInfo.textContent = `${user.email} (${currentRole})`;
    applyRoleToUI();
    setTimeout(()=>{ loadAllData(); loadFeeMembersDropdown(); loadFeeYearlySummary(); loadDonationCollectorsDropdownSmall(); loadDonationsTable(); loadTimeline(); }, 150);
  } else {
    document.getElementById("email").style.display = "";
    document.getElementById("password").style.display = "";
    loginBtn.style.display = "";
    logoutBtn.classList.add("hidden");
    userInfo.textContent = "";
    clearAllTables();
  }
});

/* ---------------- UI Role enforcement ---------------- */
function applyRoleToUI(){
  const adminOnlyBtns = ["add-inv-btn","add-mem-btn","add-donation-btn","add-col-btn","loadMemberFeeBtn","saveFeeConfigBtn","clearFeeRecordBtn","add-donation-btn"];
  adminOnlyBtns.forEach(id => { const el=document.getElementById(id); if(el) el.disabled = (currentRole !== "admin"); });
}

/* ---------------- Clear tables ---------------- */
function clearAllTables(){
  ["invitation-table","members-table","collector-table","monthly-summary-table","fee-months-table","fees-yearly-summary","donation-table"].forEach(t => {
    const tb = document.getElementById(t)?.querySelector("tbody");
    if(tb) tb.innerHTML = "";
  });
  document.getElementById("summary-invitees").textContent = "Invitees: ‚Äî";
  document.getElementById("summary-members").textContent = "Members: ‚Äî";
  document.getElementById("summary-collection").textContent = "Total Collected: ‚Çπ0";
}

/* ---------------- Load everything ---------------- */
function loadAllData(){
  loadInvitations(); loadMembers(); loadCollectors(); updateSummaryTotals(); loadFeeMembersDropdown(); loadFeeYearlySummary(); loadDonationCollectorsDropdownSmall(); loadDonationsTable(); loadTimeline();
}

/* ---------------- INVITATIONS ---------------- */
document.getElementById("add-inv-btn").addEventListener("click", async () => {
  if(currentRole !== "admin") return alert("Only admin can add");
  const name = document.getElementById("inv-name").value.trim();
  const village = document.getElementById("inv-village").value.trim();
  const mobile = document.getElementById("inv-mobile").value.trim();
  const remarks = document.getElementById("inv-remarks").value.trim();
  if(!name || !village) return alert("Name & Village required");
  try {
    let dupQuery = invitationCol.where("name","==",name);
    if(mobile) dupQuery = dupQuery.where("mobile","==",mobile);
    const dup = await dupQuery.get();
    if(!dup.empty && !confirm("Possible duplicate found. Add anyway?")) return;
    await invitationCol.add({ name, village, mobile, remarks, sent:false, dateAdded: firebase.firestore.FieldValue.serverTimestamp()});
    ["inv-name","inv-village","inv-mobile","inv-remarks"].forEach(id=>document.getElementById(id).value="");
    loadInvitations();
  } catch(err){ console.error(err); alert("Failed to add invitation: " + (err.message || err));}
});

async function loadInvitations(){
  const tbody = document.querySelector("#invitation-table tbody"); if(!tbody) return; tbody.innerHTML = "";
  try{
    const snapshot = await invitationCol.orderBy("dateAdded","desc").get();
    let total=0,sent=0;
    snapshot.forEach(doc => {
      total++; const d = doc.data(); if(d.sent) sent++;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td ${currentRole==='admin'?'contenteditable="true" class="editable"':''}>${escapeHtml(d.name||"")}</td>
        <td ${currentRole==='admin'?'contenteditable="true" class="editable"':''}>${escapeHtml(d.village||"")}</td>
        <td ${currentRole==='admin'?'contenteditable="true" class="editable"':''}>${escapeHtml(d.mobile||"")}</td>
        <td ${currentRole==='admin'?'contenteditable="true" class="editable"':''}>${escapeHtml(d.remarks||"")}</td>
        <td class="center">${d.sent?'<span class="badge ok pulse">Sent</span>':'<span class="badge warn">Pending</span>'}</td>
        <td>${d.dateAdded && d.dateAdded.toDate ? d.dateAdded.toDate().toLocaleString() : ""}</td>
        <td></td>
      `;
      tbody.appendChild(tr);
      const actionsTd = tr.querySelector("td:last-child");
      if(currentRole === "admin"){
        const toggleBtn = document.createElement("button"); toggleBtn.textContent = d.sent ? "Mark Pending" : "Mark Sent"; toggleBtn.className="btn small";
        toggleBtn.onclick = () => { doc.ref.update({sent: !d.sent}).then(loadInvitations).catch(e=>alert(e.message)); };
        const delBtn = document.createElement("button"); delBtn.textContent = "Delete"; delBtn.className="btn small ghost"; delBtn.style.marginLeft="8px";
        delBtn.onclick = () => { if(confirm("Delete invitation?")) doc.ref.delete().then(loadInvitations); };
        actionsTd.appendChild(toggleBtn); actionsTd.appendChild(delBtn);

        const editableCells = tr.querySelectorAll("td[contenteditable='true']");
        editableCells.forEach((cell, idx) => {
          const fieldMap = ["name","village","mobile","remarks"];
          cell.onblur = async () => {
            try { const val = cell.textContent.trim(); const update = {}; update[fieldMap[idx]] = val; await doc.ref.update(update); } catch(e) { console.error(e); alert("Save failed: "+(e.message||e)); }
          };
        });
      }
    });
    document.getElementById("summary-invitees").textContent = `Invitees: ${total} | Sent: ${sent} | Pending: ${total - sent}`;
  } catch(e){ console.error("Load invitations error:", e); alert("Failed to load invitations: " + (e.message || e)); }
}
document.getElementById("search-invite").addEventListener("input",(e)=>{ filterTable("invitation-table", e.target.value); });

/* ---------------- MEMBERS ---------------- */
document.getElementById("add-mem-btn").addEventListener("click", async () => {
  if(currentRole !== "admin") return alert("Only admin can add members");
  const name = document.getElementById("mem-name").value.trim();
  const village = document.getElementById("mem-village").value.trim();
  const mobile = document.getElementById("mem-mobile").value.trim();
  const remarks = document.getElementById("mem-remarks").value.trim();
  if(!name || !mobile) return alert("Name & Mobile required");
  try {
    const dup = await membersCol.where("name","==",name).where("mobile","==",mobile).get();
    if(!dup.empty && !confirm("Possible duplicate member. Add anyway?")) return;
    await membersCol.add({ name, village, mobile, remarks, dateAdded: firebase.firestore.FieldValue.serverTimestamp()});
    ["mem-name","mem-village","mem-mobile","mem-remarks"].forEach(id=>document.getElementById(id).value="");
    loadMembers(); loadFeeMembersDropdown(); loadTimeline();
  } catch(e){ console.error(e); alert("Failed to add member: "+(e.message||e)); }
});

async function loadMembers(){
  const tbody=document.querySelector("#members-table tbody"); if(!tbody) return; tbody.innerHTML="";
  try{
    const snap = await membersCol.orderBy("name").get();
    let total = 0;
    snap.forEach(docSnap => {
      total++; const d = docSnap.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td ${currentRole==='admin'?'contenteditable="true" class="editable"':''}>${escapeHtml(d.name||"")}</td>
        <td ${currentRole==='admin'?'contenteditable="true" class="editable"':''}>${escapeHtml(d.village||"")}</td>
        <td ${currentRole==='admin'?'contenteditable="true" class="editable"':''}>${escapeHtml(d.mobile||"")}</td>
        <td ${currentRole==='admin'?'contenteditable="true" class="editable"':''}>${escapeHtml(d.remarks||"")}</td>
        <td></td>
      `;
      tbody.appendChild(tr);
      const actionsTd = tr.querySelector("td:last-child");
      if(currentRole==="admin"){
        const del=document.createElement("button"); del.textContent="Delete"; del.className="btn small ghost";
        del.onclick = () => { if(confirm("Delete member?")) docSnap.ref.delete().then(()=>{ loadMembers(); loadFeeMembersDropdown(); loadTimeline(); }); };
        actionsTd.appendChild(del);

        const editable = tr.querySelectorAll("td[contenteditable='true']");
        editable.forEach((cell, idx) => {
          const map = ["name","village","mobile","remarks"];
          cell.onblur = async () => {
            try { const val = cell.textContent.trim(); const upd = {}; upd[map[idx]] = val; await membersCol.doc(docSnap.id).update(upd); loadFeeMembersDropdown(); loadTimeline(); } catch(e){ console.error(e); alert("Save failed: "+(e.message||e)); }
          };
        });
      }
    });
    document.getElementById("summary-members").textContent = `Members: ${total}`;
  } catch(e){ console.error("Load members error:", e); alert("Failed to load members: " + (e.message || e)); }
}
document.getElementById("search-members").addEventListener("input",(e)=> filterTable("members-table", e.target.value));

/* ---------------- COLLECTORS ---------------- */
document.getElementById("add-col-btn").addEventListener("click", async () => {
  if(currentRole !== "admin") return alert("Only admin can add");
  const name = document.getElementById("col-name").value.trim();
  const area = document.getElementById("col-area").value.trim();
  const bill = document.getElementById("col-bill").value.trim();
  const mobile = document.getElementById("col-mobile").value.trim();
  const remarks = document.getElementById("col-remarks").value.trim();
  if(!name || !area) return alert("Name & area required");
  try {
    const dup = await collectorsCol.where("name","==",name).where("area","==",area).get();
    if(!dup.empty && !confirm("Possible duplicate. Add anyway?")) return;
    await collectorsCol.add({ name, area, bill, mobile, remarks, dateAdded: firebase.firestore.FieldValue.serverTimestamp()});
    ["col-name","col-area","col-bill","col-mobile","col-remarks"].forEach(id=>document.getElementById(id).value="");
    loadCollectors();
    loadDonationCollectorsDropdownSmall();
  } catch(e){ console.error(e); alert("Failed to add collector: "+(e.message||e)); }
});

async function loadCollectors(){
  const tbody=document.querySelector("#collector-table tbody"); if(!tbody) return; tbody.innerHTML="";
  try{
    const snap = await collectorsCol.orderBy("name").get();
    snap.forEach(docSnap => {
      const d = docSnap.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${escapeHtml(d.name||"")}</td><td>${escapeHtml(d.area||"")}</td><td>${escapeHtml(d.bill||"")}</td><td>${escapeHtml(d.mobile||"")}</td><td>${escapeHtml(d.remarks||"")}</td><td></td>`;
      tbody.appendChild(tr);
      if(currentRole === "admin"){
        const del = document.createElement("button"); del.textContent="Delete"; del.className="btn small ghost";
        del.onclick = ()=>{ if(confirm("Delete collector?")) docSnap.ref.delete().then(loadCollectors).then(loadDonationCollectorsDropdownSmall); };
        tr.querySelector("td:last-child").appendChild(del);
      }
    });
  } catch(e){ console.error("Load collectors error:", e); alert("Failed to load collectors: " + (e.message || e)); }
}
document.getElementById("search-collectors").addEventListener("input",(e)=> filterTable("collector-table", e.target.value));

/* ---------------- MEMBERSHIP FEES ---------------- */
/* Fee members dropdown */
const feeMemberSelect = document.getElementById('feeMemberSelect');
async function loadFeeMembersDropdown(){
  if(!feeMemberSelect) return;
  feeMemberSelect.innerHTML = '<option value="">-- Select member --</option>';
  try{
    const snap = await membersCol.orderBy("name").get();
    snap.forEach(docSnap => {
      const d = docSnap.data();
      const opt = document.createElement('option'); opt.value = docSnap.id; opt.textContent = `${d.name} ‚Äî ${d.mobile||''}`;
      feeMemberSelect.appendChild(opt);
    });
  } catch(e){ console.error("Load fee members failed:", e); }
}

/* load member fee months */
document.getElementById("loadMemberFeeBtn").addEventListener("click", loadFeeMonthsTable);
async function loadFeeMonthsTable(){
  const memberId = feeMemberSelect.value;
  const feeAmount = Number(document.getElementById("feeAmountInput").value) || 100;
  const tbody = document.querySelector("#fee-months-table tbody"); if(!tbody) return; tbody.innerHTML = "";
  if(!memberId){ document.getElementById("fee-member-summary").textContent = "Select a member"; return; }
  try{
    const feesCol = membershipFeesCollectionFor(selectedFeeYear);
    const docRef = feesCol.doc(memberId);
    const docSnap = await docRef.get();
    let record = docSnap.exists ? docSnap.data() : null;
    if(!record){
      const monthsInit = {}; MONTHS.forEach(m=> monthsInit[m] = { paid:false, paidAt:null });
      record = { memberId, months: monthsInit, feeAmount };
    }
    let paidCount = 0;
    MONTHS.forEach(m => {
      const info = record.months && record.months[m] ? record.months[m] : { paid:false, paidAt:null };
      if(info.paid) paidCount++;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${m}</td>
        <td class="center">${info.paid ? '<span class="badge ok pulse">Paid</span>' : '<span class="badge warn">Pending</span>'}</td>
        <td class="center">${info.paid && info.paidAt ? new Date(info.paidAt.seconds ? info.paidAt.seconds*1000 : info.paidAt).toLocaleString() : ''}</td>
        <td class="center"></td>
      `;
      tbody.appendChild(tr);
      const actionTd = tr.querySelector("td:last-child");
      const cb = document.createElement("input"); cb.type="checkbox"; cb.className="month-checkbox"; cb.checked = !!info.paid; cb.disabled = (currentRole !== "admin");
      cb.addEventListener("change", async ()=> {
        if(currentRole !== "admin"){ cb.checked = !cb.checked; return alert("Only admin can change payments"); }
        try{
          if(!docSnap.exists){
            const monthsInit = {}; MONTHS.forEach(mm=> monthsInit[mm] = { paid:false, paidAt:null });
            await docRef.set({ memberId, year: selectedFeeYear, months: monthsInit, feeAmount });
          }
          const updatePaid = {}; updatePaid[`months.${m}.paid`] = cb.checked;
          const updatePaidAt = {}; updatePaidAt[`months.${m}.paidAt`] = cb.checked ? firebase.firestore.FieldValue.serverTimestamp() : null;
          await docRef.update(updatePaid);
          await docRef.update(updatePaidAt);
          loadFeeMonthsTable(); loadFeeYearlySummary(); updateSummaryTotals(); loadTimeline();
        } catch(err){ console.error("Toggle paid error:", err); alert("Failed to update: "+(err.message||err)); cb.checked = !cb.checked; }
      });
      actionTd.appendChild(cb);
    });
    document.getElementById("fee-member-summary").textContent = `Paid months: ${paidCount}/12 ‚Äî Total: ‚Çπ${paidCount * feeAmount}`;
  } catch(e){ console.error("Load fee months error:", e); alert("Failed to load fees: "+(e.message||e)); }
}

/* Save fee config */
document.getElementById("saveFeeConfigBtn").addEventListener("click", async ()=>{
  const memberId = feeMemberSelect.value; const feeAmount = Number(document.getElementById("feeAmountInput").value) || 100;
  if(!memberId) return alert("Select a member");
  try{
    const feesCol = membershipFeesCollectionFor(selectedFeeYear);
    const docRef = feesCol.doc(memberId);
    const docSnap = await docRef.get();
    if(!docSnap.exists){
      const monthsInit = {}; MONTHS.forEach(m=> monthsInit[m] = { paid:false, paidAt:null });
      await docRef.set({ memberId, year: selectedFeeYear, months: monthsInit, feeAmount });
    } else {
      await docRef.update({ feeAmount });
    }
    alert("Fee configuration saved");
    loadFeeMonthsTable(); loadFeeYearlySummary(); updateSummaryTotals();
  } catch(e){ console.error("Save fee config error:", e); alert("Failed to save fee config: "+(e.message||e)); }
});

/* Clear member fee record */
document.getElementById("clearFeeRecordBtn").addEventListener("click", async ()=>{
  if(currentRole !== "admin") return alert("Only admin can clear fees");
  const memberId = feeMemberSelect.value; if(!memberId) return alert("Select a member");
  if(!confirm("Clear all fee records for this member and year?")) return;
  try{
    const docRef = membershipFeesCollectionFor(selectedFeeYear).doc(memberId);
    const snap = await docRef.get();
    if(snap.exists) await docRef.delete();
    alert("Cleared");
    loadFeeMonthsTable(); loadFeeYearlySummary(); updateSummaryTotals();
  } catch(e){ console.error(e); alert("Failed to clear: "+(e.message||e)); }
});

/* Yearly aggregated summary for fees (selected year) */
async function loadFeeYearlySummary(){
  const tbody = document.querySelector("#fees-yearly-summary tbody"); if(!tbody) return; tbody.innerHTML="";
  try{
    const feesCol = membershipFeesCollectionFor(selectedFeeYear);
    const snap = await feesCol.get();
    const monthCounts = {}; MONTHS.forEach(m=> monthCounts[m] = { paid:0, total:0 });
    snap.forEach(docSnap=>{
      const d = docSnap.data(); const feeAmt = d.feeAmount || Number(document.getElementById("feeAmountInput").value) || 100;
      const monthsObj = d.months || {};
      MONTHS.forEach(m=>{
        if(monthsObj[m] && monthsObj[m].paid){ monthCounts[m].paid++; monthCounts[m].total += feeAmt; }
      });
    });
    MONTHS.forEach(m=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `<td>${m}</td><td class="center">${monthCounts[m].paid}</td><td class="center">‚Çπ${monthCounts[m].total}</td>`;
      tbody.appendChild(tr);
    });
  } catch(e){ console.error("Fee yearly summary error:", e); }
}

/* ---------------- EXPORT Membership CSV ---------------- */
document.getElementById("exportCsvBtn").addEventListener("click", async ()=>{
  try{
    const year = selectedFeeYear;
    const feesCol = membershipFeesCollectionFor(year);
    const membersSnap = await membersCol.orderBy("name").get();
    const feeSnap = await feesCol.get();
    const feeMap = {}; feeSnap.forEach(fs => feeMap[fs.id] = fs.data());
    const rows = []; rows.push(["Name","Village","Mobile","Remarks","Paid (Yes/No)","Latest Paid Date"]);
    membersSnap.forEach(mDoc=>{
      const m = mDoc.data();
      const memberId = mDoc.id;
      const feeRec = feeMap[memberId] || { months: {} };
      const monthsObj = feeRec.months || {};
      const paidAny = Object.values(monthsObj).some(x => x && x.paid);
      let latestPaidAt = null;
      Object.values(monthsObj).forEach(x => {
        if(x && x.paidAt){
          const t = x.paidAt.seconds ? x.paidAt.seconds*1000 : x.paidAt;
          if(!latestPaidAt || t > latestPaidAt) latestPaidAt = t;
        }
      });
      const paidDateStr = latestPaidAt ? new Date(latestPaidAt).toLocaleString() : "";
      rows.push([m.name || "", m.village || "", m.mobile || "", m.remarks || "", paidAny ? "Yes" : "No", paidDateStr]);
    });
    const csvContent = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(",")).join("\n");
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const filename = `MembershipFees_${year}.csv`;
    if (navigator.msSaveBlob) { navigator.msSaveBlob(blob, filename); }
    else {
      const link = document.createElement("a"); const url = URL.createObjectURL(blob);
      link.setAttribute("href", url); link.setAttribute("download", filename); link.style.visibility = 'hidden';
      document.body.appendChild(link); link.click(); document.body.removeChild(link);
      setTimeout(()=> URL.revokeObjectURL(url), 1000);
    }
  } catch(e){ console.error("Export CSV error:", e); alert("Failed to export CSV: " + (e.message || e)); }
});

/* ---------------- Update Summary Totals (membership only) ---------------- */
async function updateSummaryTotals(){
  try{
    // membership totals
    let membershipTotal = 0;
    let memberCount = 0;
    try {
      const feesCol = membershipFeesCollectionFor(selectedFeeYear);
      const feesSnap = await feesCol.get();
      feesSnap.forEach(doc => {
        const d = doc.data() || {};
        const feeAmt = Number(d.feeAmount || document.getElementById("feeAmountInput")?.value || 100);
        const monthsObj = d.months || {};
        const paid = Object.values(monthsObj).filter(v => v && v.paid).length;
        membershipTotal += paid * feeAmt;
      });
      memberCount = (await membersCol.get()).size || 0;
    } catch(e){ console.warn('membership totals calc error', e); }
    document.getElementById('summary-collection').textContent = `‚Çπ${membershipTotal} (${memberCount} members)`;
  } catch(e){ console.error('Update totals error', e); }
}

/* ---------------- VILLAGE COLLECTION (per-year) ---------------- */
/* donation collectors dropdown for filter & input */
const donationCollectorSelectSmall = document.getElementById('donationCollectorSelectSmall');
const donationCollectorInput = document.getElementById('donationCollectorInput');

async function loadDonationCollectorsDropdownSmall(){
  donationCollectorSelectSmall.innerHTML = '<option value="">-- All collectors --</option>';
  donationCollectorInput.innerHTML = '<option value="">-- Select collector --</option>';
  try{
    const snap = await collectorsCol.orderBy('name').get();
    snap.forEach(doc => {
      const d = doc.data();
      const label = `${d.name}${d.mobile ? ' ‚Äî ' + d.mobile : ''}`;
      const optFilter = document.createElement('option'); optFilter.value = doc.id; optFilter.textContent = label;
      donationCollectorSelectSmall.appendChild(optFilter);
      const optInput = document.createElement('option'); optInput.value = doc.id; optInput.textContent = label;
      donationCollectorInput.appendChild(optInput);
    });
  } catch(e){ console.error("Load donation collectors failed:", e); }
}

/* Prefill bill helper (suggest B### by last saved in village_collections_year) */
async function generateDonationBillPrefill(){
  const billInput = document.getElementById('donationBillInput');
  try{
    const col = villageCollectionsFor(selectedDonationYear);
    const snap = await col.orderBy('dateAdded','desc').limit(1).get();
    let next = 'B001';
    if(!snap.empty){
      const last = snap.docs[0].data().billNo || '';
      const m = last.match(/B0*([0-9]+)/i);
      if(m && m[1]) {
        const num = parseInt(m[1],10) + 1;
        next = 'B' + String(num).padStart(3,'0');
      }
    }
    billInput.value = next;
  } catch(e){ console.warn('Generate bill error:', e); billInput.value = ''; }
}
generateDonationBillPrefill();

/* Add donation */
document.getElementById('add-donation-btn').addEventListener('click', async ()=>{
  if(currentRole !== 'admin') return alert('Only admin can add donations');
  const bill = document.getElementById('donationBillInput').value.trim();
  const collectorId = donationCollectorInput.value;
  const collectorLabel = donationCollectorInput.selectedIndex >= 0 ? donationCollectorInput.options[donationCollectorInput.selectedIndex].text : '';
  const mobile = document.getElementById('donationMobileInput').value.trim();
  const village = document.getElementById('donationVillageInput').value || 'Madhabpur';
  const amount = Number(document.getElementById('donationAmountInput').value) || 0;
  const remarks = document.getElementById('donationRemarksInput').value.trim();

  if(!bill) return alert('Bill No required');
  if(!collectorId) return alert('Select collector');
  if(!village) return alert('Select village');
  if(amount <= 0) return alert('Enter valid amount');

  try {
    const col = villageCollectionsFor(selectedDonationYear);
    const dup = await col.where('billNo','==',bill).get();
    if(!dup.empty && !confirm('Bill number exists for this year. Add anyway?')) return;

    await col.add({
      billNo: bill,
      collectorId,
      collectorName: collectorLabel,
      collectorMobile: mobile,
      village,
      amount,
      remarks,
      dateAdded: firebase.firestore.FieldValue.serverTimestamp()
    });

    // clear inputs except bill (regenerate)
    document.getElementById('donationAmountInput').value = 0;
    document.getElementById('donationRemarksInput').value = '';
    document.getElementById('donationMobileInput').value = '';
    generateDonationBillPrefill();
    loadDonationsTable();
    updateDonationTotal();
    showToast('Donation added');
  } catch(e){ console.error('Add donation failed:', e); alert('Failed to add donation: ' + (e.message || e)); }
});

/* Load donations table */
async function loadDonationsTable(){
  const tbody = document.querySelector("#donation-table tbody"); if(!tbody) return; tbody.innerHTML = "";
  try{
    const col = villageCollectionsFor(selectedDonationYear);
    const snap = await col.orderBy("dateAdded","desc").get();
    let total = 0;
    const q = (document.getElementById('donationSearch').value || '').toLowerCase();
    const villageFilter = (document.getElementById('donationVillageFilter').value || '').toLowerCase();
    const collectorFilter = (document.getElementById('donationCollectorSelectSmall').value || '');
    snap.forEach(docSnap => {
      const d = docSnap.data();
      if(villageFilter && d.village.toLowerCase() !== villageFilter) return;
      if(collectorFilter && d.collectorId !== collectorFilter) return;
      if(q && !( (d.billNo||'').toLowerCase().includes(q) || (d.collectorName||'').toLowerCase().includes(q) )) return;
      total += Number(d.amount || 0);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(d.billNo||'')}</td>
        <td>${escapeHtml(d.collectorName||'')}</td>
        <td>${escapeHtml(d.collectorMobile||'')}</td>
        <td>${escapeHtml(d.village||'')}</td>
        <td class="center">‚Çπ${Number(d.amount||0)}</td>
        <td>${escapeHtml(d.remarks||'')}</td>
        <td>${d.dateAdded && d.dateAdded.toDate ? d.dateAdded.toDate().toLocaleString() : ''}</td>
        <td></td>
      `;
      tbody.appendChild(tr);
      if(currentRole === 'admin'){
        const actionsTd = tr.querySelector("td:last-child");
        const delBtn = document.createElement("button"); delBtn.textContent="Delete"; delBtn.className="btn small ghost";
        delBtn.onclick = async ()=> { if(!confirm("Delete donation?")) return; await col.doc(docSnap.id).delete(); loadDonationsTable(); updateDonationTotal(); };
        const editBtn = document.createElement("button"); editBtn.textContent="Edit"; editBtn.className="btn small"; editBtn.style.marginLeft = "8px";
        editBtn.onclick = async ()=> {
          const newAmount = Number(prompt("New amount", d.amount || 0));
          if(isNaN(newAmount)) return alert("Invalid amount");
          const newRemark = prompt("Remark", d.remarks || '') || '';
          const newBill = prompt("Bill No", d.billNo || '') || '';
          await col.doc(docSnap.id).update({ amount: newAmount, remarks: newRemark, billNo: newBill });
          loadDonationsTable(); updateDonationTotal();
        };
        actionsTd.appendChild(delBtn); actionsTd.appendChild(editBtn);
      }
    });
    document.getElementById("donation-year-total").textContent = `‚Çπ${total}`;
  } catch(e){ console.error("Load donations failed:", e); alert("Failed to load donations: " + (e.message || e)); }
}
document.getElementById("donationSearch").addEventListener("input", ()=> loadDonationsTable());
document.getElementById("donationVillageFilter").addEventListener("change", ()=> loadDonationsTable());
document.getElementById("donationCollectorSelectSmall").addEventListener("change", ()=> loadDonationsTable());

/* Export Donations CSV */
document.getElementById("exportDonationsCsvBtn").addEventListener("click", async ()=>{
  try{
    const year = selectedDonationYear;
    const col = villageCollectionsFor(year);
    const snap = await col.orderBy("dateAdded","desc").get();
    const rows = []; rows.push(['Bill No','Collector','Collector Mobile','Village','Amount','Remarks','Date']);
    snap.forEach(doc => {
      const d = doc.data() || {};
      const dateStr = d.dateAdded && d.dateAdded.toDate ? d.dateAdded.toDate().toLocaleString() : '';
      rows.push([d.billNo||'', d.collectorName||'', d.collectorMobile||'', d.village||'', d.amount||0, d.remarks||'', dateStr]);
    });
    const csvContent = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(",")).join("\n");
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const filename = `VillageCollections_${year}.csv`;
    if (navigator.msSaveBlob) { navigator.msSaveBlob(blob, filename); }
    else {
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      link.setAttribute("href", url); link.setAttribute("download", filename);
      link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link);
      setTimeout(()=> URL.revokeObjectURL(url), 1000);
    }
    showToast("Donations exported");
  } catch(e){ console.error("Export donations CSV error:", e); alert("Export failed: " + (e.message || e)); }
});

/* Update donation total separate (non membership) */
async function updateDonationTotal(){
  try{
    const snap = await villageCollectionsFor(selectedDonationYear).get();
    let total = 0; snap.forEach(d => total += Number((d.data()||{}).amount || 0));
    document.getElementById("donation-year-total").textContent = `‚Çπ${total}`;
  } catch(e){ console.error(e); }
}

/* ---------------- Paid-Month Timeline (visualization) ---------------- */
async function loadTimeline(){
  const container = document.getElementById('timeline-container'); if(!container) return; container.innerHTML = '';
  try{
    const membersSnap = await membersCol.orderBy('name').get();
    const feesCol = membershipFeesCollectionFor(selectedFeeYear);
    const feeSnap = await feesCol.get();
    const feeMap = {}; feeSnap.forEach(f => feeMap[f.id] = f.data());
    membersSnap.forEach(doc => {
      const d = doc.data();
      const div = document.createElement('div'); div.style.display='flex'; div.style.alignItems='center'; div.style.gap='12px'; div.style.padding='6px 0';
      const name = document.createElement('div'); name.style.minWidth='200px'; name.textContent = d.name;
      const timeline = document.createElement('div'); timeline.className='timeline'; 
      const rec = feeMap[doc.id] || { months: {} };
      MONTHS.forEach(m => {
        const paid = rec.months && rec.months[m] && rec.months[m].paid;
        const dot = document.createElement('span'); dot.className='dot ' + (paid ? 'paid' : 'pending');
        dot.textContent = paid ? 'üí∞' : '¬∑';
        timeline.appendChild(dot);
      });
      div.appendChild(name); div.appendChild(timeline);
      container.appendChild(div);
    });
  } catch(e){ console.error('timeline load err', e); }
}

/* ---------------- Utility: filterTable ---------------- */
function filterTable(tableId,term){
  const rows = document.getElementById(tableId).querySelectorAll("tbody tr");
  const q = (term||"").toLowerCase();
  rows.forEach(r=> r.style.display = r.innerText.toLowerCase().includes(q) ? "" : "none");
}

/* ---------------- small initial loads ---------------- */
setTimeout(()=> {
  loadMembers(); loadInvitations(); loadCollectors(); loadFeeMembersDropdown(); loadFeeYearlySummary(); loadDonationCollectorsDropdownSmall(); generateDonationBillPrefill(); loadDonationsTable(); loadTimeline(); updateSummaryTotals(); updateDonationTotal();
}, 400);

/* ---------------- Debug helpers exposed ---------------- */
window.loadAllData = loadAllData;
window.loadDonationsTable = loadDonationsTable;
window.loadTimeline = loadTimeline;

</script>
</body>
</html>
